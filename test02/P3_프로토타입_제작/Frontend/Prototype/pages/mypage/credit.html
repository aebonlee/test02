<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í¬ë ˆë”§ ê´€ë¦¬ - SSAL Works</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            --primary: #2C4A8A;
            --primary-dark: #1F3563;
            --secondary: #F59E0B;
            --secondary-dark: #D97706;
            --accent: #10B981;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 32px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .rice-logo {
            display: flex;
            align-items: center;
            gap: 3px;
            transform: rotate(-15deg);
        }

        .rice-grain {
            width: 10px;
            height: 18px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border-radius: 40%;
        }

        .rice-grain:nth-child(1) { transform: rotate(-5deg); }
        .rice-grain:nth-child(2) { transform: rotate(5deg); margin-top: 2px; }
        .rice-grain:nth-child(3) { transform: rotate(-3deg); margin-top: -1px; }

        .nav-logo-text { font-size: 28px; font-weight: 800; color: white; }

        .nav-links { display: flex; gap: 24px; align-items: center; }

        .close-btn {
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--gray-500);
        }

        .breadcrumb a { color: var(--primary); text-decoration: none; }

        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 32px; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 500px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }

        .stat-icon { font-size: 32px; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-label { font-size: 13px; color: var(--gray-500); margin-top: 4px; }
        .stat-value.credit { color: var(--secondary); }
        .stat-value.success { color: var(--success); }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .card-title { font-size: 18px; font-weight: 600; }

        /* Charge Options */
        .charge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-charge {
            background: var(--gray-100);
            color: var(--gray-700);
            font-size: 14px;
        }

        .btn-charge:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-charge.selected {
            background: var(--secondary);
            color: white;
            box-shadow: 0 0 0 2px var(--secondary-dark);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            font-size: 16px;
        }

        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* AI Service Prices */
        .price-list { display: flex; flex-direction: column; gap: 12px; }

        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .price-service {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .service-icon.chatgpt { background: #74AA9C; }
        .service-icon.gemini { background: #4285F4; }
        .service-icon.perplexity { background: #1FB8CD; }

        .service-name { font-weight: 600; }
        .service-desc { font-size: 12px; color: var(--gray-500); }
        .price-value { font-weight: 700; color: var(--secondary); }

        /* Transaction History */
        .history-list { max-height: 400px; overflow-y: auto; }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .history-item:last-child { border-bottom: none; }

        .history-info { flex: 1; }
        .history-desc { font-weight: 500; margin-bottom: 4px; }
        .history-date { font-size: 12px; color: var(--gray-500); }
        .history-service {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .history-amount { font-weight: 700; text-align: right; }
        .history-amount.charge { color: var(--success); }
        .history-amount.spend { color: var(--danger); }
        .history-amount.bonus { color: var(--secondary); }
        .history-amount.refund { color: var(--primary); }

        .history-balance { font-size: 12px; color: var(--gray-500); }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }

        /* AI Q&A Section */
        .ai-qa-section {
            grid-column: span 2;
        }

        @media (max-width: 900px) {
            .ai-qa-section { grid-column: span 1; }
        }

        .ai-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .ai-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--gray-100);
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
        }

        .ai-tab:hover { background: var(--gray-200); }
        .ai-tab.active {
            background: var(--primary);
            color: white;
        }

        .ai-chat-area {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .chat-message.user { flex-direction: row-reverse; }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-avatar.ai { background: var(--primary); color: white; }
        .chat-avatar.user { background: var(--secondary); color: white; }

        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.ai .chat-bubble {
            background: white;
            border: 1px solid var(--gray-200);
        }

        .chat-message.user .chat-bubble {
            background: var(--primary);
            color: white;
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-send {
            padding: 14px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
        }

        .btn-send:hover { background: var(--primary-dark); }
        .btn-send:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .credit-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #FEF3C7;
            border-radius: 8px;
            font-size: 13px;
            color: var(--secondary-dark);
            margin-top: 12px;
        }

        /* Loading & Toast */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }
        .toast.info { background: var(--primary); }

        /* Notice Box */
        .notice-box {
            margin-top: 16px;
            padding: 14px;
            background: #EFF6FF;
            border-radius: 8px;
            font-size: 13px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--gray-400);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="../../index.html" class="nav-logo">
            <div class="rice-logo">
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
            </div>
            <span class="nav-logo-text">SSAL Works</span>
        </a>
        <div class="nav-links">
            <button class="close-btn" onclick="window.history.length > 1 ? history.back() : window.location.href='../../index.html'" title="ë‹«ê¸°">âœ• ë‹«ê¸°</button>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="../../index.html">í™ˆ</a>
            <span>â€º</span>
            <span>My Page</span>
            <span>â€º</span>
            <span>AI í¬ë ˆë”§ ê´€ë¦¬</span>
        </div>

        <h1 class="page-title">AI í¬ë ˆë”§ ê´€ë¦¬</h1>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-value credit" id="creditBalance">â‚©0</div>
                <div class="stat-label">í˜„ì¬ í¬ë ˆë”§</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-value" id="creditUsedMonth">â‚©0</div>
                <div class="stat-label">ì´ë²ˆ ë‹¬ ì‚¬ìš©</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-value success" id="creditCharged">â‚©0</div>
                <div class="stat-label">ì´ ì¶©ì „ì•¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ¤–</div>
                <div class="stat-value" id="aiUsageCount">0íšŒ</div>
                <div class="stat-label">AI ì‚¬ìš© íšŸìˆ˜</div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Charge Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">í¬ë ˆë”§ ì¶©ì „</h3>
                </div>
                <div class="charge-grid" id="chargeGrid">
                    <button class="btn btn-charge" data-amount="10000">â‚©10,000</button>
                    <button class="btn btn-charge" data-amount="30000">â‚©30,000</button>
                    <button class="btn btn-charge" data-amount="50000">â‚©50,000</button>
                    <button class="btn btn-charge" data-amount="100000">â‚©100,000</button>
                    <button class="btn btn-charge" data-amount="200000">â‚©200,000</button>
                    <button class="btn btn-charge" data-amount="500000">â‚©500,000</button>
                </div>
                <button class="btn btn-primary" id="chargeBtn" disabled onclick="processCharge()">
                    ì¶©ì „í•˜ê¸°
                </button>
                <div class="notice-box">
                    í”„ë¡œí† íƒ€ì… ë‹¨ê³„ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ ì¶©ì „ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹¤ì œ ê²°ì œëŠ” ë³¸ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µë©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- AI Service Prices -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">AI ì„œë¹„ìŠ¤ ê°€ê²©í‘œ</h3>
                </div>
                <div class="price-list" id="priceList">
                    <div class="price-item">
                        <div class="price-service">
                            <div class="service-icon chatgpt">ğŸ¤–</div>
                            <div>
                                <div class="service-name">ChatGPT</div>
                                <div class="service-desc">GPT-4 ê¸°ë°˜ ì½”ë“œ ì‘ì„±, ê¸°ìˆ  ë¬¸ì„œ</div>
                            </div>
                        </div>
                        <div class="price-value">â‚©100/íšŒ</div>
                    </div>
                    <div class="price-item">
                        <div class="price-service">
                            <div class="service-icon gemini">âœ¨</div>
                            <div>
                                <div class="service-name">Gemini</div>
                                <div class="service-desc">ì½”ë“œ ë¦¬ë·°, ì•„í‚¤í…ì²˜ ì„¤ê³„</div>
                            </div>
                        </div>
                        <div class="price-value">â‚©80/íšŒ</div>
                    </div>
                    <div class="price-item">
                        <div class="price-service">
                            <div class="service-icon perplexity">ğŸ”</div>
                            <div>
                                <div class="service-name">Perplexity</div>
                                <div class="service-desc">ì‹¤ì‹œê°„ ê²€ìƒ‰, ìµœì‹  ì •ë³´ ì¡°íšŒ</div>
                            </div>
                        </div>
                        <div class="price-value">â‚©50/íšŒ</div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">í¬ë ˆë”§ ê±°ë˜ ë‚´ì—­</h3>
                </div>
                <div class="history-list" id="historyList">
                    <div class="history-empty">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- AI Usage Log -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">AI ì‚¬ìš© ê¸°ë¡</h3>
                </div>
                <div class="history-list" id="usageList">
                    <div class="history-empty">ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- AI Q&A Section -->
            <div class="card ai-qa-section">
                <div class="card-header">
                    <h3 class="card-title">AI ì§ˆë¬¸í•˜ê¸°</h3>
                </div>
                <div class="ai-tabs">
                    <button class="ai-tab active" data-service="ChatGPT" onclick="selectAIService('ChatGPT')">ğŸ¤– ChatGPT</button>
                    <button class="ai-tab" data-service="Gemini" onclick="selectAIService('Gemini')">âœ¨ Gemini</button>
                    <button class="ai-tab" data-service="Perplexity" onclick="selectAIService('Perplexity')">ğŸ” Perplexity</button>
                </div>
                <div class="ai-chat-area" id="chatArea">
                    <div class="chat-message ai">
                        <div class="chat-avatar ai">ğŸ¤–</div>
                        <div class="chat-bubble">
                            ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ì½”ë“œ ì‘ì„±, ê¸°ìˆ  ë¬¸ì„œ, ë””ë²„ê¹… ë“± ë‹¤ì–‘í•œ ì§ˆë¬¸ì— ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea class="chat-input" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="2"></textarea>
                    <button class="btn-send" id="sendBtn" onclick="sendQuestion()">ì „ì†¡</button>
                </div>
                <div class="credit-warning" id="creditWarning" style="display: none;">
                    í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ì „ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const SUPABASE_URL = 'https://zwjmfewyshhwpgwdtrus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3am1mZXd5c2hod3Bnd2R0cnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3NjM3NzIsImV4cCI6MjA0ODMzOTc3Mn0.kICaQ8jF_OKGVXhdGOGvDQFekOlvluXMMOkaCmBLqRY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userData = null;
        let selectedAmount = 0;
        let selectedService = 'ChatGPT';
        let aiPricing = {};

        // Service prices (default)
        const defaultPrices = {
            'ChatGPT': 100,
            'Gemini': 80,
            'Perplexity': 50
        };

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupChargeButtons();
            setupChatInput();
        });

        function setupChargeButtons() {
            const buttons = document.querySelectorAll('#chargeGrid .btn-charge');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedAmount = parseInt(btn.dataset.amount);
                    document.getElementById('chargeBtn').disabled = false;
                    document.getElementById('chargeBtn').textContent = `â‚©${selectedAmount.toLocaleString()} ì¶©ì „í•˜ê¸°`;
                });
            });
        }

        function setupChatInput() {
            const input = document.getElementById('chatInput');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendQuestion();
                }
            });
        }

        async function checkAuth() {
            showLoading();
            try {
                // ìƒ˜í”Œ ë°ì´í„° ëª¨ë“œ (í”„ë¡œí† íƒ€ì…)
                await loadSampleData();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showSampleDataFallback();
            } finally {
                hideLoading();
            }
        }

        async function loadSampleData() {
            // Load AI pricing
            try {
                const { data: pricing } = await supabaseClient
                    .from('ai_service_pricing')
                    .select('*')
                    .eq('is_active', true);

                if (pricing && pricing.length > 0) {
                    pricing.forEach(p => {
                        aiPricing[p.service_name] = p.price_per_use;
                    });
                    renderPriceList(pricing);
                }
            } catch (e) {
                console.log('ê°€ê²© ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ - ê¸°ë³¸ê°’ ì‚¬ìš©');
                aiPricing = defaultPrices;
            }

            // Load TEST0001 data as sample
            try {
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('user_id', 'TEST0001')
                    .single();

                if (user) {
                    userData = user;
                    renderStats();
                }
            } catch (e) {
                console.log('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }

            // Load transaction history
            await loadTransactionHistory();

            // Load AI usage log
            await loadUsageLog();
        }

        function showSampleDataFallback() {
            document.getElementById('creditBalance').textContent = 'â‚©64,540';
            document.getElementById('creditUsedMonth').textContent = 'â‚©460';
            document.getElementById('creditCharged').textContent = 'â‚©60,000';
            document.getElementById('aiUsageCount').textContent = '6íšŒ';
        }

        function renderStats() {
            if (!userData) return;

            const balance = userData.credit_balance || 0;
            document.getElementById('creditBalance').textContent = `â‚©${balance.toLocaleString()}`;
        }

        function renderPriceList(pricing) {
            const container = document.getElementById('priceList');
            const iconMap = {
                'ChatGPT': { icon: 'ğŸ¤–', class: 'chatgpt' },
                'Gemini': { icon: 'âœ¨', class: 'gemini' },
                'Perplexity': { icon: 'ğŸ”', class: 'perplexity' }
            };

            container.innerHTML = pricing.map(p => `
                <div class="price-item">
                    <div class="price-service">
                        <div class="service-icon ${iconMap[p.service_name]?.class || ''}">${iconMap[p.service_name]?.icon || 'ğŸ¤–'}</div>
                        <div>
                            <div class="service-name">${DOMPurify.sanitize(p.service_name)}</div>
                            <div class="service-desc">${DOMPurify.sanitize(p.description || '')}</div>
                        </div>
                    </div>
                    <div class="price-value">â‚©${p.price_per_use.toLocaleString()}/íšŒ</div>
                </div>
            `).join('');
        }

        async function loadTransactionHistory() {
            try {
                const { data: transactions } = await supabaseClient
                    .from('credit_transactions')
                    .select('*')
                    .eq('user_id', 'TEST0001')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (transactions && transactions.length > 0) {
                    renderTransactionHistory(transactions);
                    calculateStats(transactions);
                }
            } catch (e) {
                console.log('ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        function renderTransactionHistory(transactions) {
            const container = document.getElementById('historyList');
            const typeLabels = {
                'charge': 'ì¶©ì „',
                'spend': 'ì‚¬ìš©',
                'refund': 'í™˜ë¶ˆ',
                'bonus': 'ë³´ë„ˆìŠ¤',
                'expire': 'ë§Œë£Œ'
            };

            container.innerHTML = transactions.map(t => `
                <div class="history-item">
                    <div class="history-info">
                        <div class="history-desc">${DOMPurify.sanitize(t.description)}</div>
                        <div class="history-date">${formatDate(t.created_at)}</div>
                        ${t.related_service ? `<span class="history-service">${DOMPurify.sanitize(t.related_service)}</span>` : ''}
                    </div>
                    <div>
                        <div class="history-amount ${t.type}">${t.amount > 0 ? '+' : ''}â‚©${t.amount.toLocaleString()}</div>
                        <div class="history-balance">ì”ì•¡: â‚©${t.balance_after.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        function calculateStats(transactions) {
            // Calculate monthly usage
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const monthlySpend = transactions
                .filter(t => t.type === 'spend' && new Date(t.created_at) >= monthStart)
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);

            const totalCharged = transactions
                .filter(t => t.type === 'charge')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('creditUsedMonth').textContent = `â‚©${monthlySpend.toLocaleString()}`;
            document.getElementById('creditCharged').textContent = `â‚©${totalCharged.toLocaleString()}`;
        }

        async function loadUsageLog() {
            try {
                const { data: usage } = await supabaseClient
                    .from('ai_usage_log')
                    .select('*')
                    .eq('user_id', 'TEST0001')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (usage && usage.length > 0) {
                    renderUsageLog(usage);
                    document.getElementById('aiUsageCount').textContent = `${usage.length}íšŒ`;
                }
            } catch (e) {
                console.log('ì‚¬ìš© ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        function renderUsageLog(usage) {
            const container = document.getElementById('usageList');

            container.innerHTML = usage.map(u => `
                <div class="history-item">
                    <div class="history-info">
                        <div class="history-desc">${DOMPurify.sanitize(u.prompt.substring(0, 40))}...</div>
                        <div class="history-date">${formatDate(u.created_at)} Â· ${u.response_time_ms}ms</div>
                        <span class="history-service">${DOMPurify.sanitize(u.service_name)}</span>
                    </div>
                    <div>
                        <div class="history-amount spend">-â‚©${u.cost.toLocaleString()}</div>
                        <div class="history-balance">${u.tokens_used?.toLocaleString() || '-'} í† í°</div>
                    </div>
                </div>
            `).join('');
        }

        async function processCharge() {
            if (selectedAmount <= 0) return;

            showLoading();
            try {
                // Get current balance
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('credit_balance')
                    .eq('user_id', 'TEST0001')
                    .single();

                const currentBalance = user?.credit_balance || 0;
                const newBalance = currentBalance + selectedAmount;

                // Insert transaction
                const { error: transError } = await supabaseClient
                    .from('credit_transactions')
                    .insert({
                        user_id: 'TEST0001',
                        type: 'charge',
                        amount: selectedAmount,
                        balance_after: newBalance,
                        description: 'í…ŒìŠ¤íŠ¸ ì¶©ì „ - í”„ë¡œí† íƒ€ì…'
                    });

                if (transError) throw transError;

                // Update user balance
                const { error: userError } = await supabaseClient
                    .from('users')
                    .update({ credit_balance: newBalance })
                    .eq('user_id', 'TEST0001');

                if (userError) throw userError;

                showToast(`â‚©${selectedAmount.toLocaleString()} ì¶©ì „ ì™„ë£Œ!`, 'success');

                // Refresh data
                await loadSampleData();

                // Reset selection
                selectedAmount = 0;
                document.querySelectorAll('#chargeGrid .btn-charge').forEach(b => b.classList.remove('selected'));
                document.getElementById('chargeBtn').disabled = true;
                document.getElementById('chargeBtn').textContent = 'ì¶©ì „í•˜ê¸°';

            } catch (error) {
                console.error('ì¶©ì „ ì‹¤íŒ¨:', error);
                showToast('ì¶©ì „ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        function selectAIService(service) {
            selectedService = service;
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.service === service);
            });

            // Update chat intro message
            const messages = {
                'ChatGPT': 'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ì½”ë“œ ì‘ì„±, ê¸°ìˆ  ë¬¸ì„œ, ë””ë²„ê¹… ë“± ë‹¤ì–‘í•œ ì§ˆë¬¸ì— ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.',
                'Gemini': 'ì•ˆë…•í•˜ì„¸ìš”! Geminiì…ë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·°, ì•„í‚¤í…ì²˜ ì„¤ê³„, ë³µì¡í•œ ë¬¸ì œ ë¶„ì„ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.',
                'Perplexity': 'ì•ˆë…•í•˜ì„¸ìš”! ìµœì‹  ì •ë³´ì™€ ì‹¤ì‹œê°„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.'
            };

            const icons = { 'ChatGPT': 'ğŸ¤–', 'Gemini': 'âœ¨', 'Perplexity': 'ğŸ”' };

            document.getElementById('chatArea').innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-avatar ai">${icons[service]}</div>
                    <div class="chat-bubble">${messages[service]}</div>
                </div>
            `;
        }

        async function sendQuestion() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();

            if (!question) return;

            const price = aiPricing[selectedService] || defaultPrices[selectedService];

            // Check credit
            const currentBalance = userData?.credit_balance || 0;
            if (currentBalance < price) {
                document.getElementById('creditWarning').style.display = 'flex';
                showToast('í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            document.getElementById('creditWarning').style.display = 'none';

            const icons = { 'ChatGPT': 'ğŸ¤–', 'Gemini': 'âœ¨', 'Perplexity': 'ğŸ”' };
            const chatArea = document.getElementById('chatArea');

            // Add user message
            chatArea.innerHTML += `
                <div class="chat-message user">
                    <div class="chat-avatar user">ğŸ‘¤</div>
                    <div class="chat-bubble">${DOMPurify.sanitize(question)}</div>
                </div>
            `;

            // Clear input
            input.value = '';

            // Show typing indicator
            chatArea.innerHTML += `
                <div class="chat-message ai" id="typingIndicator">
                    <div class="chat-avatar ai">${icons[selectedService]}</div>
                    <div class="chat-bubble">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            chatArea.scrollTop = chatArea.scrollHeight;

            // Disable send button
            document.getElementById('sendBtn').disabled = true;

            try {
                // Simulate AI response (í”„ë¡œí† íƒ€ì…)
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

                const responses = {
                    'ChatGPT': generateChatGPTResponse(question),
                    'Gemini': generateGeminiResponse(question),
                    'Perplexity': generatePerplexityResponse(question)
                };

                const response = responses[selectedService];
                const tokensUsed = Math.floor(100 + Math.random() * 400);
                const responseTime = Math.floor(1500 + Math.random() * 2000);

                // Deduct credit
                const newBalance = currentBalance - price;

                // Insert transaction
                await supabaseClient.from('credit_transactions').insert({
                    user_id: 'TEST0001',
                    type: 'spend',
                    amount: -price,
                    balance_after: newBalance,
                    description: `${selectedService} ì‚¬ìš©`,
                    related_service: selectedService
                });

                // Insert usage log
                await supabaseClient.from('ai_usage_log').insert({
                    user_id: 'TEST0001',
                    service_name: selectedService,
                    prompt: question,
                    response: response,
                    tokens_used: tokensUsed,
                    cost: price,
                    response_time_ms: responseTime
                });

                // Update user balance
                await supabaseClient.from('users')
                    .update({ credit_balance: newBalance })
                    .eq('user_id', 'TEST0001');

                // Remove typing indicator and add response
                document.getElementById('typingIndicator').remove();

                chatArea.innerHTML += `
                    <div class="chat-message ai">
                        <div class="chat-avatar ai">${icons[selectedService]}</div>
                        <div class="chat-bubble">${DOMPurify.sanitize(response)}</div>
                    </div>
                `;

                // Update stats
                userData.credit_balance = newBalance;
                document.getElementById('creditBalance').textContent = `â‚©${newBalance.toLocaleString()}`;

                // Refresh history
                await loadTransactionHistory();
                await loadUsageLog();

            } catch (error) {
                console.error('AI ì§ˆë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                document.getElementById('typingIndicator')?.remove();
                showToast('ì§ˆë¬¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                document.getElementById('sendBtn').disabled = false;
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function generateChatGPTResponse(question) {
            const responses = [
                `ì¢‹ì€ ì§ˆë¬¸ì…ë‹ˆë‹¤! "${question}"ì— ëŒ€í•´ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\nì´ ë¬¸ì œëŠ” ì—¬ëŸ¬ ì ‘ê·¼ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²•ì€ ë‹¨ê³„ë³„ë¡œ ë¶„ì„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\n\n1. ë¨¼ì € ë¬¸ì œë¥¼ ëª…í™•íˆ ì •ì˜í•©ë‹ˆë‹¤.\n2. ê´€ë ¨ ìë£Œë¥¼ ì¡°ì‚¬í•©ë‹ˆë‹¤.\n3. í•´ê²°ì±…ì„ êµ¬í˜„í•©ë‹ˆë‹¤.\n\në” ìì„¸í•œ ì„¤ëª…ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”!`,
                `ë„¤, ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. "${question}"ì™€ ê´€ë ¨í•˜ì—¬:\n\nì´ ì£¼ì œëŠ” ê°œë°œì—ì„œ ìì£¼ ë‹¤ë£¨ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤. í•µì‹¬ í¬ì¸íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n\nâ€¢ êµ¬ì¡°ì  ì„¤ê³„ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤\nâ€¢ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í•¨ê»˜ ì‘ì„±í•˜ì„¸ìš”\nâ€¢ ë¬¸ì„œí™”ë¥¼ ìŠì§€ ë§ˆì„¸ìš”\n\nêµ¬ì²´ì ì¸ ì˜ˆì œê°€ í•„ìš”í•˜ì‹œë©´ ì•Œë ¤ì£¼ì„¸ìš”!`,
                `í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”! "${question}"ì— ëŒ€í•œ ì œ ìƒê°ì„ ê³µìœ í•˜ê² ìŠµë‹ˆë‹¤.\n\nìµœê·¼ íŠ¸ë Œë“œë¥¼ ë³´ë©´, ì´ ë¶„ì•¼ëŠ” ë¹ ë¥´ê²Œ ë°œì „í•˜ê³  ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ê³ ë ¤í•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤:\n\n1. ì„±ëŠ¥ ìµœì í™”\n2. ì‚¬ìš©ì ê²½í—˜ ê°œì„ \n3. ìœ ì§€ë³´ìˆ˜ì„±\n\nì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!`
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateGeminiResponse(question) {
            const responses = [
                `ë¶„ì„í•´ ë³´ê² ìŠµë‹ˆë‹¤. "${question}"ì— ëŒ€í•´:\n\nì´ ì½”ë“œ/ë¬¸ì œë¥¼ ë¦¬ë·°í•œ ê²°ê³¼, ëª‡ ê°€ì§€ ê°œì„ ì ì„ ì œì•ˆë“œë¦½ë‹ˆë‹¤:\n\n1. ì½”ë“œ êµ¬ì¡° ê°œì„ : ëª¨ë“ˆí™”ë¥¼ ê³ ë ¤í•´ ë³´ì„¸ìš”\n2. ì—ëŸ¬ ì²˜ë¦¬: try-catch ë¸”ë¡ ì¶”ê°€ ê¶Œì¥\n3. ì„±ëŠ¥: ë¶ˆí•„ìš”í•œ ì—°ì‚°ì„ ì¤„ì´ì„¸ìš”\n\nì „ì²´ì ìœ¼ë¡œ ì¢‹ì€ ì ‘ê·¼ì…ë‹ˆë‹¤. ìœ„ ì œì•ˆì‚¬í•­ì„ ì ìš©í•˜ë©´ ë” ì¢‹ì€ ì½”ë“œê°€ ë  ê²ƒì…ë‹ˆë‹¤.`,
                `ë„¤, "${question}"ì— ëŒ€í•´ ë¶„ì„í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\nì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ ë³´ë©´:\n\nâ€¢ ë ˆì´ì–´ ë¶„ë¦¬ê°€ ì˜ ë˜ì–´ ìˆìŠµë‹ˆë‹¤\nâ€¢ ì˜ì¡´ì„± ì£¼ì… íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤\nâ€¢ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ ì„¤ê³„ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤\n\në” ê¹Šì€ ë¶„ì„ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.`
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generatePerplexityResponse(question) {
            const responses = [
                `"${question}"ì— ëŒ€í•œ ìµœì‹  ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.\n\n2025ë…„ í˜„ì¬ ê¸°ì¤€ìœ¼ë¡œ:\n\nâ€¢ ê´€ë ¨ ê¸°ìˆ  íŠ¸ë Œë“œ: AI í†µí•©, í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ\nâ€¢ ì£¼ìš” ì—…ë°ì´íŠ¸: ì„±ëŠ¥ ê°œì„ , ë³´ì•ˆ ê°•í™”\nâ€¢ ì»¤ë®¤ë‹ˆí‹° ë°˜ì‘: ê¸ì •ì \n\nì¶œì²˜: ê³µì‹ ë¬¸ì„œ, ê¸°ìˆ  ë¸”ë¡œê·¸, Stack Overflow ë“±\n\në” ìì„¸í•œ ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”!`,
                `"${question}"ì— ëŒ€í•´ ì‹¤ì‹œê°„ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.\n\nìµœê·¼ ë™í–¥:\n\n1. ìƒˆë¡œìš´ ë²„ì „ì´ ë¦´ë¦¬ì¦ˆë˜ì—ˆìŠµë‹ˆë‹¤\n2. ì£¼ìš” ê¸°ì—…ë“¤ì´ ì±„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤\n3. í•™ìŠµ ìë£Œê°€ í’ë¶€í•©ë‹ˆë‹¤\n\nê´€ë ¨ ë§í¬ì™€ ìë£Œë¥¼ ë” ì°¾ì•„ë“œë¦´ê¹Œìš”?`
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
