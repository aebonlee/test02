<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë… ì •ë³´ - SSAL Works</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            --primary: #2C4A8A;
            --primary-dark: #1F3563;
            --secondary: #F59E0B;
            --secondary-dark: #D97706;
            --accent: #10B981;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 32px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .rice-logo {
            display: flex;
            align-items: center;
            gap: 3px;
            transform: rotate(-15deg);
        }

        .rice-grain {
            width: 10px;
            height: 18px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border-radius: 40%;
        }

        .rice-grain:nth-child(1) { transform: rotate(-5deg); }
        .rice-grain:nth-child(2) { transform: rotate(5deg); margin-top: 2px; }
        .rice-grain:nth-child(3) { transform: rotate(-3deg); margin-top: -1px; }

        .nav-logo-text { font-size: 28px; font-weight: 800; color: white; }

        .nav-links { display: flex; gap: 24px; align-items: center; }
        .nav-link { color: rgba(255,255,255,0.9); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-link:hover, .nav-link.active { color: white; }

        .close-btn {
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 32px 24px; }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--gray-500);
        }

        .breadcrumb a { color: var(--primary); text-decoration: none; }

        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 32px; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 700px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            text-align: center;
        }

        .stat-icon { font-size: 36px; margin-bottom: 12px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--gray-900); }
        .stat-label { font-size: 14px; color: var(--gray-500); margin-top: 4px; }

        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .card-title { font-size: 18px; font-weight: 600; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .info-grid { grid-template-columns: 1fr; }
        }

        .info-item {
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .info-label { font-size: 13px; color: var(--gray-500); margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; }

        .notice-box {
            margin-top: 20px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            color: var(--gray-500);
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
        }

        .toast.error { background: var(--danger); }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="../../index.html" class="nav-logo">
            <div class="rice-logo">
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
            </div>
            <span class="nav-logo-text">SSAL Works</span>
        </a>
        <div class="nav-links">
            <button class="close-btn" onclick="window.history.length > 1 ? history.back() : window.location.href='../../index.html'" title="ë‹«ê¸°">âœ• ë‹«ê¸°</button>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="../../index.html">í™ˆ</a>
            <span>â€º</span>
            <span>My Page</span>
            <span>â€º</span>
            <span>êµ¬ë… ì •ë³´</span>
        </div>

        <h1 class="page-title">ğŸ“‹ êµ¬ë… ì •ë³´</h1>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-value" id="subStatus">-</div>
                <div class="stat-label">êµ¬ë… ìƒíƒœ</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’³</div>
                <div class="stat-value" id="installFee">-</div>
                <div class="stat-label">ì„¤ì¹˜ë¹„</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-value" id="feeStartDate">-</div>
                <div class="stat-label">í”Œë«í¼ ì´ìš©ë£Œ ì‹œì‘ì¼</div>
            </div>
        </div>

        <!-- Detail Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ìƒì„¸ ì •ë³´</h3>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ êµ¬ë… ìƒíƒœ</div>
                    <div class="info-value" id="subStatusDetail">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„¤ì¹˜ë¹„ ë‚©ë¶€</div>
                    <div class="info-value" id="subInstallDetail">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„¤ì¹˜ë¹„ ë‚©ë¶€ì¼</div>
                    <div class="info-value" id="subInstallDate">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">í”Œë«í¼ ì´ìš©ë£Œ ì‹œì‘ì¼</div>
                    <div class="info-value" id="subFeeStart">-</div>
                </div>
            </div>
            <div class="notice-box">
                êµ¬ë… ìƒíƒœ ë³€ê²½ì´ë‚˜ ê²°ì œ ê´€ë ¨ ë¬¸ì˜ëŠ” ê³ ê°ì„¼í„°ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”.
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const SUPABASE_URL = 'https://zwjmfewyshhwpgwdtrus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3am1mZXd5c2hod3Bnd2R0cnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3NjM3NzIsImV4cCI6MjA0ODMzOTc3Mn0.kICaQ8jF_OKGVXhdGOGvDQFekOlvluXMMOkaCmBLqRY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userData = null;

        document.addEventListener('DOMContentLoaded', checkAuth);

        async function checkAuth() {
            showLoading();
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error || !session) {
                    console.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ');
                    showSampleData();
                    hideLoading();
                    return;
                }
                currentUser = session.user;
                await loadUserData();
            } catch (error) {
                console.log('ì¸ì¦ í™•ì¸ ì‹¤íŒ¨ - ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ');
                showSampleData();
            } finally {
                hideLoading();
            }
        }

        function showSampleData() {
            document.getElementById('subStatus').textContent = 'ë¬´ë£Œ';
            document.getElementById('installFee').textContent = 'ë¯¸ë‚©';
            document.getElementById('feeStartDate').textContent = '-';
            document.getElementById('subStatusDetail').textContent = 'ë¬´ë£Œ';
            document.getElementById('subInstallDetail').textContent = 'ë¯¸ë‚©';
            document.getElementById('subInstallDate').textContent = '-';
            document.getElementById('subFeeStart').textContent = '-';
        }

        async function loadUserData() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                userData = data;
                renderSubscription();
            } catch (error) {
                showToast('êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function renderSubscription() {
            if (!userData) return;

            const statusText = getStatusText(userData.subscription_status);
            const installText = userData.installation_fee_paid ? 'ì™„ë£Œ' : 'ë¯¸ë‚©';

            document.getElementById('subStatus').textContent = statusText;
            document.getElementById('subStatus').className = `stat-value ${userData.subscription_status === 'active' ? 'success' : ''}`;

            document.getElementById('installFee').textContent = installText;
            document.getElementById('installFee').className = `stat-value ${userData.installation_fee_paid ? 'success' : 'warning'}`;

            document.getElementById('feeStartDate').textContent = formatDate(userData.platform_fee_start_date) || '-';

            document.getElementById('subStatusDetail').textContent = statusText;
            document.getElementById('subInstallDetail').textContent = installText;
            document.getElementById('subInstallDate').textContent = formatDate(userData.installation_date) || '-';
            document.getElementById('subFeeStart').textContent = formatDate(userData.platform_fee_start_date) || '-';
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        function getStatusText(status) {
            const map = { 'free': 'ë¬´ë£Œ', 'active': 'í™œì„±', 'paused': 'ì¼ì‹œì •ì§€', 'suspended': 'ì •ì§€', 'cancelled': 'í•´ì§€' };
            return map[status] || 'ë¬´ë£Œ';
        }

        function formatDate(d) { return d ? new Date(d).toLocaleDateString('ko-KR') : null; }
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
