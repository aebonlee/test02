{
  "report_type": "bugfix",
  "created_at": "2026-01-05T00:00:00.000Z",
  "updated_at": "2026-01-05T01:00:00.000Z",
  "title": "다른 AI에게 질문하기 기능 버그 수정",
  "feature": "AI Q&A (ChatGPT, Gemini, Perplexity)",
  "status": "resolved",

  "symptom": {
    "description": "다른 AI에게 질문하기 기능이 작동하지 않음",
    "affected_feature": "사이드바 > 다른 AI에게 질문하기",
    "user_action": "질문 입력 후 제출하기 클릭",
    "expected_result": "AI 답변이 컨트롤 데스크에 표시",
    "actual_result": [
      "API 오류 또는 무응답",
      "답변이 이력에는 저장되지만 컨트롤 데스크에 표시 안 됨"
    ]
  },

  "root_cause_analysis": {
    "cause_count": 3,
    "causes": [
      {
        "id": 1,
        "file": "api/External/ai-qa.js",
        "type": "syntax_error",
        "severity": "critical",
        "description": "템플릿 문자열(백틱) 내용 손실로 인한 구문 오류",
        "affected_lines": [104, 122, 215, 224],
        "details": [
          {
            "line": 104,
            "before": "description: ,",
            "issue": "크레딧 이력 설명 누락"
          },
          {
            "line": 122,
            "before": "ai_model: ,",
            "issue": "AI 모델 기록 누락"
          },
          {
            "line": 215,
            "before": "learningContext = ;",
            "issue": "학습 콘텐츠 컨텍스트 할당값 누락"
          },
          {
            "line": 224,
            "before": "? :",
            "issue": "삼항 연산자 값 누락"
          }
        ],
        "probable_origin": "Git 머지 충돌 또는 에디터 오류로 백틱 내용 손실"
      },
      {
        "id": 2,
        "file": "index.html",
        "type": "missing_feature",
        "severity": "high",
        "description": "API 호출 시 Authorization 헤더 누락",
        "affected_function": "askAI()",
        "details": "fetch 요청에 Bearer 토큰이 포함되지 않아 API가 사용자를 인식하지 못함",
        "impact": "크레딧 확인 및 사용 로그 기록 불가"
      },
      {
        "id": 3,
        "file": "index.html",
        "type": "css_priority",
        "severity": "medium",
        "description": "CSS !important 우선순위 문제로 컨트롤 데스크에 결과 미표시",
        "affected_function": "askAI()",
        "details": "다른 함수들이 textEditor를 display: none !important로 숨기는데, askAI는 일반 style.display = 'block'을 사용하여 우선순위에 밀림",
        "symptom": "API 응답 성공, 이력 저장 성공, 하지만 컨트롤 데스크(textEditor)에 표시 안 됨",
        "impact": "사용자가 AI 답변을 컨트롤 데스크에서 볼 수 없음"
      }
    ]
  },

  "solution": {
    "files_modified": [
      {
        "file": "api/External/ai-qa.js",
        "changes": 4,
        "commit": "8820ba0",
        "fixes": [
          {
            "line": 104,
            "after": "description: `AI Q&A (${provider}/${model})`"
          },
          {
            "line": 122,
            "after": "ai_model: `${provider}/${model}`"
          },
          {
            "line": 215,
            "after": "learningContext = `[참고 콘텐츠: ${content.title}]\\n${content.description || ''}\\n\\n${content.content}`"
          },
          {
            "line": 224,
            "after": "? `${learningContext}\\n\\n질문: ${question}`"
          }
        ]
      },
      {
        "file": "index.html",
        "changes": 2,
        "fixes": [
          {
            "commit": "8820ba0",
            "function": "askAI()",
            "issue": "Authorization 헤더 누락",
            "solution": "Supabase 세션에서 access_token 가져와서 Authorization 헤더에 추가",
            "code_added": "const { data: { session } } = await window.supabaseClient.auth.getSession(); if (session?.access_token) { headers['Authorization'] = `Bearer ${session.access_token}`; }"
          },
          {
            "commit": "fe7f8f5",
            "function": "askAI()",
            "issue": "CSS !important 우선순위",
            "solution": "style.display 대신 setAttribute로 !important 스타일 적용",
            "before": "workspace.style.display = 'block';",
            "after": "workspace.setAttribute('style', 'display: block !important; visibility: visible !important; width: 100%; height: 100%; padding: 20px; font-size: 14px; line-height: 1.6; border: none; resize: none; font-family: inherit;');"
          }
        ]
      }
    ]
  },

  "git_commits": [
    {
      "hash": "8820ba0",
      "message": "fix: 다른 AI에게 질문하기 기능 수정 - 구문 오류 및 인증 헤더 추가",
      "files_changed": 3,
      "fixes": ["ai-qa.js 구문 오류 4곳", "Authorization 헤더 추가"]
    },
    {
      "hash": "fe7f8f5",
      "message": "fix: AI Q&A 결과가 컨트롤 데스크에 표시되지 않는 문제 수정 (!important 추가)",
      "files_changed": 2,
      "fixes": ["CSS !important 우선순위 문제 해결"]
    },
    {
      "hash": "ca1e4f1",
      "message": "debug: AI Q&A 컨트롤 데스크 표시 문제 디버깅 로그 추가",
      "files_changed": 2,
      "fixes": ["디버깅용 console.log 추가"]
    }
  ],

  "verification": {
    "status": "verified",
    "tested_on": "https://www.ssalworks.ai.kr",
    "test_results": {
      "gemini": "success",
      "chatgpt": "success",
      "perplexity": "not_tested",
      "control_desk_display": "success",
      "history_save": "success"
    },
    "note": "프로덕션 테스트 완료 - 모든 기능 정상 작동"
  },

  "related_files": [
    "api/External/ai-qa.js",
    "index.html",
    "api/Backend_Infra/ai/index.js",
    "vercel.json"
  ],

  "api_endpoint": {
    "path": "/api/ai/qa",
    "method": "POST",
    "routing": "/api/External/ai-qa",
    "providers": ["gemini", "chatgpt", "perplexity"]
  },

  "debugging_tips": {
    "console_logs": [
      "[AI Q&A] 응답 성공: {result}",
      "[AI Q&A] workspace: {element}",
      "[AI Q&A] workspaceGuide: {element}",
      "[AI Q&A] workspaceGuide 숨김 완료",
      "[AI Q&A] workspace 표시 완료, 내용 길이: {length}",
      "[AI Q&A] workspace.value 설정 후: {preview}"
    ],
    "check_order": [
      "1. 브라우저 콘솔에서 [AI Q&A] 로그 확인",
      "2. workspace 요소가 null인지 확인",
      "3. API 응답이 success: true인지 확인",
      "4. CSS 스타일이 제대로 적용되는지 확인"
    ]
  },

  "lessons_learned": [
    "템플릿 문자열(백틱)은 Git 머지 시 손상되기 쉬움 - 머지 후 반드시 확인",
    "API 호출 시 인증 헤더 포함 여부 항상 확인",
    "구문 오류는 런타임 전에 발견하기 어려움 - ESLint 린터 활용 권장",
    "CSS !important를 사용하는 코드가 있으면, 같은 요소를 수정하는 다른 코드도 !important 사용 필요",
    "style.property 대신 setAttribute('style', '...!important')로 우선순위 확보",
    "디버깅 시 console.log로 단계별 확인이 효과적",
    "이력 저장은 되는데 화면 표시 안 되면 CSS 문제 의심"
  ],

  "prevention": [
    "코드 리뷰 시 템플릿 문자열 내용 확인",
    "API 호출 함수에 인증 헤더 체크리스트 사용",
    "CSS 수정 시 !important 사용 여부 확인",
    "주요 기능 수정 후 프로덕션 테스트 필수"
  ]
}
