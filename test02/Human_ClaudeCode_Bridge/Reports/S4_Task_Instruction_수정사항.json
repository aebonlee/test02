{
  "report_id": "S4_TASK_INSTRUCTION_REVISION",
  "report_title": "S4 Task Instruction 수정사항",
  "generated_at": "2025-12-19T00:00:00Z",
  "generator": "Claude Code",
  "status": "작업 대기",

  "summary": {
    "background": "토스 페이먼트 연동을 추후로 미루고, 무통장 입금 방식으로 결제 시스템 구현",
    "payment_type_separation": {
      "installation_fee": "무통장 입금 (현금)",
      "credit_purchase": "무통장 입금 (현금)",
      "monthly_fee": "토스 페이먼트 (추후 구현)"
    },
    "stage_changes": [
      {
        "task_id": "S4BI1",
        "task_name": "Sentry 모니터링",
        "from_stage": "S4 (개발 3차)",
        "to_stage": "S1 (개발 준비)",
        "new_task_id": "S1BI2",
        "reason": "에러 모니터링은 개발 초기부터 필요"
      },
      {
        "task_id": "S4F2",
        "task_name": "AI Q&A UI",
        "from_stage": "S4 (개발 3차)",
        "to_stage": "S3 (개발 2차)",
        "new_task_id": "S3F1",
        "reason": "AI 연동 기능은 S3 목표에 해당"
      }
    ],
    "s4_task_count": {
      "before": 10,
      "after": 8
    }
  },

  "s4_execution_plan": {
    "total_tasks": 8,
    "phases": [
      {
        "phase": 1,
        "name": "결제 시스템 백엔드",
        "tasks": [
          {
            "task_id": "S4BA1",
            "task_name": "무통장 입금 결제 API",
            "description": "입금 요청 접수, 입금 정보 저장, 상태 관리"
          },
          {
            "task_id": "S4BA2",
            "task_name": "입금 확인 API (관리자용)",
            "description": "관리자 입금 확인 처리, 구독/크레딧 활성화"
          }
        ]
      },
      {
        "phase": 2,
        "name": "관리자 기능",
        "tasks": [
          {
            "task_id": "S4F1",
            "task_name": "관리자 대시보드 강화",
            "description": "입금 대기 목록, 확인 처리 UI"
          },
          {
            "task_id": "S4M1",
            "task_name": "MVP 최종 검토 + 관리자 가이드",
            "description": "입금 확인 절차 매뉴얼 포함"
          }
        ]
      },
      {
        "phase": 3,
        "name": "자동화 및 테스트",
        "tasks": [
          {
            "task_id": "S4O1",
            "task_name": "Cron Jobs",
            "description": "구독 만료 처리, 알림 발송"
          },
          {
            "task_id": "S4T1",
            "task_name": "통합 테스트",
            "description": "결제 플로우 전체 테스트"
          }
        ]
      },
      {
        "phase": 4,
        "name": "안정화",
        "tasks": [
          {
            "task_id": "S4S1",
            "task_name": "결제 데이터 보안",
            "description": "입금 정보 보호, 감사 로그"
          },
          {
            "task_id": "S4O2",
            "task_name": "모니터링 강화",
            "description": "결제 상태 모니터링, 알림"
          }
        ]
      }
    ]
  },

  "instruction_changes": {
    "delete": [
      {
        "file": "S4BI1_instruction.md",
        "reason": "S1BI2로 이동됨 (Sentry 모니터링)",
        "action": "파일 삭제 후 S1BI2_instruction.md 생성"
      },
      {
        "file": "S4F2_instruction.md",
        "reason": "S3F1로 이동됨 (AI Q&A UI)",
        "action": "파일 삭제 후 S3F1_instruction.md 생성"
      }
    ],

    "rewrite": [
      {
        "file": "S4BA1_instruction.md",
        "current_content": "토스 페이먼트 결제 승인 및 빌링 API",
        "new_content": {
          "task_id": "S4BA1",
          "task_name": "무통장 입금 결제 API",
          "task_goal": "무통장 입금 요청 접수 및 결제 정보 관리 API 구현",
          "specific_instructions": [
            {
              "section": "1. 입금 요청 API",
              "location": "api/payment/request.js",
              "features": [
                "입금 요청 접수 (user_id, payment_type, amount)",
                "고유 입금 식별 코드 생성",
                "payments 테이블에 상태 'pending'으로 저장",
                "입금 안내 정보 반환 (계좌번호, 예금주, 입금액)"
              ]
            },
            {
              "section": "2. 입금 상태 조회 API",
              "location": "api/payment/status.js",
              "features": [
                "입금 상태 조회 (pending, confirmed, cancelled, expired)",
                "사용자별 입금 내역 조회"
              ]
            },
            {
              "section": "3. 입금 취소 API",
              "location": "api/payment/cancel.js",
              "features": [
                "미확인 입금 요청 취소",
                "상태 'cancelled'로 변경"
              ]
            }
          ],
          "payment_types": [
            {
              "type": "installation_fee",
              "description": "설치비",
              "amounts": [500000, 1000000, 2000000]
            },
            {
              "type": "credit",
              "description": "AI 크레딧 충전",
              "amounts": [10000, 30000, 50000, 100000],
              "bonus": {
                "10000": "10%",
                "30000": "15%",
                "50000": "20%",
                "100000": "25%"
              }
            }
          ],
          "bank_info": {
            "bank_name": "환경변수 (BANK_NAME)",
            "account_number": "환경변수 (BANK_ACCOUNT)",
            "account_holder": "환경변수 (BANK_HOLDER)"
          },
          "expected_output_files": [
            "api/payment/request.js",
            "api/payment/status.js",
            "api/payment/cancel.js"
          ]
        }
      },
      {
        "file": "S4BA2_instruction.md",
        "current_content": "토스 페이먼트 웹훅 수신 및 결제 상태 동기화",
        "new_content": {
          "task_id": "S4BA2",
          "task_name": "입금 확인 API (관리자용)",
          "task_goal": "관리자가 입금을 수동으로 확인하고 서비스를 활성화하는 API 구현",
          "specific_instructions": [
            {
              "section": "1. 입금 대기 목록 조회 API",
              "location": "api/admin/payments/pending.js",
              "features": [
                "status='pending'인 입금 요청 목록 조회",
                "필터링 (payment_type, date_range)",
                "페이지네이션"
              ]
            },
            {
              "section": "2. 입금 확인 처리 API",
              "location": "api/admin/payments/confirm.js",
              "features": [
                "관리자 권한 검증 (is_admin 체크)",
                "입금 상태 'confirmed'로 변경",
                "payment_type에 따른 처리 분기",
                "installation_fee: 구독 활성화 (subscriptions 테이블)",
                "credit: 크레딧 충전 (user_credits 테이블 + 보너스 적용)",
                "확인 기록 저장 (confirmed_by, confirmed_at)"
              ]
            },
            {
              "section": "3. 입금 거부 API",
              "location": "api/admin/payments/reject.js",
              "features": [
                "입금 상태 'rejected'로 변경",
                "거부 사유 기록",
                "사용자에게 알림 (이메일)"
              ]
            }
          ],
          "expected_output_files": [
            "api/admin/payments/pending.js",
            "api/admin/payments/confirm.js",
            "api/admin/payments/reject.js"
          ]
        }
      },
      {
        "file": "S4F1_instruction.md",
        "current_content": "토스 페이먼트 결제 위젯 연동 UI (관리자 대시보드 강화라는 이름이지만 내용은 결제 UI)",
        "new_content": {
          "task_id": "S4F1",
          "task_name": "관리자 대시보드 강화",
          "task_goal": "관리자가 입금 요청을 확인하고 처리할 수 있는 대시보드 UI 구현",
          "specific_instructions": [
            {
              "section": "1. 입금 대기 목록 페이지",
              "location": "pages/admin/payments/pending.html",
              "features": [
                "대기 중인 입금 요청 테이블",
                "컬럼: 사용자명, 결제유형, 금액, 요청일시, 상태",
                "필터: 결제유형, 날짜범위",
                "검색: 사용자명, 이메일"
              ]
            },
            {
              "section": "2. 입금 확인 모달",
              "location": "components/admin/PaymentConfirmModal.js",
              "features": [
                "입금 상세 정보 표시",
                "확인/거부 버튼",
                "거부 시 사유 입력",
                "확인 시 자동 서비스 활성화 안내"
              ]
            },
            {
              "section": "3. 입금 내역 페이지",
              "location": "pages/admin/payments/history.html",
              "features": [
                "전체 입금 내역 조회",
                "상태별 필터 (pending, confirmed, rejected)",
                "Excel 다운로드 기능"
              ]
            }
          ],
          "expected_output_files": [
            "pages/admin/payments/pending.html",
            "pages/admin/payments/history.html",
            "components/admin/PaymentConfirmModal.js",
            "admin-payments.js",
            "admin-payments.css"
          ]
        }
      }
    ],

    "modify": [
      {
        "file": "S4M1_instruction.md",
        "current_content": "MVP 최종 검토",
        "modification": {
          "add_section": "관리자 입금 확인 절차 가이드",
          "add_content": [
            "1. 입금 알림 수신 시 대시보드 확인",
            "2. 실제 계좌 입금 내역과 대조",
            "3. 금액/입금자명 일치 시 '확인' 처리",
            "4. 불일치 시 '거부' 처리 및 사유 기록",
            "5. 확인 완료 시 자동 서비스 활성화 확인"
          ]
        }
      }
    ]
  },

  "database_schema_notes": {
    "payments_table": {
      "add_columns": [
        "payment_type VARCHAR(50) NOT NULL -- 'installation_fee', 'credit', 'monthly_fee'",
        "deposit_code VARCHAR(20) UNIQUE -- 고유 입금 식별 코드",
        "confirmed_by UUID REFERENCES users(id) -- 확인한 관리자",
        "confirmed_at TIMESTAMP WITH TIME ZONE -- 확인 일시",
        "rejection_reason TEXT -- 거부 사유"
      ],
      "status_values": ["pending", "confirmed", "rejected", "cancelled", "expired"]
    }
  },

  "environment_variables": {
    "required": [
      "BANK_NAME -- 입금 은행명",
      "BANK_ACCOUNT -- 입금 계좌번호",
      "BANK_HOLDER -- 예금주명"
    ]
  },

  "future_work": {
    "monthly_fee_toss_payment": {
      "description": "매월 이용료는 토스 페이먼트로 자동 결제 (추후 구현)",
      "tasks": [
        "토스 페이먼트 빌링키 발급 API",
        "자동 결제 실행 API",
        "결제 웹훅 핸들러",
        "결제 실패 재시도 로직"
      ],
      "timing": "MVP 안정화 후"
    }
  },

  "action_items": [
    {
      "priority": 1,
      "action": "S4BI1_instruction.md 삭제",
      "detail": "해당 내용은 S1BI2_instruction.md로 새로 작성"
    },
    {
      "priority": 2,
      "action": "S4F2_instruction.md 삭제",
      "detail": "해당 내용은 S3F1_instruction.md로 새로 작성"
    },
    {
      "priority": 3,
      "action": "S4BA1_instruction.md 전면 재작성",
      "detail": "토스 결제 API → 무통장 입금 결제 API"
    },
    {
      "priority": 4,
      "action": "S4BA2_instruction.md 전면 재작성",
      "detail": "토스 웹훅 → 입금 확인 API (관리자용)"
    },
    {
      "priority": 5,
      "action": "S4F1_instruction.md 전면 재작성",
      "detail": "토스 결제 UI → 관리자 대시보드 (입금 대기 목록)"
    },
    {
      "priority": 6,
      "action": "S4M1_instruction.md 수정",
      "detail": "관리자 입금 확인 절차 가이드 섹션 추가"
    }
  ]
}
