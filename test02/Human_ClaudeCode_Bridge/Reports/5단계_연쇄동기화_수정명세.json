{
  "report_id": "5STEP_SYNC_SPECIFICATION",
  "report_title": "5단계 연쇄 동기화 수정 명세서",
  "generated_at": "2025-12-19T13:00:00Z",
  "generator": "Claude Code",

  "process_understanding": {
    "description": "Task Plan을 Single Source of Truth로 하여 5단계 연쇄 수정",
    "steps": [
      "1단계: Task Plan 수정 (SSALWORKS_TASK_PLAN.md)",
      "2단계: Task Instruction 수정 (task-instructions/)",
      "3단계: Seed SQL / DB 수정 (seed_project_sal_grid.sql)",
      "4단계: Verification Instruction 수정 (verification-instructions/)",
      "5단계: Stage 안내문 / Order Sheet 수정"
    ]
  },

  "tasks_to_modify": [
    {
      "task_id": "S4O1",
      "modification_type": "내용 전면 재작성",
      "reason": "현재 내용이 '토스 페이먼트 가맹점 등록'으로 잘못 작성됨, 실제는 Cron Jobs 설정",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "수정",
        "changes": {
          "task_name": "Cron Jobs 설정",
          "description": "Vercel Cron Jobs를 이용한 자동화 작업 설정 - AI 가격 업데이트, 이탈 위험 사용자 알림, 구독 만료 처리, 입금 대기 만료, 챌린지 만료 알림"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S4O1_instruction.md",
        "action": "전면 재작성",
        "new_content": {
          "task_goal": "Vercel Cron Jobs를 이용한 자동화 작업 설정",
          "cron_jobs": [
            {"name": "AI 가격 자동 업데이트", "schedule": "매일 00:00"},
            {"name": "이탈 위험 사용자 알림", "schedule": "매일 09:00"},
            {"name": "구독 만료 처리", "schedule": "매일 00:00"},
            {"name": "입금 대기 만료 처리", "schedule": "매일 00:00"},
            {"name": "챌린지 만료 알림", "schedule": "매월 1일 09:00"}
          ]
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "UPDATE",
        "changes": {
          "task_name": "Cron Jobs 설정",
          "tools": "vercel-cli, /mcp__supabase__*"
        }
      },

      "step_4_verification": {
        "file": "verification-instructions/S4O1_verification.md",
        "action": "재작성",
        "criteria": [
          "vercel.json에 crons 설정 존재",
          "api/cron/ 폴더에 5개 cron handler 존재",
          "각 cron job이 CRON_SECRET 인증 사용",
          "Vercel 배포 후 cron 실행 확인"
        ]
      },

      "step_5_stage_guide": {
        "file": "S4_개발_3차 안내문",
        "action": "수정",
        "changes": "S4O1 설명을 Cron Jobs 설정으로 업데이트"
      }
    },

    {
      "task_id": "S4BA1",
      "modification_type": "내용 전면 재작성",
      "reason": "토스 페이먼트 결제 API → 무통장 입금 결제 API로 변경",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "수정",
        "changes": {
          "task_name": "무통장 입금 결제 API",
          "description": "무통장 입금 요청 접수 및 결제 정보 관리 API 구현"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S4BA1_instruction.md",
        "action": "전면 재작성",
        "new_content": {
          "task_goal": "무통장 입금 요청 접수 및 결제 정보 관리 API 구현",
          "apis": [
            {"name": "입금 요청 API", "location": "api/payment/request.js"},
            {"name": "입금 상태 조회 API", "location": "api/payment/status.js"},
            {"name": "입금 취소 API", "location": "api/payment/cancel.js"}
          ],
          "payment_types": ["installation_fee", "credit"],
          "bank_info": "환경변수 (BANK_NAME, BANK_ACCOUNT, BANK_HOLDER)"
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "UPDATE",
        "changes": {
          "task_name": "무통장 입금 결제 API",
          "tools": "/mcp__supabase__*, resend-sdk"
        }
      },

      "step_4_verification": {
        "file": "verification-instructions/S4BA1_verification.md",
        "action": "재작성",
        "criteria": [
          "api/payment/request.js 존재 및 동작",
          "api/payment/status.js 존재 및 동작",
          "api/payment/cancel.js 존재 및 동작",
          "payments 테이블에 deposit_code 컬럼 추가",
          "환경변수 BANK_* 설정 확인"
        ]
      },

      "step_5_stage_guide": {
        "file": "S4_개발_3차 안내문",
        "action": "수정",
        "changes": "S4BA1 설명을 무통장 입금 결제 API로 업데이트"
      }
    },

    {
      "task_id": "S4BA2",
      "modification_type": "내용 전면 재작성",
      "reason": "토스 웹훅 API → 관리자 수동 입금 확인 API로 변경",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "수정",
        "changes": {
          "task_name": "입금 확인 API (관리자용)",
          "description": "관리자가 입금을 수동으로 확인하고 서비스를 활성화하는 API"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S4BA2_instruction.md",
        "action": "전면 재작성",
        "new_content": {
          "task_goal": "관리자가 입금을 수동으로 확인하고 서비스를 활성화하는 API 구현",
          "apis": [
            {"name": "입금 대기 목록 조회 API", "location": "api/admin/payments/pending.js"},
            {"name": "입금 확인 처리 API", "location": "api/admin/payments/confirm.js"},
            {"name": "입금 거부 API", "location": "api/admin/payments/reject.js"}
          ]
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "UPDATE",
        "changes": {
          "task_name": "입금 확인 API (관리자용)",
          "dependencies": "S4BA1"
        }
      },

      "step_4_verification": {
        "file": "verification-instructions/S4BA2_verification.md",
        "action": "재작성",
        "criteria": [
          "api/admin/payments/pending.js 존재 및 동작",
          "api/admin/payments/confirm.js 존재 및 동작",
          "api/admin/payments/reject.js 존재 및 동작",
          "관리자 권한 검증 (is_admin) 동작",
          "입금 확인 시 구독/크레딧 활성화"
        ]
      },

      "step_5_stage_guide": {
        "file": "S4_개발_3차 안내문",
        "action": "수정",
        "changes": "S4BA2 설명을 입금 확인 API (관리자용)로 업데이트"
      }
    },

    {
      "task_id": "S4BA3",
      "modification_type": "신규 생성",
      "reason": "결제/알림 이메일 템플릿 필요 (S2에는 welcome, password-reset만 있음)",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "추가 (이미 추가됨)",
        "changes": {
          "task_name": "결제/알림 이메일 템플릿",
          "description": "결제 및 자동화 시스템에서 사용할 이메일 템플릿 구현"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S4BA3_instruction.md",
        "action": "신규 생성",
        "new_content": {
          "task_goal": "결제 및 자동화 시스템에서 사용할 이메일 템플릿 구현",
          "email_templates": [
            "receipt (결제 영수증)",
            "billing-success (월 구독료 결제 완료)",
            "payment-failure (결제 실패)",
            "payment-rejected (입금 확인 불가)",
            "low-credit (크레딧 부족)",
            "feature-intro (새로운 AI 기능 안내)",
            "recharge (크레딧 충전 안내)",
            "subscription-suspended (구독 정지)",
            "refund-complete (환불 완료)",
            "verify-email-reminder (이메일 인증 리마인더)",
            "project-registration-reminder (프로젝트 등록 리마인더)",
            "day7-reminder (무료체험 7일차)",
            "challenge-expiry (챌린지 만료)"
          ]
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "INSERT (이미 추가됨)",
        "note": "다른 Claude Code가 이미 Seed SQL에 추가함"
      },

      "step_4_verification": {
        "file": "verification-instructions/S4BA3_verification.md",
        "action": "신규 생성",
        "criteria": [
          "13개 이메일 템플릿 파일 존재",
          "각 템플릿이 HTML + Plain Text 버전 제공",
          "Resend API 연동 테스트 통과",
          "변수 치환 기능 동작"
        ]
      },

      "step_5_stage_guide": {
        "file": "S4_개발_3차 안내문",
        "action": "추가",
        "changes": "S4BA3 결제/알림 이메일 템플릿 Task 추가"
      }
    },

    {
      "task_id": "S4F1",
      "modification_type": "내용 전면 재작성",
      "reason": "토스 결제 UI → 무통장 입금 관리 UI로 변경",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "수정",
        "changes": {
          "task_name": "관리자 대시보드 강화",
          "description": "관리자가 입금 요청을 확인하고 처리할 수 있는 대시보드 UI"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S4F1_instruction.md",
        "action": "전면 재작성",
        "new_content": {
          "task_goal": "관리자가 입금 요청을 확인하고 처리할 수 있는 대시보드 UI 구현",
          "pages": [
            {"name": "입금 대기 목록 페이지", "location": "pages/admin/payments/pending.html"},
            {"name": "입금 확인 모달", "location": "components/admin/PaymentConfirmModal.js"},
            {"name": "입금 내역 페이지", "location": "pages/admin/payments/history.html"}
          ]
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "UPDATE",
        "changes": {
          "task_name": "관리자 대시보드 강화",
          "dependencies": "S4BA1, S4BA2"
        }
      },

      "step_4_verification": {
        "file": "verification-instructions/S4F1_verification.md",
        "action": "재작성",
        "criteria": [
          "입금 대기 목록 페이지 동작",
          "입금 확인/거부 모달 동작",
          "입금 내역 페이지 동작",
          "S4BA1, S4BA2 API 연동 확인"
        ]
      },

      "step_5_stage_guide": {
        "file": "S4_개발_3차 안내문",
        "action": "수정",
        "changes": "S4F1 설명을 무통장 입금 관리 UI로 업데이트"
      }
    },

    {
      "task_id": "S3F1",
      "modification_type": "내용 추가",
      "reason": "크레딧 부족 시 모달/alert 구현 내용 누락",

      "step_1_task_plan": {
        "file": "SSALWORKS_TASK_PLAN.md",
        "action": "수정",
        "changes": {
          "description_add": "크레딧 부족 시 충전 안내 모달/alert 포함"
        }
      },

      "step_2_task_instruction": {
        "file": "task-instructions/S3F1_instruction.md",
        "action": "내용 추가",
        "add_content": {
          "section": "크레딧 부족 처리 UI",
          "features": [
            "크레딧 부족 모달 (AI 질문 전송 시)",
            "크레딧 경고 배너 (잔액 1,000C 미만 시)",
            "충전 페이지 이동 버튼"
          ],
          "code_location": "ai-qa.js 내 sendQuestion() 함수에 추가"
        }
      },

      "step_3_seed_sql": {
        "file": "seed_project_sal_grid.sql",
        "action": "UPDATE (minor)",
        "changes": "description 업데이트"
      },

      "step_4_verification": {
        "file": "verification-instructions/S3F1_verification.md",
        "action": "내용 추가",
        "add_criteria": [
          "크레딧 부족 시 모달 표시",
          "모달에서 충전 페이지로 이동 가능",
          "1,000C 미만 시 경고 배너 표시"
        ]
      },

      "step_5_stage_guide": {
        "file": "S3_개발_2차 안내문",
        "action": "수정",
        "changes": "S3F1 설명에 크레딧 부족 UI 추가"
      }
    }
  ],

  "execution_order": [
    "1. S4O1 - Cron Jobs (독립적)",
    "2. S4BA1 - 무통장 입금 API (S4BA2의 선행)",
    "3. S4BA2 - 입금 확인 API (S4BA1 의존)",
    "4. S4BA3 - 이메일 템플릿 (S4BA2에서 사용)",
    "5. S4F1 - 관리자 대시보드 (S4BA1, S4BA2 의존)",
    "6. S3F1 - 크레딧 부족 UI (독립적)"
  ],

  "files_to_modify": {
    "step_1_task_plan": ["SSALWORKS_TASK_PLAN.md"],
    "step_2_task_instructions": [
      "S4O1_instruction.md (재작성)",
      "S4BA1_instruction.md (재작성)",
      "S4BA2_instruction.md (재작성)",
      "S4BA3_instruction.md (신규)",
      "S4F1_instruction.md (재작성)",
      "S3F1_instruction.md (추가)"
    ],
    "step_3_seed_sql": ["seed_project_sal_grid.sql"],
    "step_4_verification_instructions": [
      "S4O1_verification.md (재작성)",
      "S4BA1_verification.md (재작성)",
      "S4BA2_verification.md (재작성)",
      "S4BA3_verification.md (신규)",
      "S4F1_verification.md (재작성)",
      "S3F1_verification.md (추가)"
    ],
    "step_5_stage_guides": [
      "S3_개발_2차 안내문 (S3F1 관련)",
      "S4_개발_3차 안내문 (S4 Task 관련)"
    ]
  },

  "note": "이 명세서를 기반으로 5단계 연쇄 동기화 작업 수행"
}
