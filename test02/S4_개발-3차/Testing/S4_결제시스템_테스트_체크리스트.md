# S4 Payment System Verification Instruction

---

## 개요

SSALWorks 결제 시스템 검증 가이드입니다.
아래 체크리스트를 통해 S4 결제 관련 Task들의 구현을 검증합니다.

## 관련 Task

| Task ID | 설명 | 결제 방법 |
|---------|------|----------|
| S4BA1 | 설치비 무통장 입금 API | 무통장 입금 |
| S4BA2 | 설치비 입금 확인 API | 관리자 확인 |
| S4BA3 | 토스페이먼츠 결제 API | 토스페이먼츠 |
| S4BA6 | 이메일 템플릿 | Resend |
| S4F1 | 관리자 대시보드 | - |
| S4O1 | Cron Jobs | - |

---

## 1. S4BA1 검증: 설치비 무통장 입금 API

### 1.1 파일 존재 확인
```
[ ] /api/payment/installation/request.js
[ ] /api/payment/installation/status.js
[ ] /api/payment/installation/cancel.js
[ ] /api/payment/installation/info.js
```

### 1.2 기능 검증

#### 1.2.1 입금 요청 API (`POST /api/payment/installation/request`)
```bash
# 테스트 요청
curl -X POST http://localhost:3000/api/payment/installation/request \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json"
```

**예상 응답:**
```json
{
  "success": true,
  "data": {
    "deposit_id": "uuid",
    "deposit_code": "ABC123",
    "amount": 3000000,
    "bank_name": "기업은행",
    "account_number": "000-000000-00-000",
    "account_holder": "SSALWorks",
    "expires_at": "2025-12-26T00:00:00.000Z"
  }
}
```

**검증 항목:**
- [ ] 금액이 정확히 ₩3,000,000인가?
- [ ] 입금코드가 6자리 영숫자인가?
- [ ] 만료일이 7일 후인가?
- [ ] 중복 요청 방지가 동작하는가?

#### 1.2.2 상태 조회 API (`GET /api/payment/installation/status`)
- [ ] 본인의 입금 요청만 조회 가능한가?
- [ ] 상태 값이 올바른가? (pending/confirmed/rejected/expired)

#### 1.2.3 취소 API (`POST /api/payment/installation/cancel`)
- [ ] pending 상태에서만 취소 가능한가?
- [ ] 본인의 요청만 취소 가능한가?

#### 1.2.4 계좌 정보 API (`GET /api/payment/installation/info`)
- [ ] 인증 없이 접근 가능한가?
- [ ] 계좌 정보가 올바르게 반환되는가?

---

## 2. S4BA2 검증: 설치비 입금 확인 API

### 2.1 파일 존재 확인
```
[ ] /api/admin/installation/pending.js
[ ] /api/admin/installation/confirm.js
[ ] /api/admin/installation/reject.js
[ ] /api/admin/installation/history.js
```

### 2.2 기능 검증

#### 2.2.1 입금 확인 API (`POST /api/admin/installation/confirm`)
```bash
curl -X POST http://localhost:3000/api/admin/installation/confirm \
  -H "Authorization: Bearer ${ADMIN_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"deposit_id": "uuid", "admin_note": "확인 완료"}'
```

**예상 응답:**
```json
{
  "success": true,
  "data": {
    "user_id": "uuid",
    "initial_credit_granted": 50000,
    "subscription_started_at": "2025-12-19T00:00:00.000Z",
    "free_period_ends_at": "2026-03-19T00:00:00.000Z",
    "next_billing_date": "2026-03-19T00:00:00.000Z",
    "welcome_email_sent": true
  }
}
```

**검증 항목:**
- [ ] 관리자만 접근 가능한가? (role='admin')
- [ ] 초기 크레딧 ₩50,000이 정확히 지급되는가?
- [ ] subscription_started_at이 설정되는가?
- [ ] 무료 기간이 3개월로 설정되는가?
- [ ] next_billing_date가 3개월 후로 설정되는가?
- [ ] 환영 이메일이 발송되는가?
- [ ] is_service_active가 true로 변경되는가?
- [ ] credit_transactions에 'initial_grant' 기록이 생성되는가?

#### 2.2.2 입금 거부 API (`POST /api/admin/installation/reject`)
- [ ] 관리자만 접근 가능한가?
- [ ] 거부 사유가 필수인가?
- [ ] 거부 이메일이 발송되는가?

---

## 3. S4BA3 검증: 토스페이먼츠 결제 API

### 3.1 파일 존재 확인
```
[ ] /api/payment/credit/request.js
[ ] /api/payment/credit/success.js
[ ] /api/payment/credit/fail.js
[ ] /api/payment/billing/register.js
[ ] /api/payment/billing/charge.js
[ ] /api/webhook/toss.js
```

### 3.2 기능 검증

#### 3.2.1 크레딧 충전 요청 (`POST /api/payment/credit/request`)
```bash
curl -X POST http://localhost:3000/api/payment/credit/request \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"amount": 30000}'
```

**검증 항목:**
- [ ] 허용된 금액만 가능한가? (₩10,000/₩20,000/₩30,000/₩50,000)
- [ ] checkout_url이 반환되는가?
- [ ] 토스페이먼츠 결제창으로 리다이렉트되는가?

#### 3.2.2 결제 성공 콜백 (`GET /api/payment/credit/success`)
- [ ] paymentKey, orderId, amount 검증이 동작하는가?
- [ ] 토스 API로 결제 승인이 되는가?
- [ ] 크레딧이 정확히 충전되는가?
- [ ] payments 테이블에 기록이 생성되는가?
- [ ] credit_transactions에 'charge' 기록이 생성되는가?
- [ ] 충전 완료 이메일이 발송되는가?

#### 3.2.3 빌링키 등록 (`POST /api/payment/billing/register`)
- [ ] 토스 빌링키가 발급되는가?
- [ ] payment_methods 테이블에 저장되는가?
- [ ] 카드 정보가 마스킹되어 저장되는가?

#### 3.2.4 월 이용료 자동결제 (`POST /api/payment/billing/charge`)
- [ ] 빌링키로 결제가 되는가?
- [ ] 결제 금액이 ₩50,000인가?
- [ ] 결제 성공 시 next_billing_date가 +1개월 되는가?
- [ ] 결제 실패 시 failure_count가 증가하는가?
- [ ] 결제 실패 이메일이 발송되는가?

---

## 4. S4F1 검증: 관리자 대시보드

### 4.1 파일 존재 확인
```
[ ] pages/admin/dashboard.html
[ ] pages/admin/installation.html
[ ] pages/admin/payments.html
[ ] pages/admin/subscriptions.html
[ ] pages/admin/credits.html
[ ] admin-dashboard.js
[ ] admin-installation.js
[ ] admin.css
```

### 4.2 기능 검증

#### 4.2.1 대시보드 메인
- [ ] 관리자만 접근 가능한가?
- [ ] 총 사용자 수가 표시되는가?
- [ ] 활성 구독 수가 표시되는가?
- [ ] 월 매출이 표시되는가?
- [ ] 입금 대기 건수가 표시되는가?
- [ ] 입금 대기 시 긴급 알림이 표시되는가?

#### 4.2.2 설치비 관리 페이지
- [ ] 입금 대기 목록이 표시되는가?
- [ ] 입금코드가 표시되는가?
- [ ] 입금 확인 버튼이 동작하는가?
- [ ] 입금 확인 시 혜택 목록이 표시되는가?
  - 서비스 활성화
  - 초기 크레딧 ₩50,000 지급
  - 3개월 무료 기간 시작
  - 환영 이메일 발송

#### 4.2.3 결제 내역 페이지
- [ ] 크레딧 충전 내역이 표시되는가?
- [ ] 월 이용료 결제 내역이 표시되는가?
- [ ] 필터 (유형/상태/날짜)가 동작하는가?

---

## 5. S3F1 검증: 크레딧 부족 모달

### 5.1 파일 존재 확인
```
[ ] pages/ai/qa.html
[ ] ai-qa.js
[ ] ai-qa.css
```

### 5.2 기능 검증

#### 5.2.1 크레딧 부족 모달
- [ ] 크레딧 부족 시 모달이 표시되는가?
- [ ] 현재 잔액이 표시되는가?
- [ ] 필요 크레딧이 표시되는가?
- [ ] 충전 옵션 4개가 표시되는가? (₩10,000/₩20,000/₩30,000/₩50,000)
- [ ] 추천 뱃지가 ₩30,000에 표시되는가?
- [ ] 충전 버튼 클릭 시 토스페이먼츠로 연결되는가?
- [ ] "써니에게 묻기" 대안이 표시되는가?

---

## 6. 데이터베이스 검증

### 6.1 테이블 존재 확인
```sql
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
    'installation_deposits',
    'payment_methods',
    'payments',
    'toss_webhook_logs',
    'credit_transactions',
    'system_config',
    'bank_account_info'
);
```

### 6.2 시스템 설정 확인
```sql
SELECT key, value FROM system_config WHERE key IN (
    'INSTALLATION_FEE',
    'INITIAL_CREDIT',
    'FREE_PERIOD_MONTHS',
    'MONTHLY_FEE',
    'CREDIT_OPTIONS'
);
```

**예상 결과:**
| key | value |
|-----|-------|
| INSTALLATION_FEE | {"amount": 3000000, "currency": "KRW"} |
| INITIAL_CREDIT | {"amount": 50000, "currency": "KRW"} |
| FREE_PERIOD_MONTHS | {"months": 3} |
| MONTHLY_FEE | {"amount": 50000, "currency": "KRW"} |
| CREDIT_OPTIONS | {"options": [10000, 20000, 30000, 50000]} |

### 6.3 RLS 정책 확인
- [ ] installation_deposits: 본인 조회만 가능, 관리자 전체 접근
- [ ] payments: 본인 조회만 가능, 관리자 전체 접근
- [ ] credit_transactions: 본인 조회만 가능

---

## 7. 이메일 템플릿 검증 (S4BA6)

### 7.1 파일 존재 확인
```
[ ] /api/email/templates/installation-request.js
[ ] /api/email/templates/installation-confirmed.js
[ ] /api/email/templates/installation-rejected.js
[ ] /api/email/templates/credit-charged.js
[ ] /api/email/templates/billing-success.js
[ ] /api/email/templates/billing-failed.js
[ ] /api/email/templates/low-credit.js
[ ] /api/email/templates/billing-reminder.js
```

### 7.2 이메일 내용 검증
- [ ] 설치비 입금 안내: 계좌정보, 입금코드, 만료일 포함
- [ ] 서비스 활성화: 초기 크레딧 ₩50,000, 무료기간 3개월 안내
- [ ] 크레딧 충전: 충전 금액, 현재 잔액 표시
- [ ] 결제 실패: 재시도 안내, 결제수단 변경 링크

---

## 8. 통합 테스트 시나리오

### 시나리오 1: 신규 가입 ~ 서비스 활성화
```
1. 사용자 회원가입
2. 설치비 입금 요청 → 입금코드 발급
3. (수동) 무통장 입금
4. 관리자 입금 확인
5. 검증:
   - [ ] is_service_active = true
   - [ ] credit_balance = 50000
   - [ ] subscription_status = 'free_trial'
   - [ ] 환영 이메일 수신
```

### 시나리오 2: 크레딧 충전
```
1. 크레딧 충전 요청 (₩30,000)
2. 토스 결제창에서 결제
3. 콜백 처리
4. 검증:
   - [ ] credit_balance += 30000
   - [ ] payments 테이블에 기록
   - [ ] 충전 완료 이메일 수신
```

### 시나리오 3: 월 이용료 자동결제
```
1. 무료기간 종료 (3개월 후)
2. 빌링키로 자동결제
3. 검증:
   - [ ] 결제 금액 ₩50,000
   - [ ] next_billing_date += 1개월
   - [ ] payments 테이블에 기록
```

### 시나리오 4: 크레딧 부족 → 충전
```
1. AI 질문 시도 (잔액 부족)
2. 크레딧 부족 모달 표시
3. ₩30,000 충전 선택
4. 토스 결제
5. 충전 완료 후 AI 질문 재시도
6. 검증:
   - [ ] 크레딧 충전됨
   - [ ] AI 답변 정상 반환
```

---

## 9. 환경 변수 확인

```
# 무통장 입금 관련
BANK_NAME=기업은행
BANK_ACCOUNT=000-000000-00-000
BANK_HOLDER=SSALWorks

# 토스페이먼츠 관련
TOSS_CLIENT_KEY=test_ck_xxx
TOSS_SECRET_KEY=test_sk_xxx
TOSS_WEBHOOK_SECRET=xxx

# 이메일 관련
RESEND_API_KEY=re_xxx
```

---

## 10. 최종 체크리스트

### 필수 검증 항목
- [ ] 설치비가 정확히 ₩3,000,000인가?
- [ ] 초기 크레딧이 정확히 ₩50,000인가?
- [ ] 무료 기간이 정확히 3개월인가?
- [ ] 월 이용료가 정확히 ₩50,000인가?
- [ ] 크레딧 충전 옵션이 ₩10,000/₩20,000/₩30,000/₩50,000인가?
- [ ] 모든 이메일 템플릿이 올바르게 동작하는가?
- [ ] 관리자 대시보드에서 입금 확인이 가능한가?
- [ ] 크레딧 부족 모달에서 토스 결제로 연결되는가?

### 보안 검증 항목
- [ ] 토스 시크릿 키가 클라이언트에 노출되지 않는가?
- [ ] 관리자 API가 일반 사용자에게 차단되는가?
- [ ] 본인의 결제/크레딧 정보만 조회 가능한가?

---

## 검증 완료 서명

| 항목 | 검증자 | 날짜 | 결과 |
|------|--------|------|------|
| S4BA1 | | | ⏳ |
| S4BA2 | | | ⏳ |
| S4BA3 | | | ⏳ |
| S4BA6 | | | ⏳ |
| S4F1 | | | ⏳ |
| S3F1 | | | ⏳ |
| DB Schema | | | ⏳ |
| 통합 테스트 | | | ⏳ |
