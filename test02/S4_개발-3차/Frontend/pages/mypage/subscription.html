<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œë¹„ìŠ¤ ì´ìš© í˜„í™© - SSAL Works</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            --primary: #2C4A8A;
            --primary-dark: #1F3563;
            --secondary: #F59E0B;
            --secondary-dark: #D97706;
            --accent: #10B981;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 32px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .rice-logo {
            display: flex;
            align-items: center;
            gap: 3px;
            transform: rotate(-15deg);
        }

        .rice-grain {
            width: 10px;
            height: 18px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border-radius: 40%;
        }

        .rice-grain:nth-child(1) { transform: rotate(-5deg); }
        .rice-grain:nth-child(2) { transform: rotate(5deg); margin-top: 2px; }
        .rice-grain:nth-child(3) { transform: rotate(-3deg); margin-top: -1px; }

        .nav-logo-text { font-size: 28px; font-weight: 800; color: white; }

        .nav-links { display: flex; gap: 24px; align-items: center; }
        .nav-link { color: rgba(255,255,255,0.9); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-link:hover, .nav-link.active { color: white; }

        .close-btn {
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 32px 24px; }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--gray-500);
        }

        .breadcrumb a { color: var(--primary); text-decoration: none; }

        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 32px; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 700px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            text-align: center;
        }

        .stat-icon { font-size: 36px; margin-bottom: 12px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--gray-900); }
        .stat-label { font-size: 14px; color: var(--gray-500); margin-top: 4px; }

        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .card-title { font-size: 18px; font-weight: 600; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .info-grid { grid-template-columns: 1fr; }
        }

        .info-item {
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .info-label { font-size: 13px; color: var(--gray-500); margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; }

        .notice-box {
            margin-top: 20px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            color: var(--gray-500);
            font-size: 14px;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
        }

        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }

        .profile-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active { background: #D1FAE5; color: #065F46; }
        .badge-paused { background: #FEF3C7; color: #92400E; }
        .badge-free { background: var(--gray-100); color: var(--gray-700); }

        .btn-edit {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            font-size: 14px;
            background: var(--primary);
            color: white;
            transition: all 0.2s;
        }

        .btn-edit:hover { opacity: 0.9; }
        .btn-edit.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="../../index.html" class="nav-logo">
            <div class="rice-logo">
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
            </div>
            <span class="nav-logo-text">SSAL Works</span>
        </a>
        <div class="nav-links">
            <button class="close-btn" onclick="window.history.length > 1 ? history.back() : window.location.href='../../index.html'" title="ë‹«ê¸°">âœ• ë‹«ê¸°</button>
        </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="../../index.html">í™ˆ</a>
            <span>â€º</span>
            <span>My Page</span>
            <span>â€º</span>
            <span>ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©</span>
        </div>

        <h1 class="page-title">ğŸ“‹ ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©</h1>

        <!-- ì„œë¹„ìŠ¤ ì´ìš© í˜„í™© ë©”ì¸ ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©</h3>
            </div>

            <!-- 1. ì„œë¹„ìŠ¤ ìƒíƒœ -->
            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--gray-50); border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 28px;">ğŸ“‹</div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; color: var(--gray-500); margin-bottom: 4px;">ì„œë¹„ìŠ¤ ì´ìš© ìƒíƒœ</div>
                    <div style="font-weight: 600; font-size: 18px;">
                        <span class="profile-badge" id="serviceStatusBadge" style="font-size: 14px;">-</span>
                    </div>
                </div>
            </div>

            <!-- 2. ë¹Œë” ê³„ì • ê°œì„¤ë¹„ ì„¹ì…˜ -->
            <div style="padding: 16px; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: var(--gray-700);">ğŸ  ë¹Œë” ê³„ì • ê°œì„¤ë¹„</div>
                    <button class="btn-edit" id="installFeePayBtn" onclick="payInstallFee()" style="background: #2C4A8A;">
                        ğŸ’³ ì…ê¸ˆí•˜ê¸°
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="info-item">
                        <div class="info-label">ë‚©ë¶€ ìƒíƒœ</div>
                        <div class="info-value" id="installFeeStatusMain">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë‚©ë¶€ì¼</div>
                        <div class="info-value" id="installFeePaidDate">-</div>
                    </div>
                </div>
            </div>

            <!-- 3. ì´ìš©ë£Œ ì„¹ì…˜ -->
            <div style="padding: 16px; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: var(--gray-700);">ğŸ“… ì›” ì´ìš©ë£Œ</div>
                    <button class="btn-edit" id="autoPayBtn" onclick="setupAutoPay()" style="background: var(--primary);">
                        ğŸ”„ ìë™ ê²°ì œ ì„¤ì •
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="info-item">
                        <div class="info-label">ë¬´ë£Œ ì´ìš© ê¸°ê°„</div>
                        <div class="info-value" id="freePeriodRemaining">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë‹¤ìŒ ê²°ì œì¼</div>
                        <div class="info-value" id="nextPayDate">-</div>
                    </div>
                </div>
            </div>

            <!-- 4. ê²°ì œìˆ˜ë‹¨ ê´€ë¦¬ -->
            <div style="padding: 16px; border: 1px solid var(--gray-200); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-weight: 600; color: var(--gray-700);">ğŸ’³ ê²°ì œìˆ˜ë‹¨ ê´€ë¦¬</div>
                    <button class="btn-edit btn-secondary" onclick="changePaymentMethod()">
                        ê²°ì œìˆ˜ë‹¨ ë³€ê²½
                    </button>
                </div>
                <div class="info-item">
                    <div class="info-label">ë“±ë¡ëœ ê²°ì œìˆ˜ë‹¨</div>
                    <div class="info-value" id="paymentMethod">ë¯¸ë“±ë¡</div>
                </div>
            </div>
        </div>

        <!-- ì´ìš© ìš”ê¸ˆ ì•ˆë‚´ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ì´ìš© ìš”ê¸ˆ ì•ˆë‚´</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 24px;">ğŸ </div>
                        <div>
                            <div style="font-weight: 600;">ë¹Œë” ê³„ì • ê°œì„¤ë¹„</div>
                            <div style="font-size: 12px; color: var(--gray-500);">1íšŒ (ë¬´í†µì¥ ì…ê¸ˆ)</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--primary);">â‚©3,000,000</div>
                        <div style="font-size: 12px; color: var(--gray-500);" id="installFeeStatus">ë¯¸ë‚©</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 24px;">ğŸ“…</div>
                        <div>
                            <div style="font-weight: 600;">ì›” ì´ìš©ë£Œ</div>
                            <div style="font-size: 12px; color: var(--gray-500);">4ê°œì›”ì°¨ë¶€í„° ë‚©ë¶€</div>
                        </div>
                    </div>
                    <div style="font-weight: 700; color: var(--primary);">â‚©50,000/ì›”</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 24px;">ğŸ</div>
                        <div>
                            <div style="font-weight: 600;">ì´ˆê¸° ë¬´ë£Œ í¬ë ˆë”§</div>
                            <div style="font-size: 12px; color: var(--gray-500);">ë¹Œë” ê³„ì • ê°œì„¤ë¹„ ì…ê¸ˆ í™•ì¸ ì‹œ ìë™ ì§€ê¸‰</div>
                        </div>
                    </div>
                    <div style="font-weight: 700; color: var(--success);">â‚©50,000</div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 24px;">â°</div>
                        <div>
                            <div style="font-weight: 600;">ë¬´ë£Œ ì´ìš© ê¸°ê°„</div>
                            <div style="font-size: 12px; color: var(--gray-500);">ë¹Œë” ê³„ì • ê°œì„¤ë¹„ ì…ê¸ˆ í™•ì¸ í›„ 1~3ê°œì›”ì°¨</div>
                        </div>
                    </div>
                    <div style="font-weight: 700; color: var(--accent);">3ê°œì›”</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬´í†µì¥ ì…ê¸ˆ ëª¨ë‹¬ -->
    <div id="depositModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 20px; font-weight: 700;">ğŸ¦ ë¬´í†µì¥ ì…ê¸ˆ ì•ˆë‚´</h3>
                <button onclick="closeDepositModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500);">Ã—</button>
            </div>

            <div style="background: var(--gray-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-200);">
                    <span style="color: var(--gray-500);">ì…ê¸ˆ ì€í–‰</span>
                    <span style="font-weight: 600;">í•˜ë‚˜ì€í–‰</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-200);">
                    <span style="color: var(--gray-500);">ê³„ì¢Œë²ˆí˜¸</span>
                    <span style="font-weight: 600; font-family: monospace;">287-910921-40507</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-200);">
                    <span style="color: var(--gray-500);">ì˜ˆê¸ˆì£¼</span>
                    <span style="font-weight: 600;">ì„ ì›…ê·œ</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                    <span style="color: var(--gray-500);">ì…ê¸ˆ ê¸ˆì•¡</span>
                    <span style="font-weight: 700; color: var(--primary); font-size: 18px;" id="depositAmount">â‚©3,000,000</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">ì…ê¸ˆìëª…</label>
                <input type="text" id="depositorNameModal" placeholder="ì…ê¸ˆìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                    style="width: 100%; padding: 12px 16px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
            </div>

            <div style="background: #FEF3C7; border-radius: 8px; padding: 14px; margin-bottom: 24px;">
                <div style="font-size: 13px; color: #92400E;">
                    âš ï¸ ì…ê¸ˆ í›„ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì…ê¸ˆ ì™„ë£Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button onclick="closeDepositModal()" style="flex: 1; padding: 14px; border: 1px solid var(--gray-300); border-radius: 8px; background: white; font-weight: 600; cursor: pointer;">
                    ì·¨ì†Œ
                </button>
                <button onclick="submitDepositNotification()" style="flex: 2; padding: 14px; border: none; border-radius: 8px; background: #2C4A8A; color: white; font-weight: 600; cursor: pointer;">
                    âœ“ ì…ê¸ˆ ì™„ë£Œ í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const SUPABASE_URL = 'https://zwjmfewyshhwpgwdtrus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3am1mZXd5c2hod3Bnd2R0cnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzE1NTEsImV4cCI6MjA3OTE0NzU1MX0.AJy34h5VR8QS6WFEcUcBeJJu8I3bBQ6UCk1I84Wb7y4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userData = null;

        document.addEventListener('DOMContentLoaded', checkAuth);

        async function checkAuth() {
            showLoading();
            // ì„¤ì¹˜ë¹„ ì •ë³´ ë¨¼ì € ë¡œë“œ (ë³‘ë ¬)
            loadInstallationInfo();
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error || !session) {
                    console.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ');
                    showSampleData();
                    hideLoading();
                    return;
                }
                currentUser = session.user;
                await loadUserData();
            } catch (error) {
                console.log('ì¸ì¦ í™•ì¸ ì‹¤íŒ¨ - ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ');
                showSampleData();
            } finally {
                hideLoading();
            }
        }

        function showSampleData() {
            // ì„œë¹„ìŠ¤ ìƒíƒœ
            const badge = document.getElementById('serviceStatusBadge');
            badge.textContent = 'ë¬´ë£Œ ì²´í—˜';
            badge.className = 'profile-badge badge-free';

            // ë¹Œë” ê³„ì • ê°œì„¤ë¹„
            document.getElementById('installFeeStatusMain').textContent = 'ë¯¸ë‚©';
            document.getElementById('installFeeStatusMain').style.color = 'var(--warning)';
            document.getElementById('installFeePaidDate').textContent = '-';

            // ì›” ì´ìš©ë£Œ
            document.getElementById('freePeriodRemaining').textContent = '-';
            document.getElementById('nextPayDate').textContent = '-';

            // ê²°ì œìˆ˜ë‹¨
            document.getElementById('paymentMethod').textContent = 'ë¯¸ë“±ë¡';

            // ì´ìš© ìš”ê¸ˆ ì•ˆë‚´ - ê°œì„¤ë¹„ ìƒíƒœ
            document.getElementById('installFeeStatus').textContent = 'ë¯¸ë‚©';
            document.getElementById('installFeeStatus').style.color = 'var(--warning)';
        }

        async function loadUserData() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                userData = data;
                renderSubscription();
            } catch (error) {
                showToast('ì„œë¹„ìŠ¤ ì´ìš© í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function renderSubscription() {
            if (!userData) return;

            // 1. ì„œë¹„ìŠ¤ ìƒíƒœ ë°°ì§€
            const badge = document.getElementById('serviceStatusBadge');
            const statusText = getStatusText(userData.subscription_status);
            badge.textContent = statusText;
            badge.className = 'profile-badge ' + getBadgeClass(userData.subscription_status);

            // 2. ë¹Œë” ê³„ì • ê°œì„¤ë¹„
            const installText = userData.installation_fee_paid ? 'ì™„ë£Œ' : 'ë¯¸ë‚©';
            const installFeeMain = document.getElementById('installFeeStatusMain');
            installFeeMain.textContent = installText;
            installFeeMain.style.color = userData.installation_fee_paid ? 'var(--success)' : 'var(--warning)';

            document.getElementById('installFeePaidDate').textContent = formatDate(userData.installation_date) || '-';

            // 3. ë¬´ë£Œ ì´ìš© ê¸°ê°„ & ë‹¤ìŒ ê²°ì œì¼ ê³„ì‚°
            if (userData.installation_fee_paid && userData.installation_date) {
                const installDate = new Date(userData.installation_date);
                const freeEndDate = new Date(installDate);
                freeEndDate.setMonth(freeEndDate.getMonth() + 3);

                const today = new Date();
                const daysRemaining = Math.ceil((freeEndDate - today) / (1000 * 60 * 60 * 24));

                if (daysRemaining > 0) {
                    document.getElementById('freePeriodRemaining').textContent = `${daysRemaining}ì¼ ë‚¨ìŒ`;
                    document.getElementById('freePeriodRemaining').style.color = 'var(--success)';
                } else {
                    document.getElementById('freePeriodRemaining').textContent = 'ì¢…ë£Œ';
                    document.getElementById('freePeriodRemaining').style.color = 'var(--gray-500)';
                }

                document.getElementById('nextPayDate').textContent = formatDate(freeEndDate);
            } else {
                document.getElementById('freePeriodRemaining').textContent = '-';
                document.getElementById('nextPayDate').textContent = '-';
            }

            // 4. ê²°ì œìˆ˜ë‹¨
            const paymentMethod = userData.payment_method || 'ë¯¸ë“±ë¡';
            document.getElementById('paymentMethod').textContent = paymentMethod;

            // ë‚©ë¶€í•˜ê¸° ë²„íŠ¼ ìˆ¨ê¹€ (ì´ë¯¸ ë‚©ë¶€ ì™„ë£Œ ì‹œ)
            if (userData.installation_fee_paid) {
                document.getElementById('installFeePayBtn').style.display = 'none';
            }

            // 5. ì´ìš© ìš”ê¸ˆ ì•ˆë‚´ - ê°œì„¤ë¹„ ìƒíƒœ
            const installFeeStatus = document.getElementById('installFeeStatus');
            installFeeStatus.textContent = userData.installation_fee_paid ? 'ë‚©ë¶€ ì™„ë£Œ' : 'ë¯¸ë‚©';
            installFeeStatus.style.color = userData.installation_fee_paid ? 'var(--success)' : 'var(--warning)';
        }

        function getBadgeClass(status) {
            const map = {
                'free': 'badge-free',
                'active': 'badge-active',
                'paused': 'badge-paused',
                'suspended': 'badge-paused',
                'cancelled': 'badge-paused'
            };
            return map[status] || 'badge-free';
        }

        let currentDepositType = 'install_fee'; // install_fee or credit
        let currentDepositAmount = 3000000;
        let installationFeeAmount = 3000000; // admin_settingsì—ì„œ ê°€ì ¸ì˜¨ ê°’

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì¹˜ë¹„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function loadInstallationInfo() {
            try {
                const res = await fetch('/api/Backend_APIs/payment/installation/info');
                const data = await res.json();
                if (data.success && data.installation_fee) {
                    installationFeeAmount = data.installation_fee.amount;
                }
            } catch (e) {
                console.log('Installation info fetch failed, using default');
            }
        }

        // ë¹Œë” ê³„ì • ê°œì„¤ë¹„ ë‚©ë¶€í•˜ê¸°
        function payInstallFee() {
            currentDepositType = 'install_fee';
            currentDepositAmount = installationFeeAmount;
            document.getElementById('depositAmount').textContent = 'â‚©' + installationFeeAmount.toLocaleString();
            openDepositModal();
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openDepositModal() {
            document.getElementById('depositModal').style.display = 'flex';
            document.getElementById('depositorNameModal').value = '';
        }

        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }

        // ì…ê¸ˆ ì™„ë£Œ ì•Œë¦¼ ì œì¶œ
        async function submitDepositNotification() {
            const depositorName = document.getElementById('depositorNameModal').value.trim();
            if (!depositorName) {
                showToast('ì…ê¸ˆìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showLoading();
            try {
                // deposit_notifications í…Œì´ë¸”ì— ì €ì¥
                const { error } = await supabaseClient
                    .from('deposit_notifications')
                    .insert({
                        user_id: currentUser?.id || 'GUEST',
                        deposit_type: currentDepositType,
                        amount: currentDepositAmount,
                        depositor_name: depositorName,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                // ê´€ë¦¬ìì—ê²Œ ì…ê¸ˆ í™•ì¸ ìš”ì²­ ì•Œë¦¼ ë°œì†¡ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
                fetch('/api/Backend_APIs/admin-notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'installation_request',
                        data: {
                            email: currentUser?.email || 'Unknown',
                            depositor_name: depositorName,
                            amount: currentDepositAmount
                        }
                    })
                }).catch(err => console.log('Admin notify skipped:', err));

                closeDepositModal();
                showToast('ì…ê¸ˆ ì™„ë£Œ í™•ì¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì…ê¸ˆ ì•Œë¦¼ ì €ì¥ ì‹¤íŒ¨:', error);
                showToast('ì…ê¸ˆ ì•Œë¦¼ ì ‘ìˆ˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            } finally {
                hideLoading();
            }
        }

        // ì›” ì´ìš©ë£Œ ìë™ ê²°ì œ ì„¤ì • (í† ìŠ¤í˜ì´ë¨¼ì¸ )
        function setupAutoPay() {
            alert('ìë™ ê²°ì œ ì„¤ì •\n\n' +
                  'í† ìŠ¤í˜ì´ë¨¼ì¸ ë¥¼ í†µí•œ ìë™ ê²°ì œ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n' +
                  '(ì¶”í›„ êµ¬í˜„ ì˜ˆì •)');
        }

        // ê²°ì œìˆ˜ë‹¨ ë³€ê²½
        function changePaymentMethod() {
            alert('ê²°ì œìˆ˜ë‹¨ ë³€ê²½\n\n' +
                  'í† ìŠ¤í˜ì´ë¨¼ì¸ ë¥¼ í†µí•œ ê²°ì œìˆ˜ë‹¨ ë³€ê²½ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n' +
                  '(ì¶”í›„ êµ¬í˜„ ì˜ˆì •)');
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        function getStatusText(status) {
            const map = { 'free': 'ë¬´ë£Œ', 'active': 'í™œì„±', 'paused': 'ì¼ì‹œì •ì§€', 'suspended': 'ì •ì§€', 'cancelled': 'í•´ì§€' };
            return map[status] || 'ë¬´ë£Œ';
        }

        function formatDate(d) { return d ? new Date(d).toLocaleDateString('ko-KR') : null; }
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
