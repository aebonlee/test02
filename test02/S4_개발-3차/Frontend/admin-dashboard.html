<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSAL Works Admin - Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/responsive.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Main Theme - Purple (Header, Main Elements) */
            --primary: #6B5CCC;
            --primary-dark: #5847B3;

            /* Secondary Theme - Orange (Buttons, Actions) */
            --secondary: #CC785C;
            --secondary-dark: #B35A44;

            /* Status Colors */
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0099ff;
            --neutral: #6c757d;

            /* Background */
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #dee2e6;

            /* Misc */
            --border-radius: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Noto Sans KR', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #212529;
            background: var(--bg-light);
            padding: 0 20px;
        }

        /* ========== Layout Grid ========== */
        .layout-container {
            display: grid;
            grid-template-columns: 180px 1fr;
            grid-template-rows: 70px 1fr 60px;
            min-height: 100vh;
            gap: 0;
            max-width: 1800px;
            margin: 0 auto;
            box-shadow: 0 0 40px rgba(0,0,0,0.15);
        }

        /* ========== Header ========== */
        .header {
            grid-column: 1 / 3;
            grid-row: 1;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            box-shadow: var(--shadow-md);
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rice-logo {
            display: flex;
            align-items: center;
            gap: 3px;
            transform: rotate(-15deg);
        }

        .rice-grain {
            width: 7px;
            height: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            border-radius: 40%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: inline-block;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-title-main {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-title-sub {
            font-size: 11px;
            opacity: 0.85;
            font-weight: 400;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-badge {
            background: var(--secondary);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ========== Left Sidebar ========== */
        .sidebar {
            grid-column: 1;
            grid-row: 2;
            background: white;
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
        }

        .sidebar-close-btn {
            display: none;
        }

        .menu-section {
            margin-bottom: 24px;
        }

        .menu-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #868e96;
            padding: 0 16px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #f8f9fa;
            color: var(--primary);
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(107,92,204,0.1) 0%, transparent 100%);
            color: var(--primary);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .menu-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        /* ========== Main Content ========== */
        .main-content {
            grid-column: 2;
            grid-row: 2;
            background: var(--bg-light);
            overflow-y: auto;
            padding: 32px;
        }

        .content-header {
            margin-bottom: 24px;
        }

        .content-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .content-subtitle {
            font-size: 14px;
            color: #6c757d;
        }

        /* ========== Stats Cards ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stats-grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .stat-card.primary { border-left-color: var(--primary); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }

        /* ========== Content Sections ========== */
        .content-section {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .section-action {
            padding: 6px 14px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .section-action:hover {
            background: var(--secondary-dark);
        }

        /* ========== Table ========== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8f9fa;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid var(--border-color);
        }

        .data-table td {
            padding: 12px;
            font-size: 13px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.answered {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 12px;
        }

        .action-link:hover {
            text-decoration: underline;
        }

        /* ========== Footer ========== */
        .footer {
            grid-column: 1 / 3;
            grid-row: 3;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 32px;
            font-size: 12px;
            gap: 8px;
            position: relative;
        }

        .footer-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
            transition: color 0.2s;
            font-size: 13px;
            font-weight: 500;
        }

        .footer-link:hover {
            color: white;
        }

        .footer-copyright {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            opacity: 0.7;
        }

        .home-link {
            position: absolute;
            right: 32px;
            bottom: 12px;
            opacity: 0.15;
            font-size: 9px;
            transition: opacity 0.3s;
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }

        .home-link:hover {
            opacity: 0.6;
        }

        /* ========== Form Styles ========== */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .form-modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .form-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .form-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-btn-primary {
            background: var(--primary);
            color: white;
        }

        .form-btn-primary:hover {
            background: var(--primary-dark);
        }

        .form-btn-secondary {
            background: var(--neutral);
            color: white;
        }

        .form-btn-secondary:hover {
            background: #5a6268;
        }

        /* ========== Filter Buttons (FAQ Category) ========== */
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            background: white;
            color: #495057;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f8f9fa;
        }

        .filter-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* ========== Responsive Design (Mobile) ========== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .layout-container {
                grid-template-columns: 1fr;
                grid-template-rows: 70px auto 60px;
                box-shadow: none;
            }

            .sidebar {
                position: fixed !important;
                left: -280px;
                top: 0;
                width: 280px !important;
                height: 100vh;
                background: white;
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 2px 0 10px rgba(0,0,0,0.15);
                padding: 70px 0 20px 0;
                display: block;
            }

            .sidebar.open {
                left: 0 !important;
            }

            .sidebar-close-btn {
                position: absolute;
                top: 16px;
                right: 16px;
                width: 36px;
                height: 36px;
                border: none;
                background: #f3f4f6;
                border-radius: 50%;
                font-size: 18px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #374151;
                z-index: 10;
            }

            .sidebar-close-btn:hover {
                background: #e5e7eb;
            }

            .menu-section {
                display: block;
                margin-bottom: 16px;
                padding: 0 16px;
            }

            .menu-section-title {
                display: block;
                font-size: 12px;
                color: var(--neutral);
                margin-bottom: 8px;
            }

            .menu-item {
                display: block;
                padding: 10px 12px;
                font-size: 13px;
                border-radius: 6px;
                margin-bottom: 4px;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                grid-column: 1;
                grid-row: 2;
                padding: 16px;
            }

            .header {
                grid-column: 1;
                padding: 0 16px;
            }

            .header-title-main {
                font-size: 18px;
            }

            .header-title-sub {
                font-size: 10px;
            }

            .admin-badge {
                display: none;
            }

            .user-info span {
                display: none;
            }

            .footer {
                grid-column: 1;
                grid-row: 3;
                padding: 8px 16px;
            }

            .footer-links {
                flex-direction: column;
                gap: 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 20px;
            }

            .stats-grid-5 {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-icon {
                font-size: 22px;
                margin-bottom: 8px;
            }

            /* ÏΩòÌÖêÏ∏† ÏÑπÏÖò */
            .content-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .section-title {
                font-size: 16px;
            }

            .section-action {
                width: 100%;
                padding: 10px 14px;
                text-align: center;
            }

            /* ÌÖåÏù¥Î∏î Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            .data-table {
                font-size: 12px;
                min-width: 600px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            .data-table th:first-child,
            .data-table td:first-child {
                position: sticky;
                left: 0;
                background: white;
                z-index: 1;
            }

            .data-table thead th:first-child {
                background: #f8f9fa;
            }

            /* Ìèº Î™®Îã¨ */
            .form-modal {
                width: 95%;
                max-height: 90vh;
                padding: 20px;
                overflow-y: auto;
            }

            .form-modal h3 {
                font-size: 18px;
            }

            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                padding: 12px;
            }

            .form-btn {
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px;
            }

            /* Î≤ÑÌäº ÌÑ∞Ïπò ÏπúÌôîÏ†Å */
            button, .btn {
                min-height: 44px;
            }

            .tree-btn {
                min-width: 36px;
                min-height: 36px;
                padding: 8px;
            }

            /* ÏÉÅÌÉú Î±ÉÏßÄ */
            .status-badge {
                font-size: 10px;
                padding: 4px 8px;
            }

            /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
            .tab-nav {
                flex-wrap: wrap;
                gap: 8px;
            }

            .tab-btn {
                flex: 1 1 auto;
                min-width: 80px;
                padding: 10px 12px;
                font-size: 12px;
                text-align: center;
            }

            /* Ï∞®Ìä∏ ÏòÅÏó≠ */
            .chart-container {
                height: 250px !important;
            }

            /* Í≤ÄÏÉâ/ÌïÑÌÑ∞ ÏòÅÏó≠ */
            .filter-row, .search-row {
                flex-direction: column;
                gap: 12px;
            }

            .filter-row input,
            .filter-row select,
            .search-row input {
                width: 100%;
            }

            /* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */
            .pagination {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            .pagination button {
                min-width: 40px;
                min-height: 40px;
            }

            /* Ïπ¥Îìú Í∑∏Î¶¨Îìú */
            .card-grid {
                grid-template-columns: 1fr;
            }

            /* 2Ïó¥ Í∑∏Î¶¨Îìú ‚Üí 1Ïó¥ */
            .dual-section-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            /* stat-card-enhanced Î™®Î∞îÏùº */
            .stat-card-enhanced {
                gap: 8px;
            }

            .stat-header {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .stat-change, .stat-urgent {
                font-size: 12px;
            }

            .change-value, .urgent-badge {
                font-size: 11px;
            }

            /* ÌôúÎèô ÌÉÄÏûÑÎùºÏù∏ */
            .activity-timeline {
                max-height: 300px;
                overflow-y: auto;
            }

            .activity-item {
                padding: 12px;
                font-size: 13px;
            }

            /* ÏΩòÌÖêÏ∏† Ìó§Îçî */
            .content-header {
                margin-bottom: 16px;
            }

            .content-title {
                font-size: 20px;
            }

            .content-subtitle {
                font-size: 13px;
            }

            /* ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º */
            .toast {
                left: 16px;
                right: 16px;
                min-width: auto;
            }
        }

        /* ÏïÑÏ£º ÏûëÏùÄ ÌôîÎ©¥ (480px Ïù¥Ìïò) */
        @media (max-width: 480px) {
            .stats-grid-5 {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 20px;
            }

            .data-table {
                font-size: 11px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }

            .section-title {
                font-size: 14px;
            }

            .content-title {
                font-size: 18px;
            }

            .form-modal {
                width: 100%;
                border-radius: 0;
                max-height: 100vh;
            }
        }

        /* ========== Toast Notification ========== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 9999;
            min-width: 280px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--danger);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-info {
            border-left: 4px solid var(--info);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }

        /* ========== Loading Spinner ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        /* ========== Screen Reader Only ========== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ========== Learning Content Tree ========== */
        .learning-tree {
            font-size: 14px;
        }

        .tree-depth1 {
            margin-bottom: 8px;
        }

        .tree-depth2 {
            margin-left: 24px;
            margin-top: 4px;
        }

        .tree-depth3 {
            margin-left: 24px;
            margin-top: 2px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tree-item:hover {
            background: #f8f9fa;
        }

        .depth1-item {
            background: #f0f0ff;
            border-left: 4px solid var(--primary);
            font-weight: 600;
        }

        .depth1-item:hover {
            background: #e8e8ff;
        }

        .depth2-item {
            background: #f8f9fa;
            border-left: 3px solid var(--success);
            font-weight: 500;
        }

        .depth2-item:hover {
            background: #e9ecef;
        }

        .depth3-item {
            background: white;
            border: 1px solid #e9ecef;
            font-weight: 400;
        }

        .depth3-item:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }

        .tree-arrow {
            font-size: 10px;
            color: #6c757d;
            transition: transform 0.2s;
            width: 12px;
        }

        .tree-arrow.open {
            transform: rotate(90deg);
        }

        .tree-icon {
            font-size: 16px;
        }

        .tree-name {
            flex: 1;
        }

        .tree-link-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 8px;
        }

        .tree-link-status.linked {
            background: #d4edda;
            color: #155724;
        }

        .tree-link-status.not-linked {
            background: #fff3cd;
            color: #856404;
        }

        .tree-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-item:hover .tree-actions {
            opacity: 1;
        }

        .tree-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tree-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .tree-btn.edit:hover {
            background: #1976d2;
            color: white;
        }

        .tree-btn.add {
            background: #e8f5e9;
            color: #388e3c;
        }

        .tree-btn.add:hover {
            background: #388e3c;
            color: white;
        }

        .tree-btn.delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .tree-btn.delete:hover {
            background: #d32f2f;
            color: white;
        }

        .tree-btn.link {
            background: #fff3e0;
            color: #f57c00;
        }

        .tree-btn.link:hover {
            background: #f57c00;
            color: white;
        }

        .tree-btn.move {
            background: #f5f5f5;
            color: #616161;
        }

        .tree-btn.move:hover {
            background: #616161;
            color: white;
        }

        .tree-children {
            overflow: hidden;
        }

        /* ========== Admin Home Dashboard Enhancements ========== */

        /* Enhanced Stat Cards with Change Indicators */
        .stat-card-enhanced {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .stat-header .stat-icon {
            font-size: 20px;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-change.up {
            color: var(--success);
        }

        .stat-change.down {
            color: var(--danger);
        }

        .change-arrow {
            font-size: 14px;
            font-weight: 700;
        }

        .change-value {
            font-weight: 700;
        }

        .change-period {
            color: #6c757d;
            font-weight: 500;
        }

        .stat-urgent {
            margin-top: 4px;
        }

        .urgent-badge {
            display: inline-block;
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        /* Dual Section Grid (Activity + Urgent Tasks) */
        .dual-section-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
        }

        /* Activity Timeline */
        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 3px solid #e9ecef;
            transition: all 0.2s;
        }

        .activity-item:hover {
            background: #f8f9fa;
            box-shadow: var(--shadow-sm);
            transform: translateX(2px);
        }

        .activity-item.urgent {
            border-left-color: var(--danger);
            background: rgba(220, 53, 69, 0.03);
        }

        .activity-item.warning {
            border-left-color: var(--warning);
        }

        .activity-item.normal {
            border-left-color: var(--success);
        }

        .activity-icon {
            font-size: 18px;
            line-height: 1;
        }

        .activity-content {
            flex: 1;
        }

        .activity-message {
            font-size: 14px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: #6c757d;
        }

        /* Urgent Tasks List */
        .urgent-tasks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .urgent-task {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }

        .urgent-task:hover {
            background: #f8f9fa;
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .urgent-task.high {
            border-left: 4px solid var(--danger);
            background: rgba(220, 53, 69, 0.03);
        }

        .urgent-task.medium {
            border-left: 4px solid var(--warning);
        }

        .urgent-task-icon {
            font-size: 20px;
        }

        .urgent-task-content {
            flex: 1;
        }

        .urgent-task-title {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .urgent-task-count {
            font-size: 12px;
            color: #6c757d;
        }

        .urgent-task-arrow {
            font-size: 18px;
            color: #adb5bd;
            transition: all 0.2s;
        }

        .urgent-task:hover .urgent-task-arrow {
            color: var(--primary);
            transform: translateX(4px);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
        }

        .chart-container {
            min-height: 350px;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        .section-subtitle {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±/ÏàòÏ†ï Î™®Îã¨ -->
    <div id="noticeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="padding: 24px; border-bottom: 1px solid var(--border-color);">
                <h2 style="margin: 0; color: var(--primary);" id="noticeModalTitle">üìù Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±</h2>
            </div>
            <div style="padding: 24px;">
                <form id="noticeForm" onsubmit="handleNoticeSubmit(event)">
                    <!-- Ï§ëÏöîÎèÑ ÏÑ†ÌÉù -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Ï§ëÏöîÎèÑ</label>
                        <div style="display: flex; gap: 12px;">
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="importance" value="important" style="margin-right: 6px;">
                                <span style="color: #dc3545; font-weight: 600;">üî¥ Ï§ëÏöî</span>
                            </label>
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="importance" value="normal" checked style="margin-right: 6px;">
                                <span style="color: #6c757d;">ÏùºÎ∞ò</span>
                            </label>
                        </div>
                    </div>

                    <!-- Ï†úÎ™© -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Ï†úÎ™© *</label>
                        <input type="text" id="noticeTitle" required
                               style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                               placeholder="Í≥µÏßÄÏÇ¨Ìï≠ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    </div>

                    <!-- ÎÇ¥Ïö© -->
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">ÎÇ¥Ïö© *</label>
                        <textarea id="noticeContent" required rows="8"
                                  style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;"
                                  placeholder="Í≥µÏßÄÏÇ¨Ìï≠ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>

                    <!-- Î≤ÑÌäº -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" onclick="closeNoticeModal()"
                                style="padding: 12px 24px; background: var(--neutral); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Ï∑®ÏÜå
                        </button>
                        <button type="submit"
                                style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="layout-container">
        <!-- Header -->
        <header class="header">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                <div class="rice-logo">
                    <span class="rice-grain"></span>
                    <span class="rice-grain"></span>
                    <span class="rice-grain"></span>
                </div>
                <div class="header-title">
                    <div class="header-title-main">SSAL Works Admin</div>
                    <div class="header-title-sub">Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú</div>
                </div>
            </a>
            <div class="header-right">
                <div class="admin-badge">üë®‚Äçüíº Í¥ÄÎ¶¨Ïûê</div>
                <div class="user-info">
                    <div class="user-avatar">Ïç®Îãà</div>
                    <span style="font-size: 14px; font-weight: 500;">Ïç®ÎãàÎãò</span>
                </div>
                <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>
        </header>

        <!-- Left Sidebar -->
        <aside class="sidebar">
            <button class="sidebar-close-btn" onclick="closeSidebar()">‚úï</button>
            <div class="menu-section">
                <div class="menu-section-title">Î©îÏù∏</div>
                <div class="menu-item active" onclick="showSection('overview', event)">
                    üìä ÎåÄÏãúÎ≥¥Îìú Í∞úÏöî
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Ïª®ÌÖêÏ∏† Í¥ÄÎ¶¨</div>
                <div class="menu-item" onclick="showSection('notice', event)">
                    üì¢ Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">ÌöåÏõê/Í≤∞Ï†ú</div>
                <div class="menu-item" onclick="showSection('users', event)">
                    üë• ÌöåÏõê Í¥ÄÎ¶¨
                </div>
                <div class="menu-item" onclick="showSection('installation', event)">
                    üè† ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Í¥ÄÎ¶¨
                    <span class="menu-badge" id="installationPendingBadge" style="display:none;">0</span>
                </div>
                <div class="menu-item" onclick="showSection('subscription', event)">
                    üìÖ ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Í¥ÄÎ¶¨
                </div>
                <div class="menu-item" onclick="showSection('credit', event)">
                    ü™ô ÌÅ¨Î†àÎîß Í¥ÄÎ¶¨
                </div>
                <div class="menu-item" onclick="showSection('api', event)">
                    üîå API ÏÇ¨Ïö©Îüâ/ÏõêÍ∞Ä
                </div>
                <div class="menu-item" onclick="showSection('projects', event)">
                    üìÅ ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨
                </div>
                <div class="menu-item" onclick="showSection('inquiries', event)">
                    üí¨ Í≥†Í∞ùÏÑºÌÑ∞ Î¨∏Ïùò
                    <span class="menu-badge" id="inquiryBadge" style="display: none;">0</span>
                </div>
                <div class="menu-item" onclick="showSection('sunny-inquiries', event)">
                    ‚òÄÔ∏è SunnyÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ∏∞
                    <span class="menu-badge" id="sunnyInquiryBadge" style="display: none;">0</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">ÏãúÏä§ÌÖú</div>
                <div class="menu-item" onclick="showSection('settings', event)">
                    ‚öôÔ∏è ÏÑ§Ï†ï
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <div id="overview-section" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">üè† ÎåÄÏãúÎ≥¥Îìú Ìôà</h1>
                    <p class="content-subtitle">ÏïàÎÖïÌïòÏÑ∏Ïöî, Ïç®ÎãàÎãò! üëã Ïò§ÎäòÏùò Ï†ÑÏ≤¥ ÌòÑÌô©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- Stats Grid with Change Indicators -->
                <div class="stats-grid">
                    <div class="stat-card stat-card-enhanced primary">
                        <div class="stat-header">
                            <span class="stat-icon">üë•</span>
                            <span class="stat-label">Ï¥ù ÌöåÏõê Ïàò</span>
                        </div>
                        <div class="stat-value" id="overviewTotalUsers">-</div>
                        <div class="stat-change">
                            <span class="change-value" id="overviewUserChange">-</span>
                        </div>
                    </div>
                    <div class="stat-card stat-card-enhanced success">
                        <div class="stat-header">
                            <span class="stat-icon">üí∞</span>
                            <span class="stat-label">Ïù¥Î≤à Îã¨ Îß§Ï∂ú</span>
                        </div>
                        <div class="stat-value" id="overviewMonthlyRevenue">-</div>
                        <div class="stat-change">
                            <span class="change-value" id="overviewRevenueChange">-</span>
                        </div>
                    </div>
                    <div class="stat-card stat-card-enhanced warning">
                        <div class="stat-header">
                            <span class="stat-icon">ü™ô</span>
                            <span class="stat-label">ÌÅ¨Î†àÎîß ÌåêÎß§</span>
                        </div>
                        <div class="stat-value" id="overviewCreditSales">-</div>
                        <div class="stat-change">
                            <span class="change-value" id="overviewCreditChange">-</span>
                        </div>
                    </div>
                    <div class="stat-card stat-card-enhanced danger">
                        <div class="stat-header">
                            <span class="stat-icon">üìû</span>
                            <span class="stat-label">Í≥†Í∞ùÏÑºÌÑ∞ Î¨∏Ïùò</span>
                        </div>
                        <div class="stat-value" id="overviewPendingInquiries">-</div>
                        <div class="stat-urgent">
                            <span class="urgent-badge" id="overviewUrgentCount">-</span>
                        </div>
                    </div>
                    <div class="stat-card stat-card-enhanced warning">
                        <div class="stat-header">
                            <span class="stat-icon">‚òÄÔ∏è</span>
                            <span class="stat-label">SunnyÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ∏∞</span>
                        </div>
                        <div class="stat-value" id="overviewSunnyPending">-</div>
                        <div class="stat-urgent">
                            <span class="urgent-badge" id="overviewSunnyCount">-</span>
                        </div>
                    </div>
                </div>

                <!-- Activity and Urgent Tasks Row -->
                <div class="dual-section-grid">
                    <!-- Recent Activity Timeline -->
                    <div class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">üìã ÏµúÍ∑º ÌôúÎèô</h2>
                            <span class="section-subtitle">Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏</span>
                        </div>
                        <div class="activity-timeline" id="activityTimeline">
                            <div style="text-align: center; color: #999; padding: 40px;">
                                ÌôúÎèô ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
                            </div>
                        </div>
                    </div>

                    <!-- Urgent Tasks -->
                    <div class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">‚ö†Ô∏è Í∏¥Í∏â Ï≤òÎ¶¨ ÌïÑÏöî</h2>
                            <span class="section-subtitle">Ïö∞ÏÑ†ÏàúÏúÑ Ïàú</span>
                        </div>
                        <div class="urgent-tasks-list" id="urgentTasksList">
                            <div style="text-align: center; color: #999; padding: 40px;">
                                Í∏¥Í∏â Ï≤òÎ¶¨ Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-grid">
                    <div class="content-section chart-container">
                        <div class="section-header">
                            <h2 class="section-title">üìà ÌöåÏõê Í∞ÄÏûÖ Ï∂îÏù¥</h2>
                            <span class="section-subtitle">ÏµúÍ∑º 7Ïùº</span>
                        </div>
                        <canvas id="memberSignupChart" style="height: 300px;"></canvas>
                    </div>
                    <div class="content-section chart-container">
                        <div class="section-header">
                            <h2 class="section-title">üí∞ Îß§Ï∂ú Ï∂îÏù¥</h2>
                            <span class="section-subtitle">ÏµúÍ∑º 4Ï£º</span>
                        </div>
                        <canvas id="revenueChart" style="height: 300px;"></canvas>
                    </div>
                </div>

            </div>

            <!-- Notice Section -->
            <div id="notice-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üì¢ Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌëúÏãúÎê† Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-value" id="noticeCountTotal">0</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ Í≥µÏßÄ</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="noticeCountPublished">0</div>
                        <div class="stat-label">Í≤åÏãú Ï§ë</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="noticeCountImportant">0</div>
                        <div class="stat-label">Ï§ëÏöî Í≥µÏßÄ</div>
                    </div>
                </div>

                <!-- Í≥µÏßÄÏÇ¨Ìï≠ Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã Í≥µÏßÄÏÇ¨Ìï≠ Î™©Î°ù</h2>
                        <button class="section-action" onclick="showNoticeForm()">+ ÏÉà Í≥µÏßÄ Ï∂îÍ∞Ä</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ï§ëÏöîÎèÑ</th>
                                <th>Ï†úÎ™©</th>
                                <th>Í≤åÏãúÏùº</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>Ï°∞ÌöåÏàò</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="noticesTableBody">
                            <!-- SupabaseÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê® -->
                            <tr>
                                <td colspan="6" style="text-align:center; padding: 40px; color: #999;">
                                    Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Inquiries Section -->
            <div id="inquiries-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üí¨ Î¨∏Ïùò Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">Í≥†Í∞ùÏÑºÌÑ∞ Î¨∏ÏùòÎ•º ÌôïÏù∏ÌïòÍ≥† ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- Ïª®Ìä∏Î°§ Î≥¥Îìú -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üì¨</div>
                        <div class="stat-value" id="inquiriesTotalCount">-</div>
                        <div class="stat-label">Ï¥ù Ï†ëÏàò</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-value" id="inquiriesPendingCount">-</div>
                        <div class="stat-label">ÎåÄÍ∏∞ Ï§ë</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="inquiriesInProgressCount">-</div>
                        <div class="stat-label">Ï≤òÎ¶¨ Ï§ë</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="inquiriesAnsweredCount">-</div>
                        <div class="stat-label">ÎãµÎ≥Ä ÏôÑÎ£å</div>
                    </div>
                </div>

                <!-- Î¨∏Ïùò Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã Î¨∏Ïùò Î™©Î°ù</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="section-action" id="btnInquiryAll" style="background: var(--primary);" onclick="filterInquiries('all')">Ï†ÑÏ≤¥</button>
                            <button class="section-action" id="btnInquiryPending" style="background: var(--neutral);" onclick="filterInquiries('pending')">ÎåÄÍ∏∞</button>
                            <button class="section-action" id="btnInquiryInProgress" style="background: var(--neutral);" onclick="filterInquiries('in_progress')">Ï≤òÎ¶¨Ï§ë</button>
                            <button class="section-action" id="btnInquiryAnswered" style="background: var(--neutral);" onclick="filterInquiries('answered')">ÏôÑÎ£å</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ïú†Ìòï</th>
                                <th>Ï†úÎ™©</th>
                                <th>ÏûëÏÑ±Ïûê</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>Ïö∞ÏÑ†ÏàúÏúÑ</th>
                                <th>Ï†ëÏàòÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="inquiriesTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                                    Î°úÎî© Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Î¨∏Ïùò ÏÉÅÏÑ∏ Î™®Îã¨ -->
                <div id="inquiryDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div style="padding: 24px; border-bottom: 1px solid #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0;">üì¨ Î¨∏Ïùò ÏÉÅÏÑ∏</h3>
                                <button onclick="closeInquiryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 24px;" id="inquiryDetailContent">
                            <!-- ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßê -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Section -->
            <div id="credit-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">ÌÅ¨Î†àÎîß Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">ÏÇ¨Ïö©Ïûê ÌÅ¨Î†àÎîßÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÌÅ¨Î†àÎîß ÌÜµÍ≥Ñ -->
                <div class="stats-grid stats-grid-5">
                    <div class="stat-card warning">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-value" id="creditPendingDepositCount">0</div>
                        <div class="stat-label">ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="creditTotalBalance">‚Ç©0</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ ÌÅ¨Î†àÎîß ÏûîÏï°</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="creditTodayCharge">+‚Ç©0</div>
                        <div class="stat-label">Ïò§Îäò Ï∂©Ï†Ñ</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="creditTodayUsage">-‚Ç©0</div>
                        <div class="stat-label">Ïò§Îäò ÏÇ¨Ïö©</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-value" id="creditAIUsageCount">0Ìöå</div>
                        <div class="stat-label">AI ÏÇ¨Ïö© ÌöüÏàò</div>
                    </div>
                </div>

                <!-- üí≥ ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üí≥ ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù</h2>
                        <button class="section-action" onclick="loadCreditDepositNotifications()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏÇ¨Ïö©Ïûê</th>
                                <th>ÏûÖÍ∏àÏûêÎ™Ö</th>
                                <th>Í∏àÏï°</th>
                                <th>Ïã†Ï≤≠Ïùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="creditDepositPendingTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÏÇ¨Ïö©ÏûêÎ≥Ñ ÌÅ¨Î†àÎîß -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">ÏÇ¨Ïö©ÏûêÎ≥Ñ ÌÅ¨Î†àÎîß</h2>
                        <button class="section-action" onclick="showCreditDeductModal()">ÏàòÎèô Ï∞®Í∞ê</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏÇ¨Ïö©Ïûê ID</th>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÏûîÏï°</th>
                                <th>ÎßàÏßÄÎßâ ÌôúÎèô</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="userCreditTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶º ÎåÄÏÉÅ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">‚ö†Ô∏è ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶º ÎåÄÏÉÅ (1,000Ïõê ÎØ∏Îßå)</h2>
                        <button class="section-action" onclick="sendLowBalanceNotificationAll()" style="background: var(--warning); color: #000;">üìß Ï†ÑÏ≤¥ ÏïåÎ¶º Î∞úÏÜ°</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏÇ¨Ïö©Ïûê</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>ÌòÑÏû¨ ÏûîÏï°</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="lowBalanceTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÌÅ¨Î†àÎîß Í±∞Îûò ÎÇ¥Ïó≠ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">ÌÅ¨Î†àÎîß Í±∞Îûò ÎÇ¥Ïó≠</h2>
                        <button class="section-action" onclick="exportCreditTransactions()">ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (CSV)</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏùºÏãú</th>
                                <th>ÏÇ¨Ïö©Ïûê</th>
                                <th>Ïú†Ìòï</th>
                                <th>Í∏àÏï°</th>
                                <th>ÏûîÏï°</th>
                                <th>ÏÑ§Î™Ö</th>
                                <th>ÏÑúÎπÑÏä§</th>
                            </tr>
                        </thead>
                        <tbody id="creditTransactionsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- AI ÏÇ¨Ïö© Î°úÍ∑∏ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">AI ÏÇ¨Ïö© Î°úÍ∑∏</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏùºÏãú</th>
                                <th>ÏÇ¨Ïö©Ïûê</th>
                                <th>AI ÏÑúÎπÑÏä§</th>
                                <th>ÌÜ†ÌÅ∞</th>
                                <th>ÎπÑÏö©</th>
                                <th>ÏùëÎãµÏãúÍ∞Ñ</th>
                                <th>ÏßàÎ¨∏ ÎØ∏Î¶¨Î≥¥Í∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="aiUsageLogTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Installation Fee Section (ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Í¥ÄÎ¶¨) -->
            <div id="installation-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üè† ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÏûÖÍ∏à ÌôïÏù∏ Î∞è Ï≤òÎ¶¨</p>
                </div>

                <!-- ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card warning">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-value" id="installationPendingCount">0</div>
                        <div class="stat-label">ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="installationApprovedCount">0</div>
                        <div class="stat-label">ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="installationTotalAmount">‚Ç©0</div>
                        <div class="stat-label">Ï¥ù Í∞úÏÑ§ÎπÑ Îß§Ï∂ú</div>
                    </div>
                </div>

                <!-- ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">‚è≥ ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù</h2>
                        <button class="section-action" onclick="loadInstallationRequests()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Ïã§Î™Ö</th>
                                <th>Í∏àÏï°</th>
                                <th>Ïã†Ï≤≠Ïùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="installationPendingTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">‚úÖ ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å Î™©Î°ù</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÌöåÏõê ID</th>
                                <th>ÎπåÎçî Í≥ÑÏ†ï ID</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Ïã§Î™Ö</th>
                                <th>Í∏àÏï°</th>
                                <th>Ïã†Ï≤≠Ïùº</th>
                                <th>ÌôïÏù∏Ïùº</th>
                            </tr>
                        </thead>
                        <tbody id="installationProcessedTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sunny Inquiries Section (SunnyÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ∏∞) -->
            <div id="sunny-inquiries-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">‚òÄÔ∏è SunnyÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ∏∞</h1>
                    <p class="content-subtitle">ÏÇ¨Ïö©ÏûêÎì§Ïùò ÏßàÎ¨∏ÏùÑ ÌôïÏù∏ÌïòÍ≥† ÎãµÎ≥ÄÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-value" id="sunnyTotalCount">0</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ Î¨∏Ïùò</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-value" id="sunnyPendingCount">0</div>
                        <div class="stat-label">ÎãµÎ≥Ä ÎåÄÍ∏∞</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="sunnyInProgressCount">0</div>
                        <div class="stat-label">Ï≤òÎ¶¨ Ï§ë</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="sunnyAnsweredCount">0</div>
                        <div class="stat-label">ÎãµÎ≥Ä ÏôÑÎ£å</div>
                    </div>
                </div>

                <!-- Î¨∏Ïùò Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã Î¨∏Ïùò Î™©Î°ù</h2>
                        <div style="display: flex; gap: 8px;">
                            <button id="btnSunnyAll" class="section-action" style="background: var(--primary);" onclick="filterSunnyInquiries('all')">Ï†ÑÏ≤¥</button>
                            <button id="btnSunnyPending" class="section-action" style="background: var(--neutral);" onclick="filterSunnyInquiries('pending')">ÎåÄÍ∏∞</button>
                            <button id="btnSunnyAnswered" class="section-action" style="background: var(--neutral);" onclick="filterSunnyInquiries('answered')">ÏôÑÎ£å</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ï†úÎ™©</th>
                                <th>ÏûëÏÑ±Ïûê</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>Îì±Î°ùÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="sunnyInquiriesTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÏÉÅÏÑ∏ Î™®Îã¨ -->
                <div id="sunnyDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div style="background: white; border-radius: 12px; width: 600px; max-width: 90vw; max-height: 80vh; overflow-y: auto;">
                        <div style="padding: 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">‚òÄÔ∏è Î¨∏Ïùò ÏÉÅÏÑ∏</h3>
                            <button onclick="closeSunnyDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 24px;" id="sunnyDetailContent">
                            <!-- ÏÉÅÏÑ∏ ÎÇ¥Ïö© ÎèôÏ†Å Î°úÎìú -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Section (ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨) -->
            <div id="projects-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üìÅ ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÏ†ùÌä∏ ÌòÑÌô©ÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÌîÑÎ°úÏ†ùÌä∏ ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üìÅ</div>
                        <div class="stat-value" id="projectsTotalCount">0</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="projectsInProgressCount">0</div>
                        <div class="stat-label">ÏßÑÌñâ Ï§ë</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="projectsCompletedCount">0</div>
                        <div class="stat-label">ÏôÑÎ£å</div>
                    </div>
                    <div class="stat-card neutral">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="projectsArchivedCount">0</div>
                        <div class="stat-label">Î≥¥Í¥Ä</div>
                    </div>
                </div>

                <!-- Í≤ÄÏÉâ -->
                <div class="content-section" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="projectSearchInput" placeholder="ÌîÑÎ°úÏ†ùÌä∏ ID, ÌîÑÎ°úÏ†ùÌä∏Î™Ö, ÏÇ¨Ïö©Ïûê ID Í≤ÄÏÉâ..." style="flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <button class="section-action" onclick="searchProjects()">üîç Í≤ÄÏÉâ</button>
                        <button class="section-action" onclick="loadProjects()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                    </div>
                </div>

                <!-- ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÌîÑÎ°úÏ†ùÌä∏ ID</th>
                                <th>ÌîÑÎ°úÏ†ùÌä∏Î™Ö</th>
                                <th>ÏÇ¨Ïö©Ïûê ID</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>ÏßÑÌñâÎ•†</th>
                                <th>Îì±Î°ùÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stats Section removed - merged with Overview -->

            <!-- API Usage Section -->
            <div id="api-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üîå API ÏÇ¨Ïö©Îüâ</h1>
                    <p class="content-subtitle">AI API ÏÇ¨Ïö©Îüâ Î∞è ÎπÑÏö©ÏùÑ Î™®ÎãàÌÑ∞ÎßÅÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- API ÏÇ¨Ïö©Îüâ ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üì•</div>
                        <div class="stat-value" id="totalInputTokens">-</div>
                        <div class="stat-label">Input ÌÜ†ÌÅ∞</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">üì§</div>
                        <div class="stat-value" id="totalOutputTokens">-</div>
                        <div class="stat-label">Output ÌÜ†ÌÅ∞</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="totalTokens">-</div>
                        <div class="stat-label">Ï¥ù ÌÜ†ÌÅ∞</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalCostUSD">-</div>
                        <div class="stat-label">Ïù¥Î≤à Îã¨ ÎπÑÏö©</div>
                    </div>
                </div>

                <!-- AIÎ≥Ñ ÏÇ¨Ïö©Îüâ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">ü§ñ AIÎ≥Ñ ÏÇ¨Ïö©Îüâ (Ïù¥Î≤à Îã¨)</h2>
                    </div>
                    <table class="data-table" id="aiUsageTable">
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>Í∏∞Î≥∏ Î™®Îç∏</th>
                                <th>Input ÌÜ†ÌÅ∞</th>
                                <th>Output ÌÜ†ÌÅ∞</th>
                                <th>ÏòàÏÉÅ ÎπÑÏö© (USD)</th>
                                <th>ÏÉÅÌÉú</th>
                            </tr>
                        </thead>
                        <tbody id="aiUsageBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- API ÏõêÍ∞Ä Í¥ÄÎ¶¨ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üíµ API ÏõêÍ∞Ä Î∞è ÌåêÎß§Í∞Ä Í¥ÄÎ¶¨</h2>
                        <button class="section-action" onclick="showApiCostModal()">+ Î™®Îç∏ Ï∂îÍ∞Ä</button>
                    </div>
                    <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                        <span style="color: #666; font-size: 13px;">
                            ÌôòÏú®: <strong id="currentExchangeRate">‚Ç©1,450</strong>/USD
                            <button onclick="fetchExchangeRate()" style="margin-left: 8px; padding: 4px 10px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: #f8f9fa;">üîÑ ÌôòÏú® Ï°∞Ìöå</button>
                        </span>
                    </div>
                    <table class="data-table" id="apiCostsTable">
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>Î™®Îç∏Î™Ö</th>
                                <th>ÏõêÍ∞Ä (USD/1M)</th>
                                <th>ÎßàÏßÑÏú®</th>
                                <th>ÌåêÎß§Í∞Ä (KRW/1M)</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="apiCostsBody">
                            <tr><td colspan="7" style="text-align:center; padding: 40px; color: #999;">Î°úÎî© Ï§ë...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- API ÌÇ§ Í¥ÄÎ¶¨ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üîë API ÌÇ§ Í¥ÄÎ¶¨</h2>
                        <button class="section-action">+ ÏÉà ÌÇ§ Ï∂îÍ∞Ä</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÏÑúÎπÑÏä§</th>
                                <th>API ÌÇ§</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>ÎßåÎ£åÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Perplexity</td>
                                <td>pplx-****-****-****-7890</td>
                                <td><span class="status-badge active">ÌôúÏÑ±</span></td>
                                <td>2026-01-15</td>
                                <td><a href="#" class="action-link">ÏàòÏ†ï</a></td>
                            </tr>
                            <tr>
                                <td>OpenAI</td>
                                <td>sk-****-****-****-abcd</td>
                                <td><span class="status-badge active">ÌôúÏÑ±</span></td>
                                <td>Î¨¥Í∏∞Ìïú</td>
                                <td><a href="#" class="action-link">ÏàòÏ†ï</a></td>
                            </tr>
                            <tr>
                                <td>Google AI</td>
                                <td>AIza****-****-****-wxyz</td>
                                <td><span class="status-badge active">ÌôúÏÑ±</span></td>
                                <td>Î¨¥Í∏∞Ìïú</td>
                                <td><a href="#" class="action-link">ÏàòÏ†ï</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">‚öôÔ∏è ÏÑ§Ï†ï</h1>
                    <p class="content-subtitle">ÏãúÏä§ÌÖú ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÏùºÎ∞ò ÏÑ§Ï†ï -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üè† ÏùºÎ∞ò ÏÑ§Ï†ï</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÌîåÎû´Ìèº Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-input" id="settingPlatformName" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Í¥ÄÎ¶¨Ïûê Ïù¥Î©îÏùº</label>
                        <input type="email" class="form-input" id="settingAdminEmail" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÏãúÍ∞ÑÎåÄ</label>
                        <select class="form-select" id="settingTimezone">
                            <option value="Asia/Seoul">Asia/Seoul (KST)</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                </div>

                <!-- ÏïåÎ¶º ÏÑ§Ï†ï -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üîî ÏïåÎ¶º ÏÑ§Ï†ï</h2>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingNotifyInquiry">
                        <label for="settingNotifyInquiry" style="font-weight: 500;">ÏÉà Î¨∏Ïùò Ï†ëÏàò Ïãú Ïù¥Î©îÏùº ÏïåÎ¶º</label>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingNotifyPayment">
                        <label for="settingNotifyPayment" style="font-weight: 500;">Í≤∞Ï†ú ÏôÑÎ£å Ïãú Ïù¥Î©îÏùº ÏïåÎ¶º</label>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingNotifySignup">
                        <label for="settingNotifySignup" style="font-weight: 500;">Ïã†Í∑ú Í∞ÄÏûÖ Ïãú Ïù¥Î©îÏùº ÏïåÎ¶º</label>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingNotifyInstallationRequest" checked>
                        <label for="settingNotifyInstallationRequest" style="font-weight: 500;">ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÏûÖÍ∏à ÌôïÏù∏ ÏöîÏ≤≠ Ïãú Ïù¥Î©îÏùº ÏïåÎ¶º</label>
                    </div>
                </div>

                <!-- ÏöîÍ∏à ÏÑ§Ï†ï -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üí∞ ÏöîÍ∏à ÏÑ§Ï†ï</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ (Ïõê)</label>
                        <input type="number" class="form-input" id="settingInstallFee" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ïõî ÏÇ¨Ïö©Î£å (Ïõê)</label>
                        <input type="number" class="form-input" id="settingMonthlyFee" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÌÅ¨Î†àÎîß Îã®Í∞Ä (Ïõê/ÌÅ¨Î†àÎîß)</label>
                        <input type="number" class="form-input" id="settingCreditPrice" value="">
                    </div>
                </div>

                <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üíæ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h2>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="section-action" style="background: var(--primary);">üì• Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ</button>
                        <button class="section-action" style="background: var(--warning); color: #000;">üì§ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê</button>
                        <button class="section-action" style="background: var(--neutral);">üìä ÏÇ¨Ïö© ÌÜµÍ≥Ñ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                    </div>
                    <p style="margin-top: 12px; font-size: 12px; color: #6c757d;" id="settingLastBackup">
                        ÎßàÏßÄÎßâ Î∞±ÏóÖ: -
                    </p>
                </div>

                <div style="margin-top: 24px; text-align: right;">
                    <button class="form-btn form-btn-primary" onclick="saveAdminSettings()">ÏÑ§Ï†ï Ï†ÄÏû•</button>
                </div>
            </div>

            <!-- Subscription Section (ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Í¥ÄÎ¶¨ - ÏûêÎèô Í≤∞Ï†ú Í∏∞Î∞ò) -->
            <div id="subscription-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üìÖ ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">ÌîåÎû´Ìèº Ïù¥Ïö©Î£å (‚Ç©50,000/Ïõî, 4Í∞úÏõîÏ∞®Î∂ÄÌÑ∞ ÏûêÎèô Í≤∞Ï†ú) ÌòÑÌô©</p>
                </div>

                <!-- ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÏïàÎÇ¥ -->
                <div class="content-section" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border: 1px solid #ffc107; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">üöß</span>
                        <div>
                            <h3 style="margin: 0 0 4px 0; color: #856404;">ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô Íµ¨Ï∂ï Ï§ë</h3>
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                ÏûêÎèô Í≤∞Ï†ú Í∏∞Îä•ÏùÄ ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í∞ÄÎßπÏ†ê Îì±Î°ù Î∞è API Ïó∞Îèô ÏôÑÎ£å ÌõÑ ÌôúÏÑ±ÌôîÎê©ÎãàÎã§.
                                ÌòÑÏû¨Îäî ÌòÑÌô© Ï°∞ÌöåÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ÌîåÎû´Ìèº Ïù¥Ïö©Î£å ÌÜµÍ≥Ñ -->
                <div class="stats-grid stats-grid-5">
                    <div class="stat-card warning">
                        <div class="stat-icon">üÜì</div>
                        <div class="stat-value" id="platformFeeFreeCount">0</div>
                        <div class="stat-label">Î¨¥Î£å Í∏∞Í∞Ñ</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon">üí≥</div>
                        <div class="stat-value" id="platformFeeBillingCount">0</div>
                        <div class="stat-label">ÏûêÎèô Í≤∞Ï†ú Îì±Î°ù</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="platformFeePaidCount">0</div>
                        <div class="stat-label">Ïù¥Î≤à Îã¨ Í≤∞Ï†ú ÏÑ±Í≥µ</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-value" id="platformFeeFailedCount">0</div>
                        <div class="stat-label">Ïù¥Î≤à Îã¨ Í≤∞Ï†ú Ïã§Ìå®</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="platformFeeMonthlyRevenue">‚Ç©0</div>
                        <div class="stat-label">Ïù¥Î≤à Îã¨ Îß§Ï∂ú</div>
                    </div>
                </div>

                <!-- Î¨¥Î£å Í∏∞Í∞Ñ ‚Üí Ïú†Î£å Ï†ÑÌôò ÏòàÏ†ï (Îß® Ïïû Î∞∞Ïπò) -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üÜì Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©Ïûê (Ïú†Î£å Ï†ÑÌôò ÏòàÏ†ï)</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="section-action" onclick="sendFreeEndingNotice7Days()" style="background: var(--danger); color: #fff;">üìß 7Ïùº Ïù¥ÎÇ¥ ÏïàÎÇ¥ Î∞úÏÜ°</button>
                            <button class="section-action" onclick="sendFreeEndingNotice()" style="background: var(--warning); color: #000;">üìß Ï†ÑÏ≤¥ ÏïàÎÇ¥ Î∞úÏÜ°</button>
                            <button class="section-action" onclick="loadPlatformFeeData()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÎπåÎçî Í≥ÑÏ†ï ID</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Ïã§Î™Ö</th>
                                <th>Í∞úÏÑ§Ïùº</th>
                                <th>Ïú†Î£å Ï†ÑÌôòÏùº</th>
                                <th>ÎÇ®ÏùÄ ÏùºÏàò</th>
                                <th>ÎπåÎßÅÌÇ§</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="platformFeeFreeTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #6c757d; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÏûêÎèô Í≤∞Ï†ú Îì±Î°ù ÌòÑÌô© -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üí≥ ÏûêÎèô Í≤∞Ï†ú Îì±Î°ù ÌòÑÌô©</h2>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÎπåÎçî Í≥ÑÏ†ï ID</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Ïã§Î™Ö</th>
                                <th>ÎπåÎßÅÌÇ§ ÏÉÅÌÉú</th>
                                <th>Í≤∞Ï†ú ÏàòÎã®</th>
                                <th>Îã§Ïùå Í≤∞Ï†úÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="platformFeeBillingTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    üöß ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌõÑ ÌôúÏÑ±ÌôîÎê©ÎãàÎã§
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Ïù¥Î≤à Îã¨ Í≤∞Ï†ú ÎÇ¥Ïó≠ -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã Ïù¥Î≤à Îã¨ Í≤∞Ï†ú ÎÇ¥Ïó≠</h2>
                        <button class="section-action" style="background: var(--neutral);">üì• ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (CSV)</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÎπåÎçî Í≥ÑÏ†ï ID</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>Í∏àÏï°</th>
                                <th>Í≤∞Ï†úÏùºÏãú</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>Ïã§Ìå® ÏÇ¨Ïú†</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="platformFeePaymentTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                                    üöß ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌõÑ ÌôúÏÑ±ÌôîÎê©ÎãàÎã§
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Ï†ïÏ±Ö ÏïàÎÇ¥ -->
                <div class="content-section" style="background: #f8f9fa; border: 1px dashed #dee2e6;">
                    <h3 style="margin-bottom: 12px; color: var(--primary);">üí° ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Ï†ïÏ±Ö</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #495057; line-height: 1.8;">
                        <li><strong>Ï≤´ 3Í∞úÏõî Î¨¥Î£å:</strong> Í∞úÏÑ§ÏùºÎ°úÎ∂ÄÌÑ∞ 3Í∞úÏõîÍ∞Ñ Ïù¥Ïö©Î£å Î©¥Ï†ú</li>
                        <li><strong>4Í∞úÏõîÏ∞®Î∂ÄÌÑ∞ ÏûêÎèô Í≤∞Ï†ú:</strong> ‚Ç©50,000/Ïõî (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏†)</li>
                        <li><strong>Í≤∞Ï†úÏùº:</strong> Îß§Ïõî Í∞úÏÑ§Ïùº Í∏∞Ï§Ä ÏûêÎèô Í≤∞Ï†ú</li>
                        <li><strong>Í≤∞Ï†ú Ïã§Ìå® Ïãú:</strong> 3Ïùº ÌõÑ Ïû¨ÏãúÎèÑ, Ïù¥ÌõÑ ÏÑúÎπÑÏä§ ÏùºÏãú Ï§ëÏßÄ</li>
                    </ul>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="content-view" style="display:none;">
                <div class="content-header">
                    <h1 class="content-title">üë• ÌöåÏõê Í¥ÄÎ¶¨</h1>
                    <p class="content-subtitle">Ï†ÑÏ≤¥ ÌöåÏõêÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                </div>

                <!-- ÌöåÏõê ÌÜµÍ≥Ñ -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="totalUsersCount">-</div>
                        <div class="stat-label">Ï†ÑÏ≤¥ ÌöåÏõê</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="activeUsersCount">-</div>
                        <div class="stat-label">ÌôúÏÑ± ÌöåÏõê</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="paidUsersCount">-</div>
                        <div class="stat-label">ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-value" id="totalCreditsCount">-</div>
                        <div class="stat-label">Ï¥ù ÌÅ¨Î†àÎîß</div>
                    </div>
                </div>

                <!-- ÌöåÏõê Î™©Î°ù -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">üìã ÌöåÏõê Î™©Î°ù</h2>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="userSearchInput" placeholder="Ïù¥Î©îÏùº/ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 4px; min-width: 200px;" onkeypress="if(event.key==='Enter') searchUsers()">
                            <button class="section-action" onclick="searchUsers()">Í≤ÄÏÉâ</button>
                            <button class="section-action" onclick="loadUsers()" style="background: var(--neutral);">ÏÉàÎ°úÍ≥†Ïπ®</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ÌöåÏõê ID</th>
                                <th>ÎπåÎçî Í≥ÑÏ†ï ID</th>
                                <th>Ïù¥Î©îÏùº</th>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>Ïã§Î™Ö</th>
                                <th>ÏÉÅÌÉú</th>
                                <th>ÌÅ¨Î†àÎîß</th>
                                <th>Í∞ÄÏûÖÏùº</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Form Modals -->
        <!-- ÌïôÏäµÏΩòÌÖêÏ∏† Í¥ÄÎ†® Î™®Îã¨ Ï†úÍ±∞Îê® (ÏûêÎèôÌôî ÏãúÏä§ÌÖúÏúºÎ°ú Ï†ÑÌôò) -->

            </div>
        </div>

        <!-- Credit Deduct Modal -->
        <div id="creditDeductOverlay" class="form-overlay" onclick="if(event.target === this) closeCreditDeductModal()">
            <div class="form-modal">
                <div class="form-header">ü™ô ÌÅ¨Î†àÎîß ÏàòÎèô Ï∞®Í∞ê</div>
                <form onsubmit="event.preventDefault(); deductCredit();">
                    <div class="form-group">
                        <label class="form-label">ÏÇ¨Ïö©Ïûê Ïù¥Î©îÏùº</label>
                        <input type="email" id="deductEmail" class="form-input" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ï∞®Í∞ê Í∏àÏï°</label>
                        <input type="number" id="deductAmount" class="form-input" placeholder="10000" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ï∞®Í∞ê ÏÇ¨Ïú†</label>
                        <textarea id="deductReason" class="form-textarea" style="min-height: 80px;" placeholder="Ï∞®Í∞ê ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Ïò§Î•ò Ï†ïÏ†ï, ÌÖåÏä§Ìä∏ Ï∞®Í∞ê Îì±)" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="form-btn form-btn-secondary" onclick="closeCreditDeductModal()">Ï∑®ÏÜå</button>
                        <button type="submit" class="form-btn form-btn-primary">Ï∞®Í∞ê</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Cost Modal -->
        <div id="apiCostOverlay" class="form-overlay" onclick="if(event.target === this) closeApiCostModal()">
            <div class="form-modal" style="max-width: 500px;">
                <div class="form-header" id="apiCostModalTitle">üíµ API ÏõêÍ∞Ä Ï∂îÍ∞Ä</div>
                <form onsubmit="event.preventDefault(); saveApiCost();">
                    <input type="hidden" id="apiCostId">
                    <div class="form-group">
                        <label class="form-label">Provider</label>
                        <select id="apiCostProvider" class="form-input" required>
                            <option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google</option>
                            <option value="perplexity">Perplexity</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Î™®Îç∏Î™Ö (APIÏö©)</label>
                        <input type="text" id="apiCostModelName" class="form-input" placeholder="gpt-4o, claude-3.5-sonnet" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÌëúÏãú Ïù¥Î¶Ñ</label>
                        <input type="text" id="apiCostDisplayName" class="form-input" placeholder="GPT-4o, Claude 3.5 Sonnet">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">Input Cost ($/1M)</label>
                            <input type="number" id="apiCostInput" class="form-input" step="0.01" min="0" placeholder="3.00" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Output Cost ($/1M)</label>
                            <input type="number" id="apiCostOutput" class="form-input" step="0.01" min="0" placeholder="15.00" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">ÌôòÏú® (USD‚ÜíKRW)</label>
                            <input type="number" id="apiCostExchangeRate" class="form-input" value="1450" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÎßàÏßÑÏú® (%)</label>
                            <input type="number" id="apiCostMargin" class="form-input" value="30" min="0" max="100" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÎπÑÍ≥†</label>
                        <input type="text" id="apiCostNotes" class="form-input" placeholder="Î™®Îç∏ ÏÑ§Î™Ö">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="form-btn form-btn-secondary" onclick="closeApiCostModal()">Ï∑®ÏÜå</button>
                        <button type="submit" class="form-btn form-btn-primary">Ï†ÄÏû•</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Detail Modal -->
        <div id="userDetailOverlay" class="form-overlay" onclick="if(event.target === this) closeUserDetail()">
            <div class="form-modal" style="max-width: 500px;">
                <div class="form-header" id="userDetailHeader">üë§ ÌöåÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥</div>
                <div style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÌöåÏõê ID (8ÏûêÎ¶¨)</div>
                            <div style="font-size: 14px; font-weight: 600;" id="userDetailMemberId">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÎπåÎçî Í≥ÑÏ†ï ID (12ÏûêÎ¶¨)</div>
                            <div style="font-size: 14px; font-weight: 600;" id="userDetailUserId">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïù¥Î©îÏùº</div>
                            <div style="font-size: 14px; font-weight: 600;" id="userDetailEmail">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÎãâÎÑ§ÏûÑ</div>
                            <div style="font-size: 14px; font-weight: 600;" id="userDetailNickname">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïã§Î™Ö</div>
                            <div style="font-size: 14px;" id="userDetailRealName">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Í∞ÄÏûÖÏùº</div>
                            <div style="font-size: 14px;" id="userDetailCreatedAt">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä</div>
                            <div id="userDetailInstallationFee">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÌÅ¨Î†àÎîß ÏûîÏï°</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--success);" id="userDetailCredit">-</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ÌöåÏõê ÏÉÅÌÉú</label>
                    <select class="form-select" id="userDetailStatusSelect">
                        <option value="active">ÌôúÏÑ±</option>
                        <option value="inactive">ÎπÑÌôúÏÑ±</option>
                        <option value="suspended">Ï†ïÏßÄ</option>
                        <option value="pending">ÎåÄÍ∏∞</option>
                    </select>
                </div>
                <div class="form-actions" style="justify-content: space-between;">
                    <button type="button" class="form-btn" style="background: var(--danger); color: white;" onclick="deleteUser()">ÌöåÏõê ÏÇ≠Ï†ú</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="form-btn form-btn-secondary" onclick="closeUserDetail()">Îã´Í∏∞</button>
                        <button type="button" class="form-btn form-btn-primary" onclick="saveUserStatus()">ÏÉÅÌÉú Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Detail Modal -->
        <div id="paymentDetailOverlay" class="form-overlay" onclick="if(event.target === this) closePaymentDetail()">
            <div class="form-modal">
                <div class="form-header">üí≥ Í≤∞Ï†ú ÏÉÅÏÑ∏</div>
                <div style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Í≤∞Ï†ú ID</div>
                            <div style="font-size: 14px; font-weight: 600;">PAY-2025-001</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏÇ¨Ïö©Ïûê</div>
                            <div style="font-size: 14px;">user@example.com</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Í∏àÏï°</div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--success);">‚Ç©50,000</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Í≤∞Ï†ú ÏàòÎã®</div>
                            <div style="font-size: 14px;">Ïã†Ïö©Ïπ¥Îìú</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Í≤∞Ï†úÏùº</div>
                            <div style="font-size: 14px;">2025-11-24 15:30</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏÉÅÌÉú</div>
                            <div><span class="status-badge answered">ÏôÑÎ£å</span></div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="form-btn form-btn-secondary" onclick="closePaymentDetail()">Îã´Í∏∞</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-links">
                <a href="pages/legal/terms.html" class="footer-link">Ïù¥Ïö©ÏïΩÍ¥Ä</a>
                <a href="pages/legal/privacy.html" class="footer-link">Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®</a>
            </div>
            <div class="footer-copyright">
                <span>¬© 2025 SSAL Works, All Rights Reserved</span>
            </div>
            <a href="index.html" class="home-link">Home</a>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Î°úÎî© Ï§ë...</div>
    </div>

    <script>
        // ========== Toast Notification System ==========
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icon = document.createElement('div');
            icon.className = 'toast-icon';
            icon.textContent = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

            const messageDiv = document.createElement('div');
            messageDiv.className = 'toast-message';
            messageDiv.textContent = message;

            toast.appendChild(icon);
            toast.appendChild(messageDiv);
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== Loading Overlay ==========
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // ========== XSS Protection - Sanitization ==========
        /**
         * Sanitize user input to prevent XSS attacks
         * Uses DOMPurify library to clean potentially malicious content
         * @param {string} input - User input to sanitize
         * @returns {string} - Sanitized safe HTML
         */
        function sanitizeInput(input) {
            if (!input) return '';
            // DOMPurify configuration for strict cleaning
            const config = {
                ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'u', 'br', 'p', 'ul', 'ol', 'li'],
                ALLOWED_ATTR: [],
                KEEP_CONTENT: true
            };
            return DOMPurify.sanitize(input, config);
        }

        /**
         * Sanitize plain text (removes all HTML tags)
         * @param {string} input - User input
         * @returns {string} - Plain text only
         */
        function sanitizePlainText(input) {
            if (!input) return '';
            return DOMPurify.sanitize(input, { ALLOWED_TAGS: [], KEEP_CONTENT: true });
        }

        // ========== Form Validation ==========
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateAmount(amount) {
            const num = parseInt(amount);
            return num >= 1000 && num <= 1000000;
        }

        function validateText(text, minLength = 3, maxLength = 200) {
            return text.length >= minLength && text.length <= maxLength;
        }

        // Show Section
        function showSection(section, event) {
            // Î™®Î∞îÏùºÏóêÏÑú Î©îÎâ¥ ÌÅ¥Î¶≠ Ïãú ÏÇ¨Ïù¥ÎìúÎ∞î Îã´Í∏∞
            closeSidebar();

            // Hide all sections
            document.querySelectorAll('.content-view').forEach(view => {
                view.style.display = 'none';
            });

            // Remove active from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }

            // Add active to clicked menu item (if event is provided)
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Í≥µÏßÄÏÇ¨Ìï≠ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'notice') {
                loadNotices();
            }

            // ÌïôÏäµ ÏΩòÌÖêÏ∏† ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'learning') {
                loadLearningContents();
            }

            // ÌöåÏõê Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'users') {
                loadUsers();
            }

            // ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'installation') {
                loadInstallationRequests();
            }

            // ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'projects') {
                loadProjects();
            }

            // ÌÅ¨Î†àÎîß Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'credit') {
                loadCreditData();
            }

            // Î¨∏Ïùò Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'inquiries') {
                loadInquiriesData();
            }

            // Ïç®ÎãàÏóêÍ≤å Î¨ªÍ∏∞ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'sunny-inquiries') {
                loadSunnyInquiriesData();
            }

            // ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Í¥ÄÎ¶¨ ÏÑπÏÖòÏùº Îïå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'subscription') {
                loadPlatformFeeData();
            }

            // API ÏÇ¨Ïö©Îüâ ÏÑπÏÖòÏùº Îïå ÏõêÍ∞Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'api') {
                loadApiCosts();
            }

            // ÏÑ§Ï†ï ÏÑπÏÖòÏùº Îïå ÏÑ§Ï†ï Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (section === 'settings') {
                loadAdminSettings();
            }
        }

        // Logout
        function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.location.href = 'index.html';
            }
        }

        // ========== Learning Content Tree Functions ==========
        function toggleTreeItem(element) {
            const parent = element.parentElement;
            const children = parent.querySelector('.tree-children');
            const arrow = element.querySelector('.tree-arrow');

            if (children) {
                if (children.style.display === 'none') {
                    children.style.display = 'block';
                    arrow.classList.add('open');
                } else {
                    children.style.display = 'none';
                    arrow.classList.remove('open');
                }
            }
        }

        // ================================================
        // ÌïôÏäµÏΩòÌÖêÏ∏† Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§ Ï†úÍ±∞Îê® (ÏûêÎèôÌôî ÏãúÏä§ÌÖúÏúºÎ°ú Ï†ÑÌôò)
        // - showAddDepth1Form, closeDepth1Form, saveDepth1
        // - closeDepth2Form, saveDepth2
        // - closeDepth3Form, saveDepth3
        // - editLink, closeLinkForm, saveLink, removeLink
        // ================================================


        // Ìï≠Î™© ÏàúÏÑú Î≥ÄÍ≤Ω
        function moveItem(direction) {
            showToast(`Ìï≠Î™©Ïù¥ ${direction === 'up' ? 'ÏúÑÎ°ú' : 'ÏïÑÎûòÎ°ú'} Ïù¥ÎèôÎêòÏóàÏäµÎãàÎã§.`, 'info');
        }

        // Inquiry Form Functions
        function showInquiryForm() {
            document.getElementById('inquiryFormOverlay').style.display = 'flex';
        }

        function closeInquiryForm() {
            document.getElementById('inquiryFormOverlay').style.display = 'none';
        }

        function saveInquiryAnswer() {
            const answer = document.querySelector('#inquiryFormOverlay .form-textarea').value;

            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!validateText(answer, 10, 2000)) {
                showToast('ÎãµÎ≥ÄÏùÄ 10~2000ÏûêÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            // üîí XSS Protection: Sanitize inquiry answer (allow basic formatting)
            const safeAnswer = sanitizeInput(answer);

            showLoading();
            setTimeout(() => {
                hideLoading();
                showToast('ÎãµÎ≥ÄÏù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§!', 'success');
                closeInquiryForm();
                // TODO: Send safeAnswer to backend API
                console.log('Sanitized answer:', safeAnswer);
            }, 800);
        }

        // Credit Deduct Functions (ÏàòÎèô Ï∞®Í∞êÎßå ÏßÄÏõê - Ï∂©Ï†ÑÏùÄ ÏûÖÍ∏àÌôïÏù∏ÏóêÏÑú ÏûêÎèô Ï≤òÎ¶¨)
        function showCreditDeductModal() {
            document.getElementById('creditDeductOverlay').style.display = 'flex';
        }

        function closeCreditDeductModal() {
            document.getElementById('creditDeductOverlay').style.display = 'none';
            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('deductEmail').value = '';
            document.getElementById('deductAmount').value = '';
            document.getElementById('deductReason').value = '';
        }

        async function deductCredit() {
            const email = document.getElementById('deductEmail').value.trim();
            const amount = parseInt(document.getElementById('deductAmount').value);
            const reason = document.getElementById('deductReason').value.trim();

            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!validateEmail(email)) {
                showToast('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.', 'error');
                return;
            }

            if (!amount || amount < 1) {
                showToast('Ï∞®Í∞ê Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            if (!reason || reason.length < 5) {
                showToast('Ï∞®Í∞ê ÏÇ¨Ïú†Î•º 5Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            // üîí XSS Protection: Sanitize credit transaction data
            const safeEmail = sanitizePlainText(email);
            const safeReason = sanitizePlainText(reason);

            showLoading();
            try {
                // ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
                const userRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/users?email=eq.${encodeURIComponent(safeEmail)}&select=user_id,email,credit_balance`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const users = await userRes.json();

                if (!users || users.length === 0) {
                    showToast('Ìï¥Îãπ Ïù¥Î©îÏùºÏùò ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }

                const user = users[0];
                const newBalance = (user.credit_balance || 0) - amount;

                if (newBalance < 0) {
                    showToast(`ÏûîÏï° Î∂ÄÏ°±: ÌòÑÏû¨ ${(user.credit_balance || 0).toLocaleString()}Ïõê, Ï∞®Í∞ê ÏöîÏ≤≠ ${amount.toLocaleString()}Ïõê`, 'error');
                    return;
                }

                // ÌÅ¨Î†àÎîß Ï∞®Í∞ê
                const updateRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/users?user_id=eq.${user.user_id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ credit_balance: newBalance })
                    }
                );

                if (!updateRes.ok) throw new Error('ÌÅ¨Î†àÎîß ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');

                // Í±∞Îûò Í∏∞Î°ù Ï∂îÍ∞Ä
                await fetch(
                    `${SUPABASE_URL}/rest/v1/credit_transactions`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: user.user_id,
                            amount: -amount,
                            transaction_type: 'admin_deduct',
                            description: safeReason,
                            balance_after: newBalance
                        })
                    }
                );

                showToast(`${amount.toLocaleString()}Ïõê Ï∞®Í∞ê ÏôÑÎ£å! (ÏûîÏï°: ${newBalance.toLocaleString()}Ïõê)`, 'success');
                closeCreditDeductModal();
                loadCreditData(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            } catch (error) {
                console.error('ÌÅ¨Î†àÎîß Ï∞®Í∞ê Ïã§Ìå®:', error);
                showToast('ÌÅ¨Î†àÎîß Ï∞®Í∞ê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // API ÏõêÍ∞Ä Í¥ÄÎ¶¨ Functions
        // ========================================
        let allApiCosts = [];

        async function loadApiCosts() {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/api_costs?select=*&order=is_default.desc,provider,model_name`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                allApiCosts = await res.json();
                renderApiCosts(allApiCosts);

                // Ï≤´ Î≤àÏß∏ Î™®Îç∏Ïùò ÌôòÏú®Î°ú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                if (allApiCosts.length > 0) {
                    const rate = allApiCosts[0].usd_to_krw_rate;
                    document.getElementById('currentExchangeRate').textContent = `‚Ç©${rate.toLocaleString()}`;
                }

                // AI ÏÇ¨Ïö©Îüâ ÌÜµÍ≥ÑÎèÑ Ìï®Íªò Î°úÎìú
                await loadAIUsageStats();
            } catch (error) {
                console.error('API ÏõêÍ∞Ä Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('apiCostsBody').innerHTML =
                    '<tr><td colspan="8" style="text-align:center; padding:40px; color:#dc3545;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        // AI ÏÇ¨Ïö©Îüâ ÌÜµÍ≥Ñ (Ïù¥Î≤à Îã¨ ÌÜ†ÌÅ∞ Ìï©Í≥Ñ Î∞è ÎπÑÏö©)
        async function loadAIUsageStats() {
            try {
                // Ïù¥Î≤à Îã¨ ÏãúÏûëÏùº
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

                // api_usage_logÏóêÏÑú Ïù¥Î≤à Îã¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/api_usage_log?select=ai_model,input_tokens,output_tokens&created_at=gte.${monthStart}`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                const logs = await res.json();

                // ProviderÎ≥Ñ ÏßëÍ≥Ñ
                const stats = {
                    'openai': { input: 0, output: 0, model: 'gpt-4o-mini' },
                    'google': { input: 0, output: 0, model: 'gemini-2.5-flash' },
                    'perplexity': { input: 0, output: 0, model: 'sonar' }
                };

                logs.forEach(log => {
                    if (!log.ai_model) return;
                    const provider = log.ai_model.split('/')[0];
                    const model = log.ai_model.split('/')[1] || '';
                    if (stats[provider]) {
                        stats[provider].input += log.input_tokens || 0;
                        stats[provider].output += log.output_tokens || 0;
                        if (model) stats[provider].model = model;
                    }
                });

                // ÎπÑÏö© Í≥ÑÏÇ∞ (api_costsÏóêÏÑú Îã®Í∞Ä Í∞ÄÏ†∏Ïò¥)
                const providerIcons = { openai: 'üü¢', google: 'üîµ', perplexity: 'üü†' };
                const providerNames = { openai: 'OpenAI', google: 'Gemini', perplexity: 'Perplexity' };

                const tbody = document.getElementById('aiUsageBody');
                tbody.innerHTML = Object.entries(stats).map(([provider, data]) => {
                    // api_costsÏóêÏÑú Ìï¥Îãπ Î™®Îç∏Ïùò Îã®Í∞Ä Ï∞æÍ∏∞
                    const costInfo = allApiCosts.find(c => c.provider === provider && c.model_name === data.model);
                    let costUSD = 0;
                    if (costInfo) {
                        costUSD = (data.input / 1_000_000) * costInfo.input_cost_per_1m
                                + (data.output / 1_000_000) * costInfo.output_cost_per_1m;
                    }

                    return `
                        <tr>
                            <td>${providerIcons[provider]} ${providerNames[provider]}</td>
                            <td>${data.model}</td>
                            <td>${data.input.toLocaleString()}</td>
                            <td>${data.output.toLocaleString()}</td>
                            <td>$${costUSD.toFixed(4)}</td>
                            <td><span class="status-badge active">Ïó∞Í≤∞Îê®</span></td>
                        </tr>
                    `;
                }).join('');

                // Ï¥ù ÎπÑÏö© Í≥ÑÏÇ∞
                let totalCostUSD = 0;
                Object.entries(stats).forEach(([provider, data]) => {
                    const costInfo = allApiCosts.find(c => c.provider === provider && c.model_name === data.model);
                    if (costInfo) {
                        totalCostUSD += (data.input / 1_000_000) * costInfo.input_cost_per_1m
                                      + (data.output / 1_000_000) * costInfo.output_cost_per_1m;
                    }
                });

                // Ï¥ùÍ≥Ñ Ìñâ Ï∂îÍ∞Ä
                const totalInput = Object.values(stats).reduce((sum, d) => sum + d.input, 0);
                const totalOutput = Object.values(stats).reduce((sum, d) => sum + d.output, 0);
                const totalTokensSum = totalInput + totalOutput;
                tbody.innerHTML += `
                    <tr style="background: #f8f9fa; font-weight: 600;">
                        <td colspan="2">üìä Ïù¥Î≤à Îã¨ Ìï©Í≥Ñ</td>
                        <td>${totalInput.toLocaleString()}</td>
                        <td>${totalOutput.toLocaleString()}</td>
                        <td>$${totalCostUSD.toFixed(4)}</td>
                        <td></td>
                    </tr>
                `;

                // ÏÉÅÎã® ÌÜµÍ≥Ñ Ïπ¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('totalInputTokens').textContent = totalInput.toLocaleString();
                document.getElementById('totalOutputTokens').textContent = totalOutput.toLocaleString();
                document.getElementById('totalTokens').textContent = totalTokensSum.toLocaleString();
                document.getElementById('totalCostUSD').textContent = `$${totalCostUSD.toFixed(4)}`;

            } catch (error) {
                console.error('AI ÏÇ¨Ïö©Îüâ ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        async function fetchExchangeRate() {
            try {
                showLoading();
                // ÌïúÍµ≠ÏàòÏ∂úÏûÖÏùÄÌñâ ÌôòÏú® API (Î¨¥Î£å)
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const res = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
                const data = await res.json();

                if (data && data.rates && data.rates.KRW) {
                    const rate = Math.round(data.rates.KRW);
                    document.getElementById('currentExchangeRate').textContent = `‚Ç©${rate.toLocaleString()}`;

                    // Î™®Îì† Î™®Îç∏Ïùò ÌôòÏú® ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
                    if (confirm(`ÌòÑÏû¨ ÌôòÏú®: ‚Ç©${rate.toLocaleString()}/USD\n\nÎ™®Îì† Î™®Îç∏Ïùò ÌôòÏú®ÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                        await fetch(
                            `${SUPABASE_URL}/rest/v1/api_costs`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify({ usd_to_krw_rate: rate })
                            }
                        );
                        showToast(`ÌôòÏú®Ïù¥ ‚Ç©${rate.toLocaleString()}/USDÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
                        loadApiCosts();
                    }
                } else {
                    throw new Error('ÌôòÏú® Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('ÌôòÏú® Ï°∞Ìöå Ïã§Ìå®:', error);
                showToast('ÌôòÏú® Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        function renderApiCosts(costs) {
            const tbody = document.getElementById('apiCostsBody');
            if (!costs || costs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">Îì±Î°ùÎêú Î™®Îç∏Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }

            const providerIcons = { openai: 'üü¢', anthropic: 'üü£', google: 'üîµ', perplexity: 'üü†' };

            tbody.innerHTML = costs.map(cost => {
                const inputKRW = cost.input_cost_per_1m * cost.usd_to_krw_rate * (1 + cost.margin_percent / 100);
                const outputKRW = cost.output_cost_per_1m * cost.usd_to_krw_rate * (1 + cost.margin_percent / 100);
                const isDefault = cost.is_default;
                return `
                    <tr style="${isDefault ? 'background: #f0f7ff;' : ''}">
                        <td>${providerIcons[cost.provider] || '‚ö™'} ${cost.provider}</td>
                        <td>
                            <strong>${cost.model_display_name || cost.model_name}</strong>
                            ${isDefault ? '<span style="background:#0066cc; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:6px;">Í∏∞Î≥∏</span>' : ''}
                            <br><small style="color:#999;">${cost.model_name}</small>
                        </td>
                        <td><small>In: $${cost.input_cost_per_1m.toFixed(2)}<br>Out: $${cost.output_cost_per_1m.toFixed(2)}</small></td>
                        <td>${cost.margin_percent}%</td>
                        <td><small>In: ‚Ç©${Math.round(inputKRW).toLocaleString()}<br>Out: ‚Ç©${Math.round(outputKRW).toLocaleString()}</small></td>
                        <td><span class="status-badge ${cost.is_active ? 'active' : 'inactive'}">${cost.is_active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}</span></td>
                        <td>
                            ${!isDefault ? `<a href="#" class="action-link" style="color:#0066cc;" onclick="setDefaultModel('${cost.id}', '${cost.provider}'); return false;">Í∏∞Î≥∏ÏÑ§Ï†ï</a>` : ''}
                            <a href="#" class="action-link" onclick="editApiCost('${cost.id}'); return false;">ÏàòÏ†ï</a>
                            <a href="#" class="action-link" style="color:#dc3545;" onclick="deleteApiCost('${cost.id}'); return false;">ÏÇ≠Ï†ú</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showApiCostModal(costId = null) {
            document.getElementById('apiCostId').value = '';
            document.getElementById('apiCostProvider').value = '';
            document.getElementById('apiCostModelName').value = '';
            document.getElementById('apiCostDisplayName').value = '';
            document.getElementById('apiCostInput').value = '';
            document.getElementById('apiCostOutput').value = '';
            document.getElementById('apiCostExchangeRate').value = '1450';
            document.getElementById('apiCostMargin').value = '30';
            document.getElementById('apiCostNotes').value = '';
            document.getElementById('apiCostModalTitle').textContent = 'üíµ ÏõêÍ∞Ä Ï∂îÍ∞Ä';
            document.getElementById('apiCostOverlay').style.display = 'flex';
        }

        function closeApiCostModal() {
            document.getElementById('apiCostOverlay').style.display = 'none';
        }

        function editApiCost(id) {
            const cost = allApiCosts.find(c => c.id === id);
            if (!cost) return;

            document.getElementById('apiCostId').value = cost.id;
            document.getElementById('apiCostProvider').value = cost.provider;
            document.getElementById('apiCostModelName').value = cost.model_name;
            document.getElementById('apiCostDisplayName').value = cost.model_display_name || '';
            document.getElementById('apiCostInput').value = cost.input_cost_per_1m;
            document.getElementById('apiCostOutput').value = cost.output_cost_per_1m;
            document.getElementById('apiCostExchangeRate').value = cost.usd_to_krw_rate;
            document.getElementById('apiCostMargin').value = cost.margin_percent;
            document.getElementById('apiCostNotes').value = cost.notes || '';
            document.getElementById('apiCostModalTitle').textContent = 'üíµ ÏõêÍ∞Ä ÏàòÏ†ï';
            document.getElementById('apiCostOverlay').style.display = 'flex';
        }

        async function saveApiCost() {
            const id = document.getElementById('apiCostId').value;
            const data = {
                provider: document.getElementById('apiCostProvider').value,
                model_name: document.getElementById('apiCostModelName').value.trim(),
                model_display_name: document.getElementById('apiCostDisplayName').value.trim() || null,
                input_cost_per_1m: parseFloat(document.getElementById('apiCostInput').value),
                output_cost_per_1m: parseFloat(document.getElementById('apiCostOutput').value),
                usd_to_krw_rate: parseFloat(document.getElementById('apiCostExchangeRate').value),
                margin_percent: parseFloat(document.getElementById('apiCostMargin').value),
                notes: document.getElementById('apiCostNotes').value.trim() || null
            };

            showLoading();
            try {
                const url = id
                    ? `${SUPABASE_URL}/rest/v1/api_costs?id=eq.${id}`
                    : `${SUPABASE_URL}/rest/v1/api_costs`;

                const res = await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('Ï†ÄÏû• Ïã§Ìå®');

                showToast(id ? 'ÏõêÍ∞Ä Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏÉà Î™®Îç∏Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeApiCostModal();
                loadApiCosts();
            } catch (error) {
                console.error('API ÏõêÍ∞Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                showToast('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function setDefaultModel(id, provider) {
            if (!confirm(`Ïù¥ Î™®Îç∏ÏùÑ ${provider}Ïùò Í∏∞Î≥∏ Î™®Îç∏Î°ú ÏÑ§Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            showLoading();
            try {
                // Ìï¥Îãπ providerÏùò Î™®Îì† Î™®Îç∏ is_default = false
                await fetch(
                    `${SUPABASE_URL}/rest/v1/api_costs?provider=eq.${provider}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ is_default: false })
                    }
                );

                // ÏÑ†ÌÉùÌïú Î™®Îç∏Îßå is_default = true
                await fetch(
                    `${SUPABASE_URL}/rest/v1/api_costs?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ is_default: true })
                    }
                );

                showToast('Í∏∞Î≥∏ Î™®Îç∏Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadApiCosts();
            } catch (error) {
                console.error('Í∏∞Î≥∏ Î™®Îç∏ ÏÑ§Ï†ï Ïã§Ìå®:', error);
                showToast('Í∏∞Î≥∏ Î™®Îç∏ ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteApiCost(id) {
            if (!confirm('Ïù¥ Î™®Îç∏Ïùò ÏõêÍ∞Ä Ï†ïÎ≥¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            showLoading();
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/api_costs?id=eq.${id}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!res.ok) throw new Error('ÏÇ≠Ï†ú Ïã§Ìå®');

                showToast('ÏõêÍ∞Ä Ï†ïÎ≥¥Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadApiCosts();
            } catch (error) {
                console.error('API ÏõêÍ∞Ä ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                showToast('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        // User Detail Functions
        function showUserDetail() {
            document.getElementById('userDetailOverlay').style.display = 'flex';
        }

        function closeUserDetail() {
            document.getElementById('userDetailOverlay').style.display = 'none';
        }

        function saveUserStatus() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                showToast('ÌöåÏõê ÏÉÅÌÉúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                closeUserDetail();
            }, 800);
        }

        // Payment Detail Functions
        function showPaymentDetail() {
            document.getElementById('paymentDetailOverlay').style.display = 'flex';
        }

        function closePaymentDetail() {
            document.getElementById('paymentDetailOverlay').style.display = 'none';
        }

        // ================================================================
        // Admin Home Dashboard - Chart Initialization
        // ================================================================

        // Chart.js Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî - Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function initializeAdminHomeCharts() {
            if (!supabaseClient) {
                console.log('‚è≥ Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎåÄÍ∏∞ Ï§ë...');
                setTimeout(initializeAdminHomeCharts, 500);
                return;
            }

            // ÏµúÍ∑º 7Ïùº ÎÇ†Ïßú ÎùºÎ≤® ÏÉùÏÑ±
            const labels = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
            }

            // ÌöåÏõêÍ∞ÄÏûÖ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
            let signupData = [0, 0, 0, 0, 0, 0, 0];
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
                sevenDaysAgo.setHours(0, 0, 0, 0);

                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('created_at')
                    .gte('created_at', sevenDaysAgo.toISOString());

                if (!error && users) {
                    users.forEach(user => {
                        const createdDate = new Date(user.created_at);
                        const dayIndex = Math.floor((createdDate - sevenDaysAgo) / (1000 * 60 * 60 * 24));
                        if (dayIndex >= 0 && dayIndex < 7) {
                            signupData[dayIndex]++;
                        }
                    });
                    console.log('üìä ÌöåÏõêÍ∞ÄÏûÖ Ï∂îÏù¥ Îç∞Ïù¥ÌÑ∞:', signupData);
                }
            } catch (err) {
                console.error('ÌöåÏõêÍ∞ÄÏûÖ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', err);
            }

            // ÌöåÏõê Í∞ÄÏûÖ Ï∂îÏù¥ Ï∞®Ìä∏ (ÎùºÏù∏ Ï∞®Ìä∏)
            const memberSignupCtx = document.getElementById('memberSignupChart');
            if (memberSignupCtx) {
                new Chart(memberSignupCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ïã†Í∑ú Í∞ÄÏûÖ',
                            data: signupData,
                            borderColor: '#6B5CCC',
                            backgroundColor: 'rgba(107, 92, 204, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#6B5CCC',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 12
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Ïã†Í∑ú Í∞ÄÏûÖ: ' + context.parsed.y + 'Î™Ö';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value + 'Î™Ö';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Îß§Ï∂ú Ï∂îÏù¥ - ÌòÑÏû¨ Ï£ºÏ∞® ÎùºÎ≤® ÏÉùÏÑ±
            const currentMonth = today.getMonth() + 1;
            const revenueLabels = [`${currentMonth}Ïõî 1Ï£º`, `${currentMonth}Ïõî 2Ï£º`, `${currentMonth}Ïõî 3Ï£º`, `${currentMonth}Ïõî 4Ï£º`];

            // Îß§Ï∂ú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (deposit_notifications ÌÖåÏù¥Î∏î - install_feeÎßå)
            let revenueData = [0, 0, 0, 0];
            try {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const { data: payments, error } = await supabaseClient
                    .from('deposit_notifications')
                    .select('amount, confirmed_at')
                    .eq('deposit_type', 'install_fee')
                    .eq('status', 'confirmed')
                    .gte('confirmed_at', monthStart.toISOString());

                if (!error && payments) {
                    payments.forEach(payment => {
                        const payDate = new Date(payment.confirmed_at);
                        const weekIndex = Math.floor((payDate.getDate() - 1) / 7);
                        if (weekIndex >= 0 && weekIndex < 4) {
                            revenueData[weekIndex] += (payment.amount || 0);
                        }
                    });
                    console.log('üìä Îß§Ï∂ú Ï∂îÏù¥ Îç∞Ïù¥ÌÑ∞:', revenueData);
                }
            } catch (err) {
                console.error('Îß§Ï∂ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', err);
            }

            // Îß§Ï∂ú Ï∂îÏù¥ Ï∞®Ìä∏ (ÎßâÎåÄ Ï∞®Ìä∏)
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            label: 'Îß§Ï∂ú',
                            data: revenueData,
                            backgroundColor: 'rgba(107, 92, 204, 0.8)',
                            borderColor: '#6B5CCC',
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 12
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Îß§Ï∂ú: ‚Ç©' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return '‚Ç©' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminHomeCharts();
        });

        // ÎåÄÏãúÎ≥¥Îìú Ìôà ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        async function initializeDashboardHomeStats() {
            if (!supabaseClient) {
                console.log('‚è≥ Supabase ÎØ∏Ï¥àÍ∏∞Ìôî, 1Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ...');
                setTimeout(initializeDashboardHomeStats, 1000);
                return;
            }

            try {
                // 1. Ï¥ù ÌöåÏõê Ïàò Î°úÎìú
                const { data: usersData, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id', { count: 'exact' });

                if (!usersError && usersData) {
                    const totalUsers = usersData.length;
                    const overviewTotalElem = document.getElementById('overviewTotalUsers');
                    if (overviewTotalElem) {
                        overviewTotalElem.textContent = totalUsers;
                        console.log('‚úÖ Ï¥ù ÌöåÏõê Ïàò Î°úÎìú:', totalUsers);
                    }
                }

                // 2. ÎØ∏Ï≤òÎ¶¨ Î¨∏Ïùò Î∞∞ÏßÄ Î°úÎìú
                const { data: inquiriesData } = await supabaseClient
                    .from('inquiries')
                    .select('status');

                if (inquiriesData) {
                    const pending = inquiriesData.filter(i => i.status === 'pending').length;

                    // ÏÇ¨Ïù¥ÎìúÎ∞î Î∞∞ÏßÄ
                    const badge = document.getElementById('inquiryBadge');
                    if (badge) {
                        if (pending > 0) {
                            badge.textContent = pending;
                            badge.style.display = 'inline-flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }

                    // Ìôà ÌôîÎ©¥ ÎØ∏Ï≤òÎ¶¨ Î¨∏Ïùò Ïπ¥Îìú
                    const overviewPending = document.getElementById('overviewPendingInquiries');
                    if (overviewPending) {
                        overviewPending.textContent = pending;
                    }

                    const overviewUrgent = document.getElementById('overviewUrgentCount');
                    if (overviewUrgent) {
                        overviewUrgent.textContent = pending > 0 ? `${pending}Í±¥ ÎåÄÍ∏∞Ï§ë` : 'ÏóÜÏùå';
                    }

                    console.log('‚úÖ Í≥†Í∞ùÏÑºÌÑ∞ ÎØ∏Ï≤òÎ¶¨ Î¨∏Ïùò:', pending);
                }

                // 3. Ïç®ÎãàÏóêÍ≤å Î¨ªÍ∏∞ Î∞∞ÏßÄ Î°úÎìú
                const { data: sunnyData } = await supabaseClient
                    .from('sunny_inquiries')
                    .select('status');

                if (sunnyData) {
                    const sunnyPending = sunnyData.filter(i => i.status === 'pending').length;

                    // ÏÇ¨Ïù¥ÎìúÎ∞î Î∞∞ÏßÄ
                    const sunnyBadge = document.getElementById('sunnyInquiryBadge');
                    if (sunnyBadge) {
                        if (sunnyPending > 0) {
                            sunnyBadge.textContent = sunnyPending;
                            sunnyBadge.style.display = 'inline-flex';
                        } else {
                            sunnyBadge.style.display = 'none';
                        }
                    }

                    // Ìôà ÌôîÎ©¥ Ïç®Îãà Î¨∏Ïùò Ïπ¥Îìú
                    const overviewSunnyPending = document.getElementById('overviewSunnyPending');
                    if (overviewSunnyPending) {
                        overviewSunnyPending.textContent = sunnyPending;
                    }

                    const overviewSunnyCount = document.getElementById('overviewSunnyCount');
                    if (overviewSunnyCount) {
                        overviewSunnyCount.textContent = sunnyPending > 0 ? `${sunnyPending}Í±¥ ÎåÄÍ∏∞Ï§ë` : 'ÏóÜÏùå';
                    }

                    console.log('‚úÖ Ïç®ÎãàÏóêÍ≤å Î¨ªÍ∏∞ ÎØ∏Ï≤òÎ¶¨:', sunnyPending);
                }
            } catch (e) {
                console.error('ÎåÄÏãúÎ≥¥Îìú Ìôà ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', e);
            }
        }

        // ========== Supabase Ïó∞Í≤∞ ==========
        const SUPABASE_URL = 'https://zwjmfewyshhwpgwdtrus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3am1mZXd5c2hod3Bnd2R0cnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzE1NTEsImV4cCI6MjA3OTE0NzU1MX0.AJy34h5VR8QS6WFEcUcBeJJu8I3bBQ6UCk1I84Wb7y4';
        const SUPABASE_KEY = SUPABASE_ANON_KEY; // REST API Ìò∏Ï∂úÏö© alias

        // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
        let supabaseClient;

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ Ï¥àÍ∏∞Ìôî
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            // ÎåÄÏãúÎ≥¥Îìú Ìôà ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî
            initializeDashboardHomeStats();
        } else {
            console.error('‚ùå Supabase ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }

        // ========== Í≥µÏßÄÏÇ¨Ìï≠ CRUD Ìï®Ïàò ==========

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ Î™©Î°ù Î°úÎìú
         */
        async function loadNotices() {
            console.log('üìã loadNotices Ìò∏Ï∂úÎê®');
            console.log('  - Supabase Client:', supabaseClient ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê®' : '‚ùå ÏóÜÏùå');

            try {
                showLoading();

                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                console.log('üì§ Supabase SELECT ÏöîÏ≤≠ Ï†ÑÏÜ° Ï§ë...');

                const { data, error } = await supabaseClient
                    .from('notices')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('üì• Supabase ÏùëÎãµ:', { count: data?.length, error });

                if (error) throw error;

                console.log('‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ Î°úÎìú ÏÑ±Í≥µ:', data.length, 'Í∞ú');
                renderNoticeTable(data);
                updateNoticeStats(data);

                hideLoading();
            } catch (error) {
                console.error('‚ùå Í≥µÏßÄÏÇ¨Ìï≠ Î°úÎìú Ïò§Î•ò:', error);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                hideLoading();
            }
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
         */
        function renderNoticeTable(notices) {
            const tbody = document.getElementById('noticesTableBody');
            if (!tbody) {
                console.error('noticesTableBodyÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            if (!notices || notices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }

            tbody.innerHTML = notices.map(notice => {
                const importanceBadge = notice.important
                    ? '<span class="status-badge" style="background: #dc3545; color: white;">Ï§ëÏöî</span>'
                    : '<span class="status-badge" style="background: #6c757d; color: white;">ÏùºÎ∞ò</span>';

                const createdDate = new Date(notice.created_at).toLocaleDateString('ko-KR');
                const safeTitle = sanitizePlainText(notice.title);
                const escapedTitle = safeTitle.replace(/'/g, "\\'");

                return `
                    <tr data-notice-id="${notice.id}">
                        <td>${importanceBadge}</td>
                        <td>${safeTitle}</td>
                        <td>${createdDate}</td>
                        <td><span class="status-badge active">Í≤åÏãúÏ§ë</span></td>
                        <td>-</td>
                        <td>
                            <a href="#" class="action-link" onclick="event.preventDefault(); editNotice('${notice.id}')">ÏàòÏ†ï</a>
                            <a href="#" class="action-link" style="color: var(--danger);" onclick="event.preventDefault(); deleteNotice('${notice.id}', '${escapedTitle}')">ÏÇ≠Ï†ú</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
         */
        function updateNoticeStats(notices) {
            const totalCount = notices.length;
            const importantCount = notices.filter(n => n.important).length;

            const totalElem = document.getElementById('noticeCountTotal');
            const publishedElem = document.getElementById('noticeCountPublished');
            const importantElem = document.getElementById('noticeCountImportant');

            if (totalElem) totalElem.textContent = totalCount;
            if (publishedElem) publishedElem.textContent = totalCount; // Í≤åÏãúÏ§ë (Ï†ÑÏ≤¥)
            if (importantElem) importantElem.textContent = importantCount;
        }

        // ÌòÑÏû¨ ÏàòÏ†ï Ï§ëÏù∏ Í≥µÏßÄÏÇ¨Ìï≠ ID
        let currentEditingNoticeId = null;

        /**
         * ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Ï∂îÍ∞Ä Ìèº ÌëúÏãú
         */
        function showNoticeForm() {
            console.log('üìù showNoticeForm Ìò∏Ï∂úÎê®');

            // Î™®Îã¨ Ï¥àÍ∏∞Ìôî
            currentEditingNoticeId = null;
            document.getElementById('noticeModalTitle').textContent = 'üìù Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±';
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.querySelector('input[name="importance"][value="normal"]').checked = true;

            // Î™®Îã¨ ÌëúÏãú
            const modal = document.getElementById('noticeModal');
            modal.style.display = 'flex';
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ Î™®Îã¨ Îã´Í∏∞
         */
        function closeNoticeModal() {
            document.getElementById('noticeModal').style.display = 'none';
            currentEditingNoticeId = null;
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
         */
        function handleNoticeSubmit(event) {
            event.preventDefault();

            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();
            const important = document.querySelector('input[name="importance"]:checked').value === 'important';

            console.log('Ìèº Ï†úÏ∂ú:', { title, content, important, editingId: currentEditingNoticeId });

            if (currentEditingNoticeId) {
                // ÏàòÏ†ï Î™®Îìú
                updateNotice(currentEditingNoticeId, title, content, important);
            } else {
                // ÏÉùÏÑ± Î™®Îìú
                createNotice(title, content, important);
            }

            closeNoticeModal();
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÏÉùÏÑ±
         */
        async function createNotice(title, content, important) {
            console.log('üöÄ createNotice Ìò∏Ï∂úÎê®');
            console.log('  - Ï†úÎ™©:', title);
            console.log('  - ÎÇ¥Ïö©:', content);
            console.log('  - Ï§ëÏöî:', important);
            console.log('  - Supabase Client:', supabaseClient ? '‚úÖ Ï¥àÍ∏∞ÌôîÎê®' : '‚ùå ÏóÜÏùå');

            try {
                showLoading();

                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                console.log('üì§ Supabase INSERT ÏöîÏ≤≠ Ï†ÑÏÜ° Ï§ë...');

                const { data, error } = await supabaseClient
                    .from('notices')
                    .insert([
                        {
                            title: title,
                            content: content,
                            important: important
                        }
                    ])
                    .select();

                console.log('üì• Supabase ÏùëÎãµ:', { data, error });

                if (error) throw error;

                console.log('‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ ÏÉùÏÑ± ÏÑ±Í≥µ:', data);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadNotices(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®

                hideLoading();
            } catch (error) {
                console.error('‚ùå Í≥µÏßÄÏÇ¨Ìï≠ ÏÉùÏÑ± Ïò§Î•ò:', error);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠ Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                hideLoading();
            }
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï Ìèº ÌëúÏãú
         */
        async function editNotice(noticeId) {
            console.log('‚úèÔ∏è  editNotice Ìò∏Ï∂úÎê®, ID:', noticeId);

            try {
                showLoading();

                // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const { data: existingNotice, error: fetchError } = await supabaseClient
                    .from('notices')
                    .select('*')
                    .eq('id', noticeId)
                    .single();

                if (fetchError) throw fetchError;

                console.log('Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞:', existingNotice);

                hideLoading();

                // Î™®Îã¨Ïóê Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                currentEditingNoticeId = noticeId;
                document.getElementById('noticeModalTitle').textContent = '‚úèÔ∏è Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï';
                document.getElementById('noticeTitle').value = existingNotice.title;
                document.getElementById('noticeContent').value = existingNotice.content;

                if (existingNotice.important) {
                    document.querySelector('input[name="importance"][value="important"]').checked = true;
                } else {
                    document.querySelector('input[name="importance"][value="normal"]').checked = true;
                }

                // Î™®Îã¨ ÌëúÏãú
                document.getElementById('noticeModal').style.display = 'flex';

            } catch (error) {
                console.error('‚ùå Í≥µÏßÄÏÇ¨Ìï≠ Ï°∞Ìöå Ïò§Î•ò:', error);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                hideLoading();
            }
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï (Ïã§Ï†ú ÏóÖÎç∞Ïù¥Ìä∏)
         */
        async function updateNotice(noticeId, title, content, important) {
            console.log('üîÑ updateNotice Ìò∏Ï∂úÎê®');
            console.log('  - ID:', noticeId);
            console.log('  - Ï†úÎ™©:', title);
            console.log('  - ÎÇ¥Ïö©:', content);
            console.log('  - Ï§ëÏöî:', important);

            try {
                showLoading();

                const { error } = await supabaseClient
                    .from('notices')
                    .update({
                        title: title,
                        content: content,
                        important: important,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', noticeId);

                if (error) throw error;

                console.log('‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï ÏÑ±Í≥µ');
                showToast('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadNotices(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®

                hideLoading();
            } catch (error) {
                console.error('‚ùå Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï Ïò§Î•ò:', error);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                hideLoading();
            }
        }

        /**
         * Í≥µÏßÄÏÇ¨Ìï≠ ÏÇ≠Ï†ú
         */
        async function deleteNotice(noticeId, title) {
            if (!confirm(`"${title}" Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏÇ≠Ï†úÎêú Îç∞Ïù¥ÌÑ∞Îäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                showLoading();

                const { error } = await supabaseClient
                    .from('notices')
                    .delete()
                    .eq('id', noticeId);

                if (error) throw error;

                showToast('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadNotices(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®

                hideLoading();
            } catch (error) {
                console.error('Í≥µÏßÄÏÇ¨Ìï≠ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('Í≥µÏßÄÏÇ¨Ìï≠ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                hideLoading();
            }
        }

        // ================================================
        // ÌïôÏäµÏö© ÏΩòÌÖêÏ∏† Í¥ÄÎ¶¨ Í∏∞Îä•
        // ================================================

        /**
         * ÌïôÏäµ ÏΩòÌÖêÏ∏† Î°úÎìú
         */
        async function loadLearningContents() {
            console.log('üìö ÌïôÏäµ ÏΩòÌÖêÏ∏† Î°úÎìú ÏãúÏûë');

            try {
                showLoading();

                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                const { data, error } = await supabaseClient
                    .from('learning_contents')
                    .select('*')
                    .order('depth1')
                    .order('depth2')
                    .order('display_order');

                if (error) throw error;

                console.log('‚úÖ ÌïôÏäµ ÏΩòÌÖêÏ∏† Î°úÎìú ÏÑ±Í≥µ:', data.length, 'Í∞ú');
                renderLearningTree(data);
                updateLearningStats(data);

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÌïôÏäµ ÏΩòÌÖêÏ∏† Î°úÎìú Ïò§Î•ò:', error);
                showToast('ÌïôÏäµ ÏΩòÌÖêÏ∏†Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                hideLoading();
            }
        }

        /**
         * ÌïôÏäµ ÏΩòÌÖêÏ∏† ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
         */
        function updateLearningStats(contents) {
            const depth1Set = new Set(contents.map(c => c.depth1));
            const depth2Set = new Set(contents.filter(c => c.depth2).map(c => `${c.depth1}::${c.depth2}`));
            const depth3Count = contents.filter(c => c.depth3).length;

            const depth1Elem = document.getElementById('depth1Count');
            const depth2Elem = document.getElementById('depth2Count');
            const depth3Elem = document.getElementById('depth3Count');

            if (depth1Elem) depth1Elem.textContent = depth1Set.size;
            if (depth2Elem) depth2Elem.textContent = depth2Set.size;
            if (depth3Elem) depth3Elem.textContent = depth3Count;
        }

        /**
         * Ìä∏Î¶¨ Íµ¨Ï°∞Î°ú Î†åÎçîÎßÅ (CRUD Î≤ÑÌäº Ìè¨Ìï®)
         */
        function renderLearningTree(contents) {
            const treeContainer = document.getElementById('learningContentTree');
            if (!treeContainer) return;

            // HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ìï®Ïàò
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            // depth1Î≥ÑÎ°ú Í∑∏Î£πÌôî
            const depth1Groups = {};
            contents.forEach(item => {
                if (!depth1Groups[item.depth1]) {
                    depth1Groups[item.depth1] = [];
                }
                depth1Groups[item.depth1].push(item);
            });

            let html = '';

            Object.keys(depth1Groups).sort().forEach(depth1Name => {
                const escapedDepth1 = depth1Name.replace(/'/g, "\\'");
                const depth1Items = depth1Groups[depth1Name];

                // depth2Î≥ÑÎ°ú Í∑∏Î£πÌôî
                const depth2Groups = {};
                depth1Items.forEach(item => {
                    if (item.depth2) {
                        if (!depth2Groups[item.depth2]) {
                            depth2Groups[item.depth2] = [];
                        }
                        depth2Groups[item.depth2].push(item);
                    }
                });

                html += `
                    <div class="tree-depth1">
                        <div class="tree-item depth1-item">
                            <span class="tree-arrow" onclick="toggleTreeItem(this.parentElement)">‚ñ∂</span>
                            <span class="tree-icon">üìÅ</span>
                            <span class="tree-name" onclick="toggleTreeItem(this.parentElement)">${escapeHtml(depth1Name)}</span>
                            <div class="tree-actions">
                                <button class="tree-btn add" onclick="showAddLearningDepth2Form('${escapedDepth1}')" title="Ï§ëÎ∂ÑÎ•ò Ï∂îÍ∞Ä">+</button>
                                <button class="tree-btn edit" onclick="editLearningDepth1('${escapedDepth1}')" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                                <button class="tree-btn delete" onclick="deleteLearningDepth1('${escapedDepth1}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="tree-children" style="display: none;">
                `;

                // depth2 Î†åÎçîÎßÅ
                Object.keys(depth2Groups).sort().forEach(depth2Name => {
                    const escapedDepth2 = depth2Name.replace(/'/g, "\\'");
                    const depth2Items = depth2Groups[depth2Name];

                    html += `
                        <div class="tree-depth2">
                            <div class="tree-item depth2-item">
                                <span class="tree-arrow" onclick="toggleTreeItem(this.parentElement)">‚ñ∂</span>
                                <span class="tree-icon">üìÇ</span>
                                <span class="tree-name" onclick="toggleTreeItem(this.parentElement)">${escapeHtml(depth2Name)}</span>
                                <div class="tree-actions">
                                    <button class="tree-btn add" onclick="showAddLearningDepth3Form('${escapedDepth1}', '${escapedDepth2}')" title="ÏÜåÎ∂ÑÎ•ò Ï∂îÍ∞Ä">+</button>
                                    <button class="tree-btn edit" onclick="editLearningDepth2('${escapedDepth1}', '${escapedDepth2}')" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                                    <button class="tree-btn delete" onclick="deleteLearningDepth2('${escapedDepth1}', '${escapedDepth2}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="tree-children" style="display: none;">
                    `;

                    // depth3 Î†åÎçîÎßÅ (CRUD Î≤ÑÌäº Ìè¨Ìï®)
                    depth2Items
                        .filter(item => item.depth3)
                        .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
                        .forEach(item => {
                            // titleÏù¥ ÏûàÏúºÎ©¥ title ÌëúÏãú, ÏóÜÏúºÎ©¥ depth3 ÌëúÏãú
                            const displayName = item.title || item.depth3;
                            const urlStatus = item.url ? `<span style="color: #28a745; font-size: 11px; margin-left: 8px;">‚úì Ïó∞Í≤∞Îê®</span>` : `<span style="color: #dc3545; font-size: 11px; margin-left: 8px;">ÎØ∏Ïó∞Í≤∞</span>`;
                            html += `
                                <div class="tree-depth3">
                                    <div class="tree-item depth3-item">
                                        <span class="tree-icon">üìÑ</span>
                                        <span class="tree-name">${escapeHtml(displayName)}</span>
                                        ${urlStatus}
                                        <div class="tree-actions">
                                            <button class="tree-btn edit" onclick="editLearningDepth3('${item.id}')" title="ÏàòÏ†ï">‚úèÔ∏è</button>
                                            <button class="tree-btn delete" onclick="deleteLearningItem('${item.id}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            treeContainer.innerHTML = html;
        }

        /**
         * Ìä∏Î¶¨ Ìï≠Î™© ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞
         */
        function toggleTreeItem(element) {
            const arrow = element.querySelector('.tree-arrow');
            const children = element.parentElement.querySelector('.tree-children');

            if (children) {
                if (children.style.display === 'none') {
                    children.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    children.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }

        // ================================================
        // ÌïôÏäµÏΩòÌÖêÏ∏† CRUD Ìï®ÏàòÎì§ (DB Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨Ïö©)
        // ================================================

        /**
         * ÎåÄÎ∂ÑÎ•ò(Depth1) Ï∂îÍ∞Ä Ìèº ÌëúÏãú
         */
        function showAddLearningDepth1Form() {
            const depth1Name = prompt('ÏÉà ÎåÄÎ∂ÑÎ•ò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (depth1Name && depth1Name.trim()) {
                createLearningDepth1(depth1Name.trim());
            }
        }

        /**
         * ÎåÄÎ∂ÑÎ•ò ÏÉùÏÑ±
         */
        async function createLearningDepth1(depth1Name) {
            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .insert({
                        depth1: depth1Name,
                        depth2: null,
                        depth3: null,
                        title: null,
                        url: null,
                        display_order: 0
                    });

                if (error) throw error;

                showToast('ÎåÄÎ∂ÑÎ•òÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('ÎåÄÎ∂ÑÎ•ò Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                showToast('ÎåÄÎ∂ÑÎ•ò Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Ï§ëÎ∂ÑÎ•ò(Depth2) Ï∂îÍ∞Ä Ìèº ÌëúÏãú
         */
        function showAddLearningDepth2Form(depth1Name) {
            const depth2Name = prompt(`[${depth1Name}]Ïóê Ï∂îÍ∞ÄÌï† Ï§ëÎ∂ÑÎ•ò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`);
            if (depth2Name && depth2Name.trim()) {
                createLearningDepth2(depth1Name, depth2Name.trim());
            }
        }

        /**
         * Ï§ëÎ∂ÑÎ•ò ÏÉùÏÑ±
         */
        async function createLearningDepth2(depth1Name, depth2Name) {
            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .insert({
                        depth1: depth1Name,
                        depth2: depth2Name,
                        depth3: null,
                        title: null,
                        url: null,
                        display_order: 0
                    });

                if (error) throw error;

                showToast('Ï§ëÎ∂ÑÎ•òÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('Ï§ëÎ∂ÑÎ•ò Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                showToast('Ï§ëÎ∂ÑÎ•ò Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * ÏÜåÎ∂ÑÎ•ò(Depth3) Ï∂îÍ∞Ä Ìèº ÌëúÏãú
         */
        function showAddLearningDepth3Form(depth1Name, depth2Name) {
            const depth3Name = prompt(`[${depth1Name} > ${depth2Name}]Ïóê Ï∂îÍ∞ÄÌï† ÏÜåÎ∂ÑÎ•ò(ÏΩòÌÖêÏ∏†) Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`);
            if (depth3Name && depth3Name.trim()) {
                const title = prompt('ÏΩòÌÖêÏ∏† Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉù):') || null;
                const url = prompt('GitHub Raw URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (HTML ÌååÏùº URL):');
                createLearningDepth3(depth1Name, depth2Name, depth3Name.trim(), title, url);
            }
        }

        /**
         * ÏÜåÎ∂ÑÎ•ò ÏÉùÏÑ±
         */
        async function createLearningDepth3(depth1Name, depth2Name, depth3Name, title, url) {
            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .insert({
                        depth1: depth1Name,
                        depth2: depth2Name,
                        depth3: depth3Name,
                        title: title,
                        url: url || null,
                        display_order: 0
                    });

                if (error) throw error;

                showToast('ÏΩòÌÖêÏ∏†Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('ÏΩòÌÖêÏ∏† Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                showToast('ÏΩòÌÖêÏ∏† Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * ÎåÄÎ∂ÑÎ•ò ÏàòÏ†ï
         */
        async function editLearningDepth1(oldDepth1Name) {
            const newDepth1Name = prompt('ÏÉà ÎåÄÎ∂ÑÎ•ò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', oldDepth1Name);
            if (newDepth1Name && newDepth1Name.trim() && newDepth1Name !== oldDepth1Name) {
                try {
                    showLoading();
                    const { error } = await supabaseClient
                        .from('learning_contents')
                        .update({ depth1: newDepth1Name.trim() })
                        .eq('depth1', oldDepth1Name);

                    if (error) throw error;

                    showToast('ÎåÄÎ∂ÑÎ•òÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadLearningContents();
                } catch (error) {
                    console.error('ÎåÄÎ∂ÑÎ•ò ÏàòÏ†ï Ïò§Î•ò:', error);
                    showToast('ÎåÄÎ∂ÑÎ•ò ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        /**
         * Ï§ëÎ∂ÑÎ•ò ÏàòÏ†ï
         */
        async function editLearningDepth2(depth1Name, oldDepth2Name) {
            const newDepth2Name = prompt('ÏÉà Ï§ëÎ∂ÑÎ•ò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', oldDepth2Name);
            if (newDepth2Name && newDepth2Name.trim() && newDepth2Name !== oldDepth2Name) {
                try {
                    showLoading();
                    const { error } = await supabaseClient
                        .from('learning_contents')
                        .update({ depth2: newDepth2Name.trim() })
                        .eq('depth1', depth1Name)
                        .eq('depth2', oldDepth2Name);

                    if (error) throw error;

                    showToast('Ï§ëÎ∂ÑÎ•òÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadLearningContents();
                } catch (error) {
                    console.error('Ï§ëÎ∂ÑÎ•ò ÏàòÏ†ï Ïò§Î•ò:', error);
                    showToast('Ï§ëÎ∂ÑÎ•ò ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        /**
         * ÏÜåÎ∂ÑÎ•ò(ÏΩòÌÖêÏ∏†) ÏàòÏ†ï
         */
        async function editLearningDepth3(id) {
            try {
                // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                const { data, error: fetchError } = await supabaseClient
                    .from('learning_contents')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                const newDepth3 = prompt('ÏÜåÎ∂ÑÎ•ò Ïù¥Î¶Ñ:', data.depth3);
                if (!newDepth3) return;

                const newTitle = prompt('Ï†úÎ™© (ÏÑ†ÌÉù):', data.title || '');
                const newUrl = prompt('GitHub Raw URL:', data.url || '');
                const newOrder = prompt('ÌëúÏãú ÏàúÏÑú:', data.display_order || '0');

                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .update({
                        depth3: newDepth3.trim(),
                        title: newTitle || null,
                        url: newUrl || null,
                        display_order: parseInt(newOrder) || 0
                    })
                    .eq('id', id);

                if (error) throw error;

                showToast('ÏΩòÌÖêÏ∏†Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('ÏΩòÌÖêÏ∏† ÏàòÏ†ï Ïò§Î•ò:', error);
                showToast('ÏΩòÌÖêÏ∏† ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * ÎåÄÎ∂ÑÎ•ò ÏÇ≠Ï†ú (Ìï¥Îãπ ÎåÄÎ∂ÑÎ•òÏùò Î™®Îì† Ìï≠Î™© ÏÇ≠Ï†ú)
         */
        async function deleteLearningDepth1(depth1Name) {
            if (!confirm(`"${depth1Name}" ÎåÄÎ∂ÑÎ•òÏôÄ ÌïòÏúÑ Î™®Îì† Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) return;

            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .delete()
                    .eq('depth1', depth1Name);

                if (error) throw error;

                showToast('ÎåÄÎ∂ÑÎ•òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('ÎåÄÎ∂ÑÎ•ò ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('ÎåÄÎ∂ÑÎ•ò ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Ï§ëÎ∂ÑÎ•ò ÏÇ≠Ï†ú (Ìï¥Îãπ Ï§ëÎ∂ÑÎ•òÏùò Î™®Îì† Ìï≠Î™© ÏÇ≠Ï†ú)
         */
        async function deleteLearningDepth2(depth1Name, depth2Name) {
            if (!confirm(`"${depth2Name}" Ï§ëÎ∂ÑÎ•òÏôÄ ÌïòÏúÑ Î™®Îì† Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) return;

            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .delete()
                    .eq('depth1', depth1Name)
                    .eq('depth2', depth2Name);

                if (error) throw error;

                showToast('Ï§ëÎ∂ÑÎ•òÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('Ï§ëÎ∂ÑÎ•ò ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('Ï§ëÎ∂ÑÎ•ò ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Í∞úÎ≥Ñ Ìï≠Î™© ÏÇ≠Ï†ú
         */
        async function deleteLearningItem(id) {
            if (!confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('learning_contents')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                loadLearningContents();
            } catch (error) {
                console.error('Ìï≠Î™© ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('Ìï≠Î™© ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==========================================================================
        // ÌöåÏõê Í¥ÄÎ¶¨ CRUD Ìï®Ïàò (Agenda #4)
        // ==========================================================================

        // Ï†ÑÏ≤¥ ÌöåÏõê Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú
        let allUsersData = [];

        /**
         * ÌöåÏõê Î™©Î°ù Î°úÎìú
         */
        async function loadUsers() {
            console.log('üìã loadUsers Ìò∏Ï∂úÎê®');

            try {
                showLoading();

                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                console.log('üì§ Supabase SELECT ÏöîÏ≤≠ Ï†ÑÏÜ° Ï§ë (users ÌÖåÏù¥Î∏î)...');

                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('üì• Supabase ÏùëÎãµ:', { count: data?.length, error });

                if (error) throw error;

                console.log('‚úÖ ÌöåÏõê Î™©Î°ù Î°úÎìú ÏÑ±Í≥µ:', data.length, 'Î™Ö');
                allUsersData = data;
                renderUsersTable(data);
                updateUserStats(data);

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÌöåÏõê Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                showToast('ÌöåÏõê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');

                const tbody = document.getElementById('usersTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px; color: #dc3545;">‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}</td></tr>`;
                }

                hideLoading();
            }
        }

        /**
         * ÌöåÏõê ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
         */
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) {
                console.error('usersTableBodyÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px;">Îì±Î°ùÎêú ÌöåÏõêÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                // ÏÉÅÌÉú Î±ÉÏßÄ
                const statusBadge = getStatusBadge(user.subscription_status);

                // Í∞ÄÏûÖÏùº Ìè¨Îß∑
                const createdDate = user.created_at
                    ? new Date(user.created_at).toLocaleDateString('ko-KR')
                    : '-';

                // ÌÅ¨Î†àÎîß Ìè¨Îß∑
                const creditDisplay = user.credit_balance
                    ? user.credit_balance.toLocaleString()
                    : '0';

                // ÎãâÎÑ§ÏûÑ (ÏóÜÏúºÎ©¥ name, real_name, Ïù¥Î©îÏùº ÏïûÎ∂ÄÎ∂Ñ ÏàúÏÑúÎ°ú)
                const displayName = user.nickname || user.name || user.real_name || (user.email ? user.email.split('@')[0] : '-');
                const safeDisplayName = sanitizePlainText(displayName);

                // ÌöåÏõê ID (8ÏûêÎ¶¨ ÎûúÎç§ ÏòÅÏà´Ïûê)
                const userId = user.user_id || '-';

                // ÎπåÎçî Í≥ÑÏ†ï ID (12ÏûêÎ¶¨: YYMMNNNNNNXX ÌòïÏãù)
                const devAccountId = user.builder_id || '-';

                return `
                    <tr data-user-id="${user.id}">
                        <td><code style="background: #e8f4fc; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${userId}</code></td>
                        <td><code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${devAccountId}</code></td>
                        <td>${sanitizePlainText(user.email || '-')}</td>
                        <td>${safeDisplayName}</td>
                        <td>${sanitizePlainText(user.real_name || '-')}</td>
                        <td>${statusBadge}</td>
                        <td style="text-align: right; font-weight: 500;">${creditDisplay}</td>
                        <td>${createdDate}</td>
                        <td>
                            <a href="#" class="action-link" onclick="event.preventDefault(); showUserDetailById('${user.id}')">ÏÉÅÏÑ∏</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * ÏÉÅÌÉú Î±ÉÏßÄ ÏÉùÏÑ±
         */
        function getStatusBadge(status) {
            const statusStyles = {
                'active': { class: 'active', text: 'ÌôúÏÑ±' },
                'inactive': { class: '', style: 'background: #6c757d; color: white;', text: 'ÎπÑÌôúÏÑ±' },
                'suspended': { class: 'pending', text: 'Ï†ïÏßÄ' },
                'pending': { class: '', style: 'background: #ffc107; color: #000;', text: 'ÎåÄÍ∏∞' }
            };

            const style = statusStyles[status?.toLowerCase()] || statusStyles['inactive'];

            if (style.class) {
                return `<span class="status-badge ${style.class}">${style.text}</span>`;
            } else {
                return `<span class="status-badge" style="${style.style}">${style.text}</span>`;
            }
        }

        /**
         * ÌöåÏõê ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
         */
        function updateUserStats(users) {
            const totalCount = users.length;
            const activeCount = users.filter(u => u.subscription_status === 'active').length;
            const paidCount = users.filter(u => u.installation_fee_paid === true).length;
            const totalCredits = users.reduce((sum, u) => sum + (u.credit_balance || 0), 0);

            // ÌöåÏõê Í¥ÄÎ¶¨ ÌÉ≠ ÌÜµÍ≥Ñ
            const totalElem = document.getElementById('totalUsersCount');
            const activeElem = document.getElementById('activeUsersCount');
            const paidElem = document.getElementById('paidUsersCount');
            const creditsElem = document.getElementById('totalCreditsCount');

            if (totalElem) totalElem.textContent = totalCount;
            if (activeElem) activeElem.textContent = activeCount;
            if (paidElem) paidElem.textContent = paidCount;
            if (creditsElem) creditsElem.textContent = totalCredits.toLocaleString();

            // ÎåÄÏãúÎ≥¥Îìú Ìôà ÌÜµÍ≥ÑÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const overviewTotalElem = document.getElementById('overviewTotalUsers');
            if (overviewTotalElem) overviewTotalElem.textContent = totalCount;
        }

        /**
         * ÌöåÏõê Í≤ÄÏÉâ
         */
        function searchUsers() {
            const searchInput = document.getElementById('userSearchInput');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

            if (!searchTerm) {
                // Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Î™©Î°ù ÌëúÏãú
                renderUsersTable(allUsersData);
                return;
            }

            // Ïù¥Î©îÏùº, ÎãâÎÑ§ÏûÑ, ÌöåÏõê ID, ÎπåÎçî Í≥ÑÏ†ï IDÎ°ú ÌïÑÌÑ∞ÎßÅ
            const filtered = allUsersData.filter(user => {
                const email = (user.email || '').toLowerCase();
                const nickname = (user.nickname || '').toLowerCase();
                const realName = (user.real_name || '').toLowerCase();
                const userId = (user.user_id || '').toLowerCase();
                const builderId = (user.builder_id || '').toLowerCase();

                return email.includes(searchTerm) ||
                       nickname.includes(searchTerm) ||
                       realName.includes(searchTerm) ||
                       userId.includes(searchTerm) ||
                       builderId.includes(searchTerm);
            });

            console.log(`üîç Í≤ÄÏÉâ Í≤∞Í≥º: "${searchTerm}" ‚Üí ${filtered.length}Î™Ö`);
            renderUsersTable(filtered);

            if (filtered.length === 0) {
                showToast(`"${searchTerm}" Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.`, 'info');
            }
        }

        // ÌòÑÏû¨ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ï§ëÏù∏ ÌöåÏõê Îç∞Ïù¥ÌÑ∞
        let currentDetailUser = null;

        /**
         * ÌöåÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú (IDÎ°ú Ï°∞Ìöå)
         */
        async function showUserDetailById(userId) {
            console.log('üë§ ÌöåÏõê ÏÉÅÏÑ∏ Ï°∞Ìöå:', userId);

            try {
                showLoading();

                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                currentDetailUser = data;
                renderUserDetailModal(data);
                document.getElementById('userDetailOverlay').style.display = 'flex';

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÌöåÏõê ÏÉÅÏÑ∏ Ï°∞Ìöå Ïò§Î•ò:', error);
                showToast('ÌöåÏõê Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                hideLoading();
            }
        }

        /**
         * ÌöåÏõê ÏÉÅÏÑ∏ Î™®Îã¨ Î†åÎçîÎßÅ
         */
        function renderUserDetailModal(user) {
            // Î™®Îã¨ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            const headerElem = document.getElementById('userDetailHeader');
            if (headerElem) {
                headerElem.textContent = `üë§ ÌöåÏõê ÏÉÅÏÑ∏ - ${user.builder_id || user.user_id || user.email}`;
            }

            // ÌöåÏõê ID (8ÏûêÎ¶¨ ÎûúÎç§ ÏòÅÏà´Ïûê)
            const memberIdElem = document.getElementById('userDetailMemberId');
            if (memberIdElem) {
                memberIdElem.innerHTML = user.user_id
                    ? `<code style="background: #e8f4fc; padding: 2px 6px; border-radius: 4px;">${user.user_id}</code>`
                    : '-';
            }

            // ÎπåÎçî Í≥ÑÏ†ï ID (12ÏûêÎ¶¨: YYMMNNNNNNXX ÌòïÏãù)
            const userIdElem = document.getElementById('userDetailUserId');
            if (userIdElem) {
                userIdElem.innerHTML = user.builder_id
                    ? `<code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${user.builder_id}</code>`
                    : '-';
            }

            // Ïù¥Î©îÏùº
            const emailElem = document.getElementById('userDetailEmail');
            if (emailElem) {
                emailElem.textContent = user.email || '-';
            }

            // ÎãâÎÑ§ÏûÑ
            const nicknameElem = document.getElementById('userDetailNickname');
            if (nicknameElem) {
                nicknameElem.textContent = user.nickname || user.name || '-';
            }

            // Ïã§Î™Ö
            const realNameElem = document.getElementById('userDetailRealName');
            if (realNameElem) {
                realNameElem.textContent = user.real_name || '-';
            }

            // Í∞ÄÏûÖÏùº
            const createdAtElem = document.getElementById('userDetailCreatedAt');
            if (createdAtElem) {
                createdAtElem.textContent = user.created_at
                    ? new Date(user.created_at).toLocaleDateString('ko-KR')
                    : '-';
            }

            // ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä
            const installFeeElem = document.getElementById('userDetailInstallationFee');
            if (installFeeElem) {
                installFeeElem.innerHTML = user.installation_fee_paid
                    ? '<span class="status-badge active">ÎÇ©Î∂Ä</span>'
                    : '<span class="status-badge" style="background: #6c757d; color: white;">ÎØ∏ÎÇ©</span>';
            }

            // ÌÅ¨Î†àÎîß
            const creditElem = document.getElementById('userDetailCredit');
            if (creditElem) {
                const credit = user.credit_balance || 0;
                creditElem.textContent = credit.toLocaleString() + ' C';
            }

            // ÏÉÅÌÉú ÏÖÄÎ†âÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const statusSelect = document.getElementById('userDetailStatusSelect');
            if (statusSelect) {
                const status = user.subscription_status || 'inactive';
                statusSelect.value = status;
            }

            console.log('‚úÖ ÌöåÏõê ÏÉÅÏÑ∏ Î™®Îã¨ Î†åÎçîÎßÅ ÏôÑÎ£å:', user.email);
        }

        /**
         * ÌöåÏõê ÏÉÅÌÉú Ï†ÄÏû• (Í∏∞Ï°¥ Ìï®Ïàò Ïò§Î≤ÑÎùºÏù¥Îìú)
         */
        async function saveUserStatus() {
            if (!currentDetailUser) {
                showToast('ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const statusSelect = document.getElementById('userDetailStatusSelect');
            const newStatus = statusSelect ? statusSelect.value : null;

            if (!newStatus) {
                showToast('ÏÉÅÌÉúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            try {
                showLoading();

                const { error } = await supabaseClient
                    .from('users')
                    .update({ subscription_status: newStatus })
                    .eq('id', currentDetailUser.id);

                if (error) throw error;

                showToast('ÌöåÏõê ÏÉÅÌÉúÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                closeUserDetail();
                loadUsers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÏÉÅÌÉú Ï†ÄÏû• Ïò§Î•ò:', error);
                showToast('Ï†ÄÏû• Ïã§Ìå®: ' + error.message, 'error');
                hideLoading();
            }
        }

        /**
         * ÌöåÏõê ÏÇ≠Ï†ú
         */
        async function deleteUser() {
            if (!currentDetailUser) {
                showToast('ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const userEmail = currentDetailUser.email || currentDetailUser.user_id;
            const confirmed = confirm(`Ï†ïÎßêÎ°ú ÌöåÏõê "${userEmail}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\nÍ¥ÄÎ†®Îêú ÌÅ¨Î†àÎîß, Í≤∞Ï†ú ÎÇ¥Ïó≠ Îì±ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`);

            if (!confirmed) return;

            try {
                showLoading();

                // ÌöåÏõê ÏÇ≠Ï†ú (Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞Îäî DB cascade ÎòêÎäî Î≥ÑÎèÑ Ï≤òÎ¶¨)
                const { error } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', currentDetailUser.id);

                if (error) throw error;

                showToast('ÌöåÏõêÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeUserDetail();
                loadUsers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®

            } catch (error) {
                console.error('‚ùå ÌöåÏõê ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('ÌöåÏõê ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Í¥ÄÎ¶¨ Í∏∞Îä• (Agenda #5)
        // ========================================

        let installationFees = [];

        async function loadInstallationRequests() {
            console.log('üìã ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ Î™©Î°ù Î°úÎìú ÏãúÏûë');

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                // deposit_notifications ÌÖåÏù¥Î∏îÏóêÏÑú install_fee ÌÉÄÏûÖÎßå Ï°∞Ìöå
                const { data, error } = await supabaseClient
                    .from('deposit_notifications')
                    .select('*')
                    .eq('deposit_type', 'install_fee')
                    .order('created_at', { ascending: false });

                // user_idÎ°ú users ÌÖåÏù¥Î∏îÏóêÏÑú Ï∂îÍ∞Ä Ï†ïÎ≥¥ Ï°∞Ìöå
                if (data && data.length > 0) {
                    const userIds = [...new Set(data.map(d => d.user_id).filter(id => id && id !== 'GUEST'))];
                    const { data: usersData } = await supabaseClient
                        .from('users')
                        .select('id, email, real_name, user_id, builder_id')
                        .in('id', userIds);

                    const usersMap = {};
                    if (usersData) {
                        usersData.forEach(u => { usersMap[u.id] = u; });
                    }

                    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î≥ëÌï© + ÌïÑÎìúÎ™Ö Ìò∏ÌôòÏÑ± Ïú†ÏßÄ
                    data.forEach(d => {
                        d.users = usersMap[d.user_id] || null;
                        d.requested_at = d.created_at; // ÌïÑÎìúÎ™Ö Ìò∏Ìôò
                    });
                }

                if (error) throw error;

                installationFees = data || [];
                console.log('‚úÖ Í∞úÏÑ§ÎπÑ Î™©Î°ù Î°úÎìú ÏÑ±Í≥µ:', installationFees.length, 'Í∞ú');

                renderInstallationTables();
                updateInstallationStats();

            } catch (error) {
                console.error('‚ùå Í∞úÏÑ§ÎπÑ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('installationPendingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #dc3545; padding: 40px;">
                            Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${error.message})
                        </td>
                    </tr>
                `;
            }
        }

        function renderInstallationTables() {
            const pendingTableBody = document.getElementById('installationPendingTableBody');
            const processedTableBody = document.getElementById('installationProcessedTableBody');

            const pendingList = installationFees.filter(f => f.status === 'pending');
            const confirmedList = installationFees.filter(f => f.status === 'confirmed');

            // ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù
            if (pendingList.length === 0) {
                pendingTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                            ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ Í±¥Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
            } else {
                pendingTableBody.innerHTML = pendingList.map(fee => `
                    <tr>
                        <td>${fee.users?.email || fee.depositor_name || '-'}</td>
                        <td>${fee.depositor_name || fee.users?.real_name || '-'}</td>
                        <td>‚Ç©${(fee.amount || 0).toLocaleString()}</td>
                        <td>${formatDateTime(fee.requested_at)}</td>
                        <td>
                            <a href="#" class="action-link" style="color: var(--success);" onclick="event.preventDefault(); confirmInstallation('${fee.id}', '${fee.user_id}', ${fee.amount})">‚úÖ ÏûÖÍ∏à ÌôïÏù∏</a>
                        </td>
                    </tr>
                `).join('');
            }

            // ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å Î™©Î°ù
            if (confirmedList.length === 0) {
                processedTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                            ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£åÎêú Í±¥Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
            } else {
                processedTableBody.innerHTML = confirmedList.map(fee => `
                    <tr>
                        <td><code style="background: #e8f4fc; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${fee.users?.user_id || '-'}</code></td>
                        <td><code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${fee.users?.builder_id || '-'}</code></td>
                        <td>${fee.users?.email || fee.depositor_name || '-'}</td>
                        <td>${fee.depositor_name || fee.users?.real_name || '-'}</td>
                        <td>‚Ç©${(fee.amount || 0).toLocaleString()}</td>
                        <td>${formatDateTime(fee.requested_at)}</td>
                        <td>${formatDateTime(fee.confirmed_at)}</td>
                    </tr>
                `).join('');
            }
        }

        function updateInstallationStats() {
            const pendingCount = installationFees.filter(f => f.status === 'pending').length;
            const confirmedCount = installationFees.filter(f => f.status === 'confirmed').length;
            const totalAmount = installationFees
                .filter(f => f.status === 'confirmed')
                .reduce((sum, f) => sum + (f.amount || 0), 0);

            document.getElementById('installationPendingCount').textContent = pendingCount;
            document.getElementById('installationApprovedCount').textContent = confirmedCount;
            document.getElementById('installationTotalAmount').textContent = '‚Ç©' + totalAmount.toLocaleString();

            // Î©îÎâ¥ Î±ÉÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
            const badge = document.getElementById('installationPendingBadge');
            if (badge) {
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        /**
         * ‚õî‚õî‚õî ÎπåÎçî Í≥ÑÏ†ï ID ÏÉùÏÑ± - Í∑úÏπô Ï†àÎåÄ Ï§ÄÏàò! ‚õî‚õî‚õî
         *
         * ÌòïÏãù: YYMMNNNNNNXX (Î∞òÎìúÏãú 12ÏûêÎ¶¨!)
         * - YY: Ïó∞ÎèÑ (2ÏûêÎ¶¨)
         * - MM: Ïõî (2ÏûêÎ¶¨)
         * - NNNNNN: ÏùºÎ†®Î≤àÌò∏ (6ÏûêÎ¶¨ Í≥†Ï†ï! padStart(6, '0'))
         * - XX: Í∏àÏï° ÏΩîÎìú (TH=300Îßå, FO=400Îßå, FI=500Îßå, SI=600Îßå, SE=700Îßå, EI=800Îßå, NI=900Îßå)
         *
         * ÏòàÏãú: 2512000001TH = 2025ÎÖÑ 12Ïõî, 1Î≤àÏß∏, 300ÎßåÏõê
         *
         * ‚õî Ï†àÎåÄ Í∏àÏßÄ (ÏàòÏ†ï Ïãú Î∞òÎìúÏãú ÌôïÏù∏!):
         * - padStart(2, '0') ÏÇ¨Ïö© Í∏àÏßÄ ‚Üí Î∞òÎìúÏãú padStart(6, '0')
         * - user_idÎ°ú Ïπ¥Ïö¥Ìä∏ Í∏àÏßÄ ‚Üí Î∞òÎìúÏãú builder_id Í∏∞Ï§Ä
         * - BLDR-YYMM-NNN Í∞ôÏùÄ ÎπÑÌëúÏ§Ä ÌòïÏãù Í∏àÏßÄ
         *
         * üìã ÏÉÅÏÑ∏ Í∑úÏπô: .claude/methods/02_builder-id.md
         */
        async function generateDeveloperAccountId(amount) {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');

            const amountCodes = {
                3000000: 'TH', 4000000: 'FO', 5000000: 'FI',
                6000000: 'SI', 7000000: 'SE', 8000000: 'EI', 9000000: 'NI'
            };
            const amountCode = amountCodes[amount] || 'TH';

            // Ìï¥Îãπ ÏõîÏùò Í∏∞Ï°¥ ÎπåÎçî ID Í∞úÏàò Ï°∞Ìöå (builder_id Í∏∞Ï§Ä!)
            const prefix = year + month;
            const { count, error } = await supabaseClient
                .from('users')
                .select('*', { count: 'exact', head: true })
                .like('builder_id', `${prefix}%`);

            // 6ÏûêÎ¶¨ ÏùºÎ†®Î≤àÌò∏ ÏÉùÏÑ±
            const serialNumber = String((count || 0) + 1).padStart(6, '0');
            return `${year}${month}${serialNumber}${amountCode}`;
        }

        async function confirmInstallation(paymentId, userId, amount) {
            if (!confirm('ÏûÖÍ∏àÏùÑ ÌôïÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏ Ïãú:\n- ÎπåÎçî Í≥ÑÏ†ï ID ÏûêÎèô Î∂ÄÏó¨\n- ÏÑúÎπÑÏä§ ÌôúÏÑ±Ìôî\n- Ïõ∞Ïª¥ ÌÅ¨Î†àÎîß ‚Ç©50,000 ÏßÄÍ∏â')) {
                return;
            }

            try {
                showLoading();

                // 1. ÎπåÎçî Í≥ÑÏ†ï ID ÏÉùÏÑ± (YYMMNNNNNNXX ÌòïÏãù)
                const builderId = await generateDeveloperAccountId(amount);
                console.log('üìå ÎπåÎçî Í≥ÑÏ†ï ID ÏÉùÏÑ±:', builderId);

                // 2. deposit_notifications ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const { error: paymentError } = await supabaseClient
                    .from('deposit_notifications')
                    .update({
                        status: 'confirmed',
                        confirmed_at: new Date().toISOString()
                    })
                    .eq('id', paymentId);

                if (paymentError) throw paymentError;

                // 3. users ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏ (ÎπåÎçî Í≥ÑÏ†ï ID, ÏÑúÎπÑÏä§ ÌôúÏÑ±Ìôî)
                // Î®ºÏ†Ä ÌòÑÏû¨ ÌÅ¨Î†àÎîß ÏûîÏï° Ï°∞Ìöå
                const { data: currentUser } = await supabaseClient
                    .from('users')
                    .select('credit_balance')
                    .eq('id', userId)
                    .single();

                const welcomeCredits = 50000;
                const newBalance = (currentUser?.credit_balance || 0) + welcomeCredits;

                const { error: userError } = await supabaseClient
                    .from('users')
                    .update({
                        builder_id: builderId,
                        subscription_status: 'active',
                        installation_fee_paid: true,
                        installation_date: new Date().toISOString(),
                        credit_balance: newBalance
                    })
                    .eq('id', userId);

                if (userError) throw userError;

                // 4. Ïõ∞Ïª¥ ÌÅ¨Î†àÎîß Í±∞Îûò ÎÇ¥Ïó≠ Í∏∞Î°ù
                const { error: creditError } = await supabaseClient
                    .from('credit_transactions')
                    .insert({
                        user_id: userId,
                        amount: welcomeCredits,
                        type: 'bonus',
                        description: 'ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ Ïõ∞Ïª¥ ÌÅ¨Î†àÎîß',
                        created_at: new Date().toISOString()
                    });

                if (creditError) console.error('ÌÅ¨Î†àÎîß Í±∞Îûò Í∏∞Î°ù Ïò§Î•ò:', creditError);

                // 5. ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º ÏÉùÏÑ±
                const { error: notifError } = await supabaseClient
                    .from('user_notifications')
                    .insert({
                        user_id: userId,
                        notification_type: 'system',
                        title: 'üéâ ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ ÏôÑÎ£å',
                        message: `ÎπåÎçî Í≥ÑÏ†ïÏù¥ Í∞úÏÑ§ÎêòÏóàÏäµÎãàÎã§. (ÎπåÎçî ID: ${builderId}, Ïõ∞Ïª¥ ÌÅ¨Î†àÎîß ‚Ç©50,000 ÏßÄÍ∏â)`,
                        is_read: false,
                        metadata: { builder_id: builderId, welcome_credit: 50000 }
                    });

                if (notifError) console.log('ÏïåÎ¶º ÏÉùÏÑ± Ïã§Ìå®:', notifError.message);

                showToast(`ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å! ÎπåÎçî Í≥ÑÏ†ï ID: ${builderId}`, 'success');
                loadInstallationRequests();
                loadUsers(); // ÏÑúÎπÑÏä§ Ïù¥Ïö© ÌòÑÌô© Í∞±Ïã†

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÏûÖÍ∏à ÌôïÏù∏ Ïò§Î•ò:', error);
                showToast('ÏûÖÍ∏à ÌôïÏù∏ Ïã§Ìå®: ' + error.message, 'error');
                hideLoading();
            }
        }

        // ========================================
        // ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Í¥ÄÎ¶¨ Í∏∞Îä• (ÏûêÎèô Í≤∞Ï†ú Í∏∞Î∞ò)
        // ========================================

        async function loadPlatformFeeData() {
            console.log('üìÖ ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú');

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                // Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä ÏôÑÎ£å ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
                const { data: paidUsers, error } = await supabaseClient
                    .from('users')
                    .select('id, user_id, email, real_name, installation_date, installation_fee_paid')
                    .eq('installation_fee_paid', true)
                    .order('installation_date', { ascending: false });

                if (error) throw error;

                // Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
                renderPlatformFeeFreeTable(paidUsers || []);
                // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                updatePlatformFeeStats(paidUsers || []);

            } catch (error) {
                console.error('‚ùå ÌîåÎû´Ìèº Ïù¥Ïö©Î£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('platformFeeFreeTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #dc3545; padding: 40px;">
                            Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${error.message})
                        </td>
                    </tr>
                `;
            }
        }

        function renderPlatformFeeFreeTable(users) {
            const tbody = document.getElementById('platformFeeFreeTableBody');
            const today = new Date();

            // Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©ÏûêÎßå ÌïÑÌÑ∞ÎßÅ
            const freeUsers = users.filter(user => {
                if (!user.installation_date) return false;
                const installDate = new Date(user.installation_date);
                const feeStartDate = new Date(installDate);
                feeStartDate.setMonth(feeStartDate.getMonth() + 3);
                return today < feeStartDate;
            });

            if (freeUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #6c757d; padding: 40px;">
                            Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = freeUsers.map(user => {
                const installDate = new Date(user.installation_date);
                const feeStartDate = new Date(installDate);
                feeStartDate.setMonth(feeStartDate.getMonth() + 3);
                const daysLeft = Math.ceil((feeStartDate - today) / (1000 * 60 * 60 * 24));

                // ÎπåÎßÅÌÇ§ ÏÉÅÌÉú (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô Ï†ÑÍπåÏßÄÎäî ÎØ∏Îì±Î°ù ÌëúÏãú)
                const billingStatus = '<span class="status-badge pending">ÎØ∏Îì±Î°ù</span>';

                return `
                    <tr>
                        <td>${user.user_id || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.real_name || '-'}</td>
                        <td>${installDate.toLocaleDateString('ko-KR')}</td>
                        <td>${feeStartDate.toLocaleDateString('ko-KR')}</td>
                        <td><span class="status-badge" style="background: ${daysLeft <= 7 ? '#f8d7da' : '#d4edda'}; color: ${daysLeft <= 7 ? '#721c24' : '#155724'};">D-${daysLeft}</span></td>
                        <td>${billingStatus}</td>
                        <td>
                            <button class="section-action" onclick="sendIndividualNotice('${user.email}', 'free_ending')" style="padding: 4px 8px; font-size: 12px;">üìß ÏïàÎÇ¥</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePlatformFeeStats(users) {
            const today = new Date();
            let billingCount = 0; // ÏûêÎèô Í≤∞Ï†ú Îì±Î°ù (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌõÑ)
            let freeCount = 0;    // Î¨¥Î£å Í∏∞Í∞Ñ
            let paidCount = 0;    // Ïù¥Î≤à Îã¨ Í≤∞Ï†ú ÏÑ±Í≥µ (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌõÑ)
            let failedCount = 0;  // Ïù¥Î≤à Îã¨ Í≤∞Ï†ú Ïã§Ìå® (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌõÑ)

            users.forEach(user => {
                if (user.installation_date) {
                    const installDate = new Date(user.installation_date);
                    const feeStartDate = new Date(installDate);
                    feeStartDate.setMonth(feeStartDate.getMonth() + 3);

                    if (today < feeStartDate) {
                        freeCount++;
                    }
                }
            });

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('platformFeeBillingCount').textContent = billingCount;
            document.getElementById('platformFeeFreeCount').textContent = freeCount;
            document.getElementById('platformFeePaidCount').textContent = paidCount;
            document.getElementById('platformFeeFailedCount').textContent = failedCount;
            document.getElementById('platformFeeMonthlyRevenue').textContent = '‚Ç©' + (paidCount * 50000).toLocaleString();
        }

        // ÏïàÎÇ¥Î¨∏ Î∞úÏÜ° (Í∞úÎ≥Ñ) - Ïù∏Ïï± ÏïåÎ¶º
        async function sendIndividualNotice(email, noticeType) {
            // Î®ºÏ†Ä Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÏùò id Ï∞æÍ∏∞
            const { data: userData, error: userError } = await supabaseClient
                .from('users')
                .select('id, real_name, installation_date')
                .eq('email', email)
                .single();

            if (userError || !userData) {
                showToast('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const typeLabels = {
                'free_ending': 'Î¨¥Î£å Í∏∞Í∞Ñ Ï¢ÖÎ£å ÏòàÏ†ï',
                'payment_failed': 'Í≤∞Ï†ú Ïã§Ìå®',
                'billing_required': 'Í≤∞Ï†ú ÏàòÎã® Îì±Î°ù ÌïÑÏöî'
            };

            const typeMessages = {
                'free_ending': 'Î¨¥Î£å Í∏∞Í∞ÑÏù¥ Í≥ß Ï¢ÖÎ£åÎê©ÎãàÎã§. ÏûêÎèô Í≤∞Ï†ú ÏàòÎã®ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.',
                'payment_failed': 'Ïù¥Î≤à Îã¨ Í≤∞Ï†úÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í≤∞Ï†ú ÏàòÎã®ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.',
                'billing_required': 'ÌîåÎû´Ìèº Ïù¥Ïö©Î£å ÏûêÎèô Í≤∞Ï†úÎ•º ÏúÑÌï¥ Í≤∞Ï†ú ÏàòÎã®ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.'
            };

            if (!confirm(`${userData.real_name || email}ÎãòÏóêÍ≤å "${typeLabels[noticeType]}" ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }

            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('user_notifications')
                    .insert({
                        user_id: userData.id,
                        notification_type: noticeType === 'free_ending' ? 'free_period_ending' : 'system',
                        title: `üìÖ ${typeLabels[noticeType]}`,
                        message: typeMessages[noticeType],
                        metadata: { notice_type: noticeType }
                    });

                if (error) throw error;

                showToast(`üîî ${userData.real_name || email}ÎãòÏóêÍ≤å ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.`, 'success');
            } catch (error) {
                console.error('ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', error);
                showToast('ÏïåÎ¶º Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        // ÏïàÎÇ¥Î¨∏ Î∞úÏÜ° (7Ïùº Ïù¥ÎÇ¥ ÎåÄÏÉÅÏûêÎßå) - Ïù∏Ïï± ÏïåÎ¶º
        async function sendFreeEndingNotice7Days() {
            try {
                if (!supabaseClient) {
                    showToast('Supabase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                    return;
                }

                // Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä ÏôÑÎ£å ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
                const { data: paidUsers, error } = await supabaseClient
                    .from('users')
                    .select('id, user_id, email, real_name, installation_date')
                    .eq('installation_fee_paid', true);

                if (error) throw error;

                const today = new Date();
                // 7Ïùº Ïù¥ÎÇ¥ Ï†ÑÌôò ÏòàÏ†ïÏûê ÌïÑÌÑ∞
                const targetUsers = (paidUsers || []).filter(user => {
                    if (!user.installation_date) return false;
                    const installDate = new Date(user.installation_date);
                    const feeStartDate = new Date(installDate);
                    feeStartDate.setMonth(feeStartDate.getMonth() + 3);
                    const daysLeft = Math.ceil((feeStartDate - today) / (1000 * 60 * 60 * 24));
                    user._daysLeft = daysLeft; // ÎÇòÏ§ëÏóê Î©îÏãúÏßÄÏóê ÏÇ¨Ïö©
                    return daysLeft > 0 && daysLeft <= 7;
                });

                if (targetUsers.length === 0) {
                    showToast('7Ïùº Ïù¥ÎÇ¥ Ï†ÑÌôò ÏòàÏ†ï ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'info');
                    return;
                }

                const names = targetUsers.map(u => u.real_name || u.email).join(', ');
                if (!confirm(`7Ïùº Ïù¥ÎÇ¥ Ï†ÑÌôò ÏòàÏ†ï ÏÇ¨Ïö©Ïûê ${targetUsers.length}Î™ÖÏóêÍ≤å ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎåÄÏÉÅ: ${names}`)) {
                    return;
                }

                showLoading();
                let successCount = 0;

                for (const user of targetUsers) {
                    const { error } = await supabaseClient
                        .from('user_notifications')
                        .insert({
                            user_id: user.id,
                            notification_type: 'free_period_ending',
                            title: 'üìÖ Î¨¥Î£å Í∏∞Í∞Ñ Ï¢ÖÎ£å ÏòàÏ†ï',
                            message: `Î¨¥Î£å Í∏∞Í∞ÑÏù¥ ${user._daysLeft}Ïùº ÌõÑ Ï¢ÖÎ£åÎê©ÎãàÎã§. ÏûêÎèô Í≤∞Ï†ú ÏàòÎã®ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.`,
                            metadata: { days_left: user._daysLeft }
                        });

                    if (!error) successCount++;
                }

                showToast(`üîî ${successCount}Î™ÖÏóêÍ≤å ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.`, 'success');
                hideLoading();

            } catch (error) {
                console.error('7Ïùº Ïù¥ÎÇ¥ ÏïàÎÇ¥ Î∞úÏÜ° Ïò§Î•ò:', error);
                showToast('ÏïàÎÇ¥ Î∞úÏÜ° Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                hideLoading();
            }
        }

        // ÏïàÎÇ¥Î¨∏ Î∞úÏÜ° (Ï†ÑÏ≤¥) - Ïù∏Ïï± ÏïåÎ¶º
        async function sendFreeEndingNotice() {
            try {
                if (!supabaseClient) {
                    showToast('Supabase Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                    return;
                }

                // Í∞úÏÑ§ÎπÑ ÎÇ©Î∂Ä ÏôÑÎ£å ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
                const { data: paidUsers, error } = await supabaseClient
                    .from('users')
                    .select('id, user_id, email, real_name, installation_date')
                    .eq('installation_fee_paid', true);

                if (error) throw error;

                const today = new Date();
                // Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©Ïûê ÌïÑÌÑ∞
                const targetUsers = (paidUsers || []).filter(user => {
                    if (!user.installation_date) return false;
                    const installDate = new Date(user.installation_date);
                    const feeStartDate = new Date(installDate);
                    feeStartDate.setMonth(feeStartDate.getMonth() + 3);
                    const daysLeft = Math.ceil((feeStartDate - today) / (1000 * 60 * 60 * 24));
                    user._daysLeft = daysLeft;
                    return today < feeStartDate;
                });

                if (targetUsers.length === 0) {
                    showToast('Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'info');
                    return;
                }

                if (!confirm(`Î¨¥Î£å Í∏∞Í∞Ñ ÏÇ¨Ïö©Ïûê ${targetUsers.length}Î™Ö Ï†ÑÏ≤¥ÏóêÍ≤å ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    return;
                }

                showLoading();
                let successCount = 0;

                for (const user of targetUsers) {
                    const { error } = await supabaseClient
                        .from('user_notifications')
                        .insert({
                            user_id: user.id,
                            notification_type: 'free_period_ending',
                            title: 'üìÖ Î¨¥Î£å Í∏∞Í∞Ñ Ï¢ÖÎ£å ÏòàÏ†ï',
                            message: `Î¨¥Î£å Í∏∞Í∞ÑÏù¥ ${user._daysLeft}Ïùº ÌõÑ Ï¢ÖÎ£åÎê©ÎãàÎã§. ÏûêÎèô Í≤∞Ï†ú ÏàòÎã®ÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.`,
                            metadata: { days_left: user._daysLeft }
                        });

                    if (!error) successCount++;
                }

                showToast(`üîî ${successCount}Î™ÖÏóêÍ≤å ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.`, 'success');
                hideLoading();

            } catch (error) {
                console.error('Ï†ÑÏ≤¥ ÏïàÎÇ¥ Î∞úÏÜ° Ïò§Î•ò:', error);
                showToast('ÏïàÎÇ¥ Î∞úÏÜ° Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                hideLoading();
            }
        }

        // ========================================
        // ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨ Í∏∞Îä• (Agenda #5)
        // ========================================

        let projects = [];

        async function loadProjects() {
            console.log('üìÅ ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Î°úÎìú ÏãúÏûë');

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                projects = data || [];
                console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú ÏÑ±Í≥µ:', projects.length, 'Í∞ú');

                renderProjectsTable();
                updateProjectsStats();

            } catch (error) {
                console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('projectsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #dc3545; padding: 40px;">
                            Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${error.message})
                        </td>
                    </tr>
                `;
            }
        }

        function renderProjectsTable(filteredProjects = null) {
            const tableBody = document.getElementById('projectsTableBody');
            const displayProjects = filteredProjects || projects;

            if (displayProjects.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                            Îì±Î°ùÎêú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = displayProjects.map(proj => `
                <tr>
                    <td>${proj.project_id || '-'}</td>
                    <td>${proj.project_name || '-'}</td>
                    <td>${proj.user_id || '-'}</td>
                    <td>${getProjectStatusBadge(proj.status)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="width: ${proj.progress || 0}%; height: 100%; background: ${getProgressColor(proj.progress || 0)};"></div>
                            </div>
                            <span style="font-size: 12px; font-weight: 600;">${proj.progress || 0}%</span>
                        </div>
                    </td>
                    <td>${formatDate(proj.created_at)}</td>
                    <td>
                        <a href="#" class="action-link" onclick="event.preventDefault(); viewProjectDetail('${proj.id}')">ÏÉÅÏÑ∏</a>
                    </td>
                </tr>
            `).join('');
        }

        function updateProjectsStats() {
            const total = projects.length;
            const inProgress = projects.filter(p => p.status === 'in_progress').length;
            const completed = projects.filter(p => p.status === 'completed').length;
            const archived = projects.filter(p => p.status === 'archived').length;

            document.getElementById('projectsTotalCount').textContent = total;
            document.getElementById('projectsInProgressCount').textContent = inProgress;
            document.getElementById('projectsCompletedCount').textContent = completed;
            document.getElementById('projectsArchivedCount').textContent = archived;
        }

        function getProjectStatusBadge(status) {
            switch (status) {
                case 'in_progress':
                    return '<span class="status-badge pending">ÏßÑÌñâ Ï§ë</span>';
                case 'completed':
                    return '<span class="status-badge active">ÏôÑÎ£å</span>';
                case 'archived':
                    return '<span class="status-badge inactive">Î≥¥Í¥Ä</span>';
                default:
                    return '<span class="status-badge">' + status + '</span>';
            }
        }

        function getProgressColor(progress) {
            if (progress >= 80) return 'var(--success)';
            if (progress >= 50) return 'var(--warning)';
            return 'var(--primary)';
        }

        function searchProjects() {
            const query = document.getElementById('projectSearchInput').value.toLowerCase().trim();

            if (!query) {
                renderProjectsTable();
                return;
            }

            const filtered = projects.filter(proj =>
                (proj.project_id || '').toLowerCase().includes(query) ||
                (proj.project_name || '').toLowerCase().includes(query) ||
                (proj.user_id || '').toLowerCase().includes(query)
            );

            renderProjectsTable(filtered);
        }

        function viewProjectDetail(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                showToast('ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            alert(`ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏\n\nÌîÑÎ°úÏ†ùÌä∏ ID: ${project.project_id}\nÌîÑÎ°úÏ†ùÌä∏Î™Ö: ${project.project_name}\nÏÇ¨Ïö©Ïûê ID: ${project.user_id}\nÏÉÅÌÉú: ${project.status}\nÏßÑÌñâÎ•†: ${project.progress}%\nÎì±Î°ùÏùº: ${formatDateTime(project.created_at)}`);
        }

        // ========================================
        // Í≤∞Ï†ú Í¥ÄÎ¶¨ Í∏∞Îä• (Agenda #6)
        // ========================================

        let billingHistory = [];

        async function loadBillingHistory() {
            console.log('üìã Í≤∞Ï†ú ÎÇ¥Ïó≠ Î°úÎî© ÏãúÏûë...');
            showLoading();

            try {
                // Í≤∞Ï†ú ÎÇ¥Ïó≠ Ï°∞Ìöå
                const { data, error } = await supabaseClient
                    .from('billing_history')
                    .select('*')
                    .order('billing_date', { ascending: false });

                if (error) throw error;

                billingHistory = data || [];
                console.log('‚úÖ Í≤∞Ï†ú ÎÇ¥Ïó≠ Î°úÎìú ÏÑ±Í≥µ:', billingHistory.length, 'Í∞ú');

                updateBillingStats();
                renderBillingTable();

            } catch (error) {
                console.error('‚ùå Í≤∞Ï†ú ÎÇ¥Ïó≠ Î°úÎìú Ïò§Î•ò:', error);
                document.querySelector('#payment-section .data-table tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #dc3545; padding: 40px;">
                            Í≤∞Ï†ú ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }

        function updateBillingStats() {
            const thisMonth = new Date().toISOString().slice(0, 7);

            // Ïù¥Î≤à Îã¨ Îß§Ï∂ú
            const monthlyRevenue = billingHistory
                .filter(b => b.billing_date && b.billing_date.startsWith(thisMonth) && b.status === 'paid')
                .reduce((sum, b) => sum + (b.amount || 0), 0);

            // ÏôÑÎ£åÎêú Í≤∞Ï†ú
            const completedCount = billingHistory.filter(b => b.status === 'paid').length;

            // ÎåÄÍ∏∞ Ï§ë
            const pendingCount = billingHistory.filter(b => b.status === 'pending').length;

            // Ïã§Ìå®
            const failedCount = billingHistory.filter(b => b.status === 'failed').length;

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (subscription-section ÎÇ¥Ïùò stat-cardÎì§ - Î≥ÑÎèÑ Í¥ÄÎ¶¨)
            console.log('üìä Í≤∞Ï†ú ÌÜµÍ≥Ñ:', { monthlyRevenue, completedCount, pendingCount, failedCount });
        }

        function renderBillingTable() {
            const tbody = document.querySelector('#payment-section .data-table tbody');

            if (!billingHistory || billingHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #6c757d; padding: 40px;">
                            Í≤∞Ï†ú ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                'paid': { text: 'ÏôÑÎ£å', class: 'answered' },
                'failed': { text: 'Ïã§Ìå®', class: 'closed' },
                'pending': { text: 'ÎåÄÍ∏∞', class: 'pending' }
            };

            const typeLabels = {
                'platform_fee': 'ÌîåÎû´Ìèº Ïù¥Ïö©Î£å',
                'credit_purchase': 'ÌÅ¨Î†àÎîß Ï∂©Ï†Ñ',
                'installation_fee': 'ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ'
            };

            tbody.innerHTML = billingHistory.map(bill => {
                const status = statusLabels[bill.status] || { text: bill.status, class: '' };
                const type = typeLabels[bill.billing_type] || bill.billing_type;

                return `
                    <tr>
                        <td>${bill.id ? bill.id.slice(0, 8) : '-'}</td>
                        <td>${bill.user_id || '-'}</td>
                        <td>‚Ç©${(bill.amount || 0).toLocaleString()}</td>
                        <td>${bill.payment_method || '-'}</td>
                        <td><span class="status-badge ${status.class}">${status.text}</span></td>
                        <td>${formatDateTime(bill.billing_date)}</td>
                        <td>
                            <a href="#" class="action-link" onclick="event.preventDefault(); viewBillingDetail('${bill.id}')">ÏÉÅÏÑ∏</a>
                            ${bill.status === 'failed' ? `<a href="#" class="action-link" style="color: #f59e0b;" onclick="event.preventDefault(); retryPayment('${bill.id}')">Ïû¨ÏãúÎèÑ</a>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewBillingDetail(billingId) {
            const bill = billingHistory.find(b => b.id === billingId);
            if (!bill) {
                showToast('Í≤∞Ï†ú ÎÇ¥Ïó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            const typeLabels = {
                'platform_fee': 'ÌîåÎû´Ìèº Ïù¥Ïö©Î£å',
                'credit_purchase': 'ÌÅ¨Î†àÎîß Ï∂©Ï†Ñ',
                'installation_fee': 'ÎπåÎçî Í≥ÑÏ†ï Í∞úÏÑ§ÎπÑ'
            };

            const statusLabels = {
                'paid': 'Í≤∞Ï†ú ÏôÑÎ£å',
                'failed': 'Í≤∞Ï†ú Ïã§Ìå®',
                'pending': 'ÎåÄÍ∏∞ Ï§ë'
            };

            let details = `Í≤∞Ï†ú ÏÉÅÏÑ∏ Ï†ïÎ≥¥\n\n`;
            details += `Í≤∞Ï†ú ID: ${bill.id}\n`;
            details += `ÏÇ¨Ïö©Ïûê ID: ${bill.user_id}\n`;
            details += `Í≤∞Ï†ú Ïú†Ìòï: ${typeLabels[bill.billing_type] || bill.billing_type}\n`;
            details += `Í∏àÏï°: ‚Ç©${(bill.amount || 0).toLocaleString()}\n`;
            details += `ÏÉÅÌÉú: ${statusLabels[bill.status] || bill.status}\n`;
            details += `Í≤∞Ï†ú ÏàòÎã®: ${bill.payment_method || '-'}\n`;
            details += `Í≤∞Ï†úÏùº: ${formatDateTime(bill.billing_date)}\n`;

            if (bill.failure_reason) {
                details += `Ïã§Ìå® ÏÇ¨Ïú†: ${bill.failure_reason}\n`;
            }
            if (bill.receipt_url) {
                details += `ÏòÅÏàòÏ¶ù: ${bill.receipt_url}\n`;
            }

            alert(details);
        }

        async function retryPayment(billingId) {
            if (!confirm('Í≤∞Ï†úÎ•º Ïû¨ÏãúÎèÑÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            showLoading();
            try {
                // Ïû¨ÏãúÎèÑ ÌöüÏàò Ï¶ùÍ∞Ä (Ïã§Ï†ú Í≤∞Ï†ú Ïû¨ÏãúÎèÑÎäî ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌïÑÏöî)
                const bill = billingHistory.find(b => b.id === billingId);

                const { error } = await supabaseClient
                    .from('billing_history')
                    .update({
                        retry_count: (bill.retry_count || 0) + 1
                    })
                    .eq('id', billingId);

                if (error) throw error;

                showToast('Í≤∞Ï†ú Ïû¨ÏãúÎèÑÍ∞Ä ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§. (ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Ïó∞Îèô ÌïÑÏöî)', 'info');
                loadBillingHistory();

            } catch (error) {
                console.error('Í≤∞Ï†ú Ïû¨ÏãúÎèÑ Ïã§Ìå®:', error);
                showToast('Í≤∞Ï†ú Ïû¨ÏãúÎèÑÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // ========================================
        // ÌÅ¨Î†àÎîß Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ (Agenda #7)
        // ========================================

        async function loadCreditData() {
            await Promise.all([
                loadUserCredits(),
                loadCreditTransactions(),
                loadAIUsageLog(),
                loadLowBalanceUsers(),
                loadCreditStats(),
                loadCreditDepositNotifications()
            ]);
        }

        async function loadCreditStats() {
            try {
                // Ï†ÑÏ≤¥ ÌÅ¨Î†àÎîß ÏûîÏï°
                const { data: users } = await supabaseClient
                    .from('users')
                    .select('credit_balance');

                if (users) {
                    const totalBalance = users.reduce((sum, u) => sum + (u.credit_balance || 0), 0);
                    document.getElementById('creditTotalBalance').textContent = `‚Ç©${totalBalance.toLocaleString()}`;
                }

                // Ïò§Îäò Ï∂©Ï†Ñ/ÏÇ¨Ïö©
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { data: todayTrans } = await supabaseClient
                    .from('credit_transactions')
                    .select('*')
                    .gte('created_at', today.toISOString());

                if (todayTrans) {
                    const todayCharge = todayTrans
                        .filter(t => t.type === 'charge' || t.type === 'bonus')
                        .reduce((sum, t) => sum + t.amount, 0);
                    const todayUsage = todayTrans
                        .filter(t => t.type === 'spend')
                        .reduce((sum, t) => sum + Math.abs(t.amount), 0);

                    document.getElementById('creditTodayCharge').textContent = `+‚Ç©${todayCharge.toLocaleString()}`;
                    document.getElementById('creditTodayUsage').textContent = `-‚Ç©${todayUsage.toLocaleString()}`;
                }

                // AI ÏÇ¨Ïö© ÌöüÏàò
                const { data: usageCount, count } = await supabaseClient
                    .from('ai_usage_log')
                    .select('*', { count: 'exact', head: true });

                document.getElementById('creditAIUsageCount').textContent = `${count || 0}Ìöå`;

            } catch (error) {
                console.error('ÌÅ¨Î†àÎîß ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù
        let creditDepositNotifications = [];

        async function loadCreditDepositNotifications() {
            console.log('üí≥ ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Î™©Î°ù Î°úÎìú');

            try {
                if (!supabaseClient) {
                    throw new Error('Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }

                // deposit_notifications ÌÖåÏù¥Î∏îÏóêÏÑú ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÏöîÏ≤≠ Ï°∞Ìöå
                const { data, error } = await supabaseClient
                    .from('deposit_notifications')
                    .select('*')
                    .eq('deposit_type', 'credit')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                creditDepositNotifications = data || [];
                console.log('‚úÖ ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÎåÄÍ∏∞ Î™©Î°ù Î°úÎìú ÏÑ±Í≥µ:', creditDepositNotifications.length, 'Í∞ú');

                renderCreditDepositTable();
                updateCreditDepositStats();

            } catch (error) {
                console.error('‚ùå ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÎåÄÍ∏∞ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                document.getElementById('creditDepositPendingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #dc3545; padding: 40px;">
                            Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${error.message})
                        </td>
                    </tr>
                `;
            }
        }

        function renderCreditDepositTable() {
            const tbody = document.getElementById('creditDepositPendingTableBody');
            const pendingList = creditDepositNotifications.filter(n => n.status === 'pending');

            if (pendingList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                            ÏûÖÍ∏à ÌôïÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ Í±¥Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pendingList.map(notification => `
                <tr>
                    <td>${DOMPurify.sanitize(notification.user_id || '-')}</td>
                    <td>${DOMPurify.sanitize(notification.depositor_name || '-')}</td>
                    <td style="font-weight: 600; color: var(--primary);">‚Ç©${(notification.amount || 0).toLocaleString()}</td>
                    <td>${formatDateTime(notification.created_at)}</td>
                    <td>
                        <a href="#" class="action-link" style="color: var(--success);" onclick="event.preventDefault(); confirmCreditDeposit('${notification.id}', '${notification.user_id}', ${notification.amount})">‚úÖ ÏûÖÍ∏à ÌôïÏù∏</a>
                    </td>
                </tr>
            `).join('');
        }

        function updateCreditDepositStats() {
            const pendingCount = creditDepositNotifications.filter(n => n.status === 'pending').length;
            document.getElementById('creditPendingDepositCount').textContent = pendingCount;
        }

        async function confirmCreditDeposit(notificationId, userId, amount) {
            if (!confirm(`ÏûÖÍ∏àÏùÑ ÌôïÏù∏ÌïòÍ≥† ‚Ç©${amount.toLocaleString()} ÌÅ¨Î†àÎîßÏùÑ Ï∂©Ï†ÑÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }

            try {
                showLoading();

                // 1. ÏÇ¨Ïö©Ïûê ÌòÑÏû¨ ÏûîÏï° Ï°∞Ìöå
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('credit_balance')
                    .eq('user_id', userId)
                    .single();

                if (userError) {
                    // user_idÍ∞Ä ÏïÑÎãå idÎ°ú ÏãúÎèÑ
                    const { data: userDataById, error: userErrorById } = await supabaseClient
                        .from('users')
                        .select('credit_balance, user_id')
                        .eq('id', userId)
                        .single();

                    if (userErrorById) throw new Error('ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    userId = userDataById.user_id || userId;
                }

                const currentBalance = userData?.credit_balance || 0;
                const newBalance = currentBalance + amount;

                // 2. ÌÅ¨Î†àÎîß ÏûîÏï° ÏóÖÎç∞Ïù¥Ìä∏
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({ credit_balance: newBalance })
                    .eq('user_id', userId);

                if (updateError) {
                    // user_idÎ°ú Ïã§Ìå®Ïãú idÎ°ú ÏãúÎèÑ
                    const { error: updateError2 } = await supabaseClient
                        .from('users')
                        .update({ credit_balance: newBalance })
                        .eq('id', userId);
                    if (updateError2) throw updateError2;
                }

                // 3. ÌÅ¨Î†àÎîß Í±∞Îûò ÎÇ¥Ïó≠ Ï∂îÍ∞Ä
                const { error: transError } = await supabaseClient
                    .from('credit_transactions')
                    .insert({
                        user_id: userId,
                        type: 'charge',
                        amount: amount,
                        balance_after: newBalance,
                        description: 'Î¨¥ÌÜµÏû• ÏûÖÍ∏à - Í¥ÄÎ¶¨Ïûê ÌôïÏù∏'
                    });

                if (transError) console.error('Í±∞Îûò ÎÇ¥Ïó≠ Ï∂îÍ∞Ä Ïò§Î•ò:', transError);

                // 4. ÏûÖÍ∏à ÏöîÏ≤≠ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const { error: notifError } = await supabaseClient
                    .from('deposit_notifications')
                    .update({
                        status: 'confirmed',
                        confirmed_at: new Date().toISOString()
                    })
                    .eq('id', notificationId);

                if (notifError) throw notifError;

                // 5. ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïù∏Ïï± ÏïåÎ¶º ÏÉùÏÑ±
                const { error: userNotifError } = await supabaseClient
                    .from('user_notifications')
                    .insert({
                        user_id: userId,
                        notification_type: 'deposit_confirmed',
                        title: 'ÌÅ¨Î†àÎîß Ï∂©Ï†Ñ ÏôÑÎ£å',
                        message: `‚Ç©${amount.toLocaleString()} ÌÅ¨Î†àÎîßÏù¥ Ï∂©Ï†ÑÎêòÏóàÏäµÎãàÎã§.`,
                        metadata: { amount: amount, balance_after: newBalance }
                    });

                if (userNotifError) console.log('ÏÇ¨Ïö©Ïûê ÏïåÎ¶º ÏÉùÏÑ± Ïã§Ìå®:', userNotifError.message);

                showToast(`‚úÖ ÏûÖÍ∏à ÌôïÏù∏ ÏôÑÎ£å! ‚Ç©${amount.toLocaleString()} ÌÅ¨Î†àÎîßÏù¥ Ï∂©Ï†ÑÎêòÏóàÏäµÎãàÎã§.`, 'success');

                // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                await loadCreditDepositNotifications();
                await loadUserCredits();
                await loadCreditStats();
                await loadCreditTransactions();

                // 6. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Ïù¥Î©îÏùº ÏïåÎ¶º (ÏÑ§Ï†ïÏóêÏÑú ÏºúÏ†∏ÏûàÏùÑ Í≤ΩÏö∞)
                try {
                    const userEmail = await getUserEmail(userId);
                    await sendAdminNotify('payment', {
                        email: userEmail,
                        type: 'ÌÅ¨Î†àÎîß Ï∂©Ï†Ñ',
                        amount: amount
                    });
                } catch (notifyErr) {
                    console.log('Í¥ÄÎ¶¨Ïûê ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', notifyErr.message);
                }

                hideLoading();
            } catch (error) {
                console.error('‚ùå ÌÅ¨Î†àÎîß ÏûÖÍ∏à ÌôïÏù∏ Ïò§Î•ò:', error);
                showToast('ÏûÖÍ∏à ÌôïÏù∏ Ïã§Ìå®: ' + error.message, 'error');
                hideLoading();
            }
        }

        async function loadUserCredits() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('user_id, name, email, credit_balance, updated_at')
                    .order('credit_balance', { ascending: false })
                    .limit(20);

                if (error) throw error;

                const tbody = document.getElementById('userCreditTableBody');
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6c757d;padding:40px;">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${DOMPurify.sanitize(u.user_id)}</td>
                        <td>${DOMPurify.sanitize(u.name || '-')}</td>
                        <td style="font-weight:600;color:${(u.credit_balance || 0) < 1000 ? 'var(--danger)' : 'var(--success)'};">‚Ç©${(u.credit_balance || 0).toLocaleString()}</td>
                        <td>${formatDateTime(u.updated_at)}</td>
                        <td><a href="#" class="action-link" onclick="event.preventDefault(); showUserCreditHistory('${u.user_id}')">ÎÇ¥Ïó≠</a></td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÌÅ¨Î†àÎîß Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('userCreditTableBody').innerHTML =
                    '<tr><td colspan="5" style="text-align:center;color:#dc3545;padding:40px;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        async function loadCreditTransactions() {
            try {
                const { data: transactions, error } = await supabaseClient
                    .from('credit_transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                const tbody = document.getElementById('creditTransactionsTableBody');
                if (!transactions || transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#6c757d;padding:40px;">Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
                    return;
                }

                const typeLabels = {
                    'charge': { text: 'Ï∂©Ï†Ñ', class: 'active' },
                    'spend': { text: 'ÏÇ¨Ïö©', class: 'warning' },
                    'bonus': { text: 'Î≥¥ÎÑàÏä§', class: 'active' },
                    'expire': { text: 'ÎßåÎ£å', class: 'inactive' },
                    'admin_deduct': { text: 'Í¥ÄÎ¶¨Ïûê Ï∞®Í∞ê', class: 'closed' }
                };

                tbody.innerHTML = transactions.map(t => {
                    const typeInfo = typeLabels[t.type] || { text: t.type, class: 'neutral' };
                    return `
                        <tr>
                            <td>${formatDateTime(t.created_at)}</td>
                            <td>${DOMPurify.sanitize(t.user_id)}</td>
                            <td><span class="status-badge ${typeInfo.class}">${typeInfo.text}</span></td>
                            <td style="font-weight:600;color:${t.amount >= 0 ? 'var(--success)' : 'var(--danger)'};">${t.amount >= 0 ? '+' : ''}‚Ç©${t.amount.toLocaleString()}</td>
                            <td>‚Ç©${t.balance_after.toLocaleString()}</td>
                            <td>${DOMPurify.sanitize(t.description || '-')}</td>
                            <td>${t.related_service ? DOMPurify.sanitize(t.related_service) : '-'}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Í±∞Îûò ÎÇ¥Ïó≠ Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('creditTransactionsTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:40px;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        async function loadAIUsageLog() {
            try {
                const { data: logs, error } = await supabaseClient
                    .from('ai_usage_log')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                const tbody = document.getElementById('aiUsageLogTableBody');
                if (!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#6c757d;padding:40px;">ÏÇ¨Ïö© Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';
                    return;
                }

                const serviceIcons = {
                    'ChatGPT': 'üü¢',
                    'Gemini': 'üîµ',
                    'Perplexity': 'üü†'
                };

                tbody.innerHTML = logs.map(l => `
                    <tr>
                        <td>${formatDateTime(l.created_at)}</td>
                        <td>${DOMPurify.sanitize(l.user_id)}</td>
                        <td>${serviceIcons[l.service_name] || 'ü§ñ'} ${DOMPurify.sanitize(l.service_name)}</td>
                        <td>${(l.tokens_used || 0).toLocaleString()}</td>
                        <td style="color:var(--danger);">-‚Ç©${l.cost.toLocaleString()}</td>
                        <td>${l.response_time_ms || 0}ms</td>
                        <td title="${DOMPurify.sanitize(l.prompt || '')}">${DOMPurify.sanitize((l.prompt || '').substring(0, 30))}...</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('AI ÏÇ¨Ïö© Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('aiUsageLogTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:40px;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        let lowBalanceUsers = [];

        async function loadLowBalanceUsers() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('user_id, name, email, credit_balance')
                    .lt('credit_balance', 1000)
                    .order('credit_balance', { ascending: true });

                if (error) throw error;

                lowBalanceUsers = users || [];
                const tbody = document.getElementById('lowBalanceTableBody');
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6c757d;padding:40px;">ÏûîÏï° Î∂ÄÏ°± ÏÇ¨Ïö©Ïûê ÏóÜÏùå</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${DOMPurify.sanitize(u.name || u.user_id)}</td>
                        <td>${DOMPurify.sanitize(u.email || '-')}</td>
                        <td style="color:var(--danger);font-weight:600;">‚Ç©${(u.credit_balance || 0).toLocaleString()}</td>
                        <td>
                            <a href="#" class="action-link" onclick="event.preventDefault(); sendLowBalanceNotification('${u.email}', '${u.name || u.user_id}', ${u.credit_balance || 0})">üìß ÏïåÎ¶º</a>
                            <a href="#" class="action-link" style="margin-left: 8px;" onclick="event.preventDefault(); chargeUserCredit('${u.user_id}', '${u.name || u.user_id}')">Ï∂©Ï†Ñ</a>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('ÏûîÏï° Î∂ÄÏ°± ÏÇ¨Ïö©Ïûê Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('lowBalanceTableBody').innerHTML =
                    '<tr><td colspan="4" style="text-align:center;color:#dc3545;padding:40px;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</td></tr>';
            }
        }

        // ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶º Î∞úÏÜ° (Í∞úÎ≥Ñ) - Ïù∏Ïï± ÏïåÎ¶º
        async function sendLowBalanceNotification(email, userName, balance) {
            // user_id Ï∞æÍ∏∞
            const user = lowBalanceUsers.find(u => u.email === email);
            if (!user) {
                showToast('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            if (!confirm(`${userName}ÎãòÏóêÍ≤å ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌòÑÏû¨ ÏûîÏï°: ‚Ç©${balance.toLocaleString()}`)) {
                return;
            }

            showLoading();
            try {
                // Ïù∏Ïï± ÏïåÎ¶º ÏÉùÏÑ±
                const { error } = await supabaseClient
                    .from('user_notifications')
                    .insert({
                        user_id: user.user_id,
                        notification_type: 'credit_low',
                        title: 'ÌÅ¨Î†àÎîß ÏûîÏï° Î∂ÄÏ°±',
                        message: `ÌòÑÏû¨ ÏûîÏï°Ïù¥ ‚Ç©${balance.toLocaleString()}ÏûÖÎãàÎã§. ÌÅ¨Î†àÎîßÏùÑ Ï∂©Ï†ÑÌï¥Ï£ºÏÑ∏Ïöî.`,
                        metadata: { balance: balance }
                    });

                if (error) {
                    console.log('Ïù∏Ïï± ÏïåÎ¶º ÏÉùÏÑ± Ïã§Ìå®:', error.message);
                    showToast('ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®: ' + error.message, 'error');
                } else {
                    showToast(`üîî ${userName}ÎãòÏóêÍ≤å Ïù∏Ïï± ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.`, 'success');
                }

            } catch (error) {
                console.error('ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', error);
                showToast('ÏïåÎ¶º Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶º Î∞úÏÜ° (Ï†ÑÏ≤¥) - Ïù∏Ïï± ÏïåÎ¶º
        async function sendLowBalanceNotificationAll() {
            if (lowBalanceUsers.length === 0) {
                showToast('ÏûîÏï° Î∂ÄÏ°± ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'info');
                return;
            }

            const userNames = lowBalanceUsers.map(u => u.name || u.user_id).join(', ');
            if (!confirm(`${lowBalanceUsers.length}Î™ÖÏóêÍ≤å ÏûîÏï° Î∂ÄÏ°± ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎåÄÏÉÅÏûê: ${userNames}`)) {
                return;
            }

            showLoading();
            try {
                let successCount = 0;

                for (const user of lowBalanceUsers) {
                    const { error } = await supabaseClient
                        .from('user_notifications')
                        .insert({
                            user_id: user.user_id,
                            notification_type: 'credit_low',
                            title: 'ÌÅ¨Î†àÎîß ÏûîÏï° Î∂ÄÏ°±',
                            message: `ÌòÑÏû¨ ÏûîÏï°Ïù¥ ‚Ç©${(user.credit_balance || 0).toLocaleString()}ÏûÖÎãàÎã§. ÌÅ¨Î†àÎîßÏùÑ Ï∂©Ï†ÑÌï¥Ï£ºÏÑ∏Ïöî.`,
                            metadata: { balance: user.credit_balance || 0 }
                        });

                    if (!error) successCount++;
                }

                showToast(`üîî ${successCount}Î™ÖÏóêÍ≤å Ïù∏Ïï± ÏïåÎ¶ºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§.`, 'success');

            } catch (error) {
                console.error('Ï†ÑÏ≤¥ ÏïåÎ¶º Î∞úÏÜ° Ïã§Ìå®:', error);
                showToast('ÏïåÎ¶º Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function showUserCreditHistory(userId) {
            try {
                showLoading();

                // Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÏùò Í±∞Îûò ÎÇ¥Ïó≠ Ï°∞Ìöå
                const { data: transactions, error } = await supabaseClient
                    .from('credit_transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                hideLoading();

                if (!transactions || transactions.length === 0) {
                    alert(`${userId} ÏÇ¨Ïö©ÏûêÏùò Í±∞Îûò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.`);
                    return;
                }

                // Í±∞Îûò ÎÇ¥Ïó≠ÏùÑ ÌåùÏóÖÏúºÎ°ú ÌëúÏãú
                const typeLabels = {
                    'charge': 'Ï∂©Ï†Ñ',
                    'spend': 'ÏÇ¨Ïö©',
                    'bonus': 'Î≥¥ÎÑàÏä§',
                    'expire': 'ÎßåÎ£å',
                    'admin_deduct': 'Í¥ÄÎ¶¨Ïûê Ï∞®Í∞ê'
                };

                let historyHtml = `<h3 style="margin-bottom:12px;">üìã ${userId} Í±∞Îûò ÎÇ¥Ïó≠</h3>`;
                historyHtml += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                historyHtml += '<tr style="background:#f8f9fa;"><th style="padding:8px;border:1px solid #ddd;">ÏùºÏãú</th><th style="padding:8px;border:1px solid #ddd;">Ïú†Ìòï</th><th style="padding:8px;border:1px solid #ddd;">Í∏àÏï°</th><th style="padding:8px;border:1px solid #ddd;">ÏûîÏï°</th><th style="padding:8px;border:1px solid #ddd;">ÏÑ§Î™Ö</th></tr>';

                transactions.forEach(t => {
                    const typeText = typeLabels[t.type] || t.type;
                    const amountColor = t.amount >= 0 ? '#28a745' : '#dc3545';
                    historyHtml += `<tr>
                        <td style="padding:6px;border:1px solid #ddd;">${formatDateTime(t.created_at)}</td>
                        <td style="padding:6px;border:1px solid #ddd;">${typeText}</td>
                        <td style="padding:6px;border:1px solid #ddd;color:${amountColor};font-weight:600;">${t.amount >= 0 ? '+' : ''}‚Ç©${t.amount.toLocaleString()}</td>
                        <td style="padding:6px;border:1px solid #ddd;">‚Ç©${t.balance_after.toLocaleString()}</td>
                        <td style="padding:6px;border:1px solid #ddd;">${t.description || '-'}</td>
                    </tr>`;
                });
                historyHtml += '</table>';

                // Í∞ÑÎã®Ìïú Î™®Îã¨ ÌëúÏãú
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
                modal.innerHTML = `
                    <div style="background:white;padding:24px;border-radius:12px;max-width:700px;max-height:80vh;overflow:auto;">
                        ${historyHtml}
                        <button onclick="this.closest('div').parentElement.remove()" style="margin-top:16px;padding:8px 20px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">Îã´Í∏∞</button>
                    </div>
                `;
                document.body.appendChild(modal);

            } catch (error) {
                hideLoading();
                console.error('ÏÇ¨Ïö©Ïûê Í±∞Îûò ÎÇ¥Ïó≠ Ï°∞Ìöå Ïã§Ìå®:', error);
                showToast('Í±∞Îûò ÎÇ¥Ïó≠ Ï°∞Ìöå Ïã§Ìå®: ' + error.message, 'error');
            }
        }

        async function chargeUserCredit(userId, userName) {
            const amount = prompt(`${userName}ÏóêÍ≤å Ï∂©Ï†ÑÌï† Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïõê):`);
            if (!amount || isNaN(parseInt(amount))) return;

            const chargeAmount = parseInt(amount);
            const reason = prompt('Ï∂©Ï†Ñ ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:') || 'Í¥ÄÎ¶¨Ïûê ÏàòÎèô Ï∂©Ï†Ñ';

            showLoading();
            try {
                // ÌòÑÏû¨ ÏûîÏï° Ï°∞Ìöå
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('credit_balance')
                    .eq('user_id', userId)
                    .single();

                const currentBalance = user?.credit_balance || 0;
                const newBalance = currentBalance + chargeAmount;

                // Í±∞Îûò ÎÇ¥Ïó≠ Ï∂îÍ∞Ä
                const { error: transError } = await supabaseClient
                    .from('credit_transactions')
                    .insert({
                        user_id: userId,
                        type: chargeAmount >= 0 ? 'bonus' : 'spend',
                        amount: chargeAmount,
                        balance_after: newBalance,
                        description: reason
                    });

                if (transError) throw transError;

                // ÏÇ¨Ïö©Ïûê ÏûîÏï° ÏóÖÎç∞Ïù¥Ìä∏
                const { error: userError } = await supabaseClient
                    .from('users')
                    .update({ credit_balance: newBalance })
                    .eq('user_id', userId);

                if (userError) throw userError;

                showToast(`${userName}ÏóêÍ≤å ‚Ç©${chargeAmount.toLocaleString()} ${chargeAmount >= 0 ? 'Ï∂©Ï†Ñ' : 'Ï∞®Í∞ê'} ÏôÑÎ£å`, 'success');
                await loadCreditData();

            } catch (error) {
                showToast('Ï≤òÎ¶¨ Ïã§Ìå®: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // showCreditChargeModal Ï†úÍ±∞Îê® - Ï∂©Ï†ÑÏùÄ ÏûÖÍ∏àÌôïÏù∏ÏóêÏÑú ÏûêÎèô Ï≤òÎ¶¨

        function exportCreditTransactions() {
            showToast('CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.', 'info');
        }

        // ========================================
        // Î¨∏Ïùò Í¥ÄÎ¶¨ (Inquiries) Ìï®ÏàòÎì§
        // ========================================
        let allInquiries = [];
        let currentInquiryFilter = 'all';

        async function loadInquiriesData() {
            try {
                showLoading();
                await Promise.all([
                    loadInquiriesStats(),
                    loadInquiriesList()
                ]);
            } catch (error) {
                console.error('Î¨∏Ïùò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                showToast('Î¨∏Ïùò Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadInquiriesStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('inquiries')
                    .select('status');

                if (error) throw error;

                const total = data.length;
                const pending = data.filter(i => i.status === 'pending').length;
                const inProgress = data.filter(i => i.status === 'in_progress').length;
                const answered = data.filter(i => i.status === 'answered' || i.status === 'closed').length;

                document.getElementById('inquiriesTotalCount').textContent = total;
                document.getElementById('inquiriesPendingCount').textContent = pending;
                document.getElementById('inquiriesInProgressCount').textContent = inProgress;
                document.getElementById('inquiriesAnsweredCount').textContent = answered;

                // ÏÇ¨Ïù¥ÎìúÎ∞î Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                const inquiryBadge = document.getElementById('inquiryBadge');
                if (inquiryBadge) {
                    if (pending > 0) {
                        inquiryBadge.textContent = pending;
                        inquiryBadge.style.display = 'inline-flex';
                    } else {
                        inquiryBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Î¨∏Ïùò ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        async function loadInquiriesList() {
            try {
                const { data, error } = await supabaseClient
                    .from('inquiries')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allInquiries = data || [];
                renderInquiriesTable(allInquiries);
            } catch (error) {
                console.error('Î¨∏Ïùò Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('inquiriesTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #dc3545;">
                            Î¨∏Ïùò Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
            }
        }

        function filterInquiries(filter) {
            currentInquiryFilter = filter;

            // Î≤ÑÌäº Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('btnInquiryAll').style.background = filter === 'all' ? 'var(--primary)' : 'var(--neutral)';
            document.getElementById('btnInquiryPending').style.background = filter === 'pending' ? 'var(--danger)' : 'var(--neutral)';
            document.getElementById('btnInquiryInProgress').style.background = filter === 'in_progress' ? 'var(--warning)' : 'var(--neutral)';
            document.getElementById('btnInquiryAnswered').style.background = filter === 'answered' ? 'var(--success)' : 'var(--neutral)';

            let filtered = allInquiries;
            if (filter !== 'all') {
                if (filter === 'answered') {
                    filtered = allInquiries.filter(i => i.status === 'answered' || i.status === 'closed');
                } else {
                    filtered = allInquiries.filter(i => i.status === filter);
                }
            }

            renderInquiriesTable(filtered);
        }

        function renderInquiriesTable(inquiries) {
            const tbody = document.getElementById('inquiriesTableBody');

            if (!inquiries || inquiries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                            Î¨∏ÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            const typeLabels = {
                'general': 'ÏùºÎ∞ò Î¨∏Ïùò',
                'technical': 'Í∏∞Ïà† ÏßÄÏõê',
                'payment': 'Í≤∞Ï†ú Î¨∏Ïùò',
                'account': 'Í≥ÑÏ†ï Í¥ÄÎ†®',
                'partnership': 'Ï†úÌú¥/ÌòëÎ†•',
                'other': 'Í∏∞ÌÉÄ'
            };

            const typeColors = {
                'general': '#6c757d',
                'technical': '#0099ff',
                'payment': '#28a745',
                'account': '#6B5CCC',
                'partnership': '#CC785C',
                'other': '#868e96'
            };

            const statusLabels = {
                'pending': 'ÎåÄÍ∏∞',
                'in_progress': 'Ï≤òÎ¶¨Ï§ë',
                'answered': 'ÏôÑÎ£å',
                'closed': 'Ï¢ÖÎ£å'
            };

            const statusClasses = {
                'pending': 'pending',
                'in_progress': 'active',
                'answered': 'answered',
                'closed': 'answered'
            };

            const priorityLabels = {
                'low': 'ÎÇÆÏùå',
                'normal': 'Î≥¥ÌÜµ',
                'high': 'ÎÜíÏùå',
                'urgent': 'Í∏¥Í∏â'
            };

            const priorityColors = {
                'low': '#6c757d',
                'normal': '#0099ff',
                'high': '#ffc107',
                'urgent': '#dc3545'
            };

            tbody.innerHTML = inquiries.map(inquiry => `
                <tr>
                    <td>
                        <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: ${typeColors[inquiry.inquiry_type] || '#6c757d'}20; color: ${typeColors[inquiry.inquiry_type] || '#6c757d'};">
                            ${DOMPurify.sanitize(typeLabels[inquiry.inquiry_type] || inquiry.inquiry_type)}
                        </span>
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${DOMPurify.sanitize(inquiry.title)}
                    </td>
                    <td>${DOMPurify.sanitize(inquiry.name)}</td>
                    <td>${DOMPurify.sanitize(inquiry.email)}</td>
                    <td>
                        <span class="status-badge ${statusClasses[inquiry.status] || 'pending'}">
                            ${statusLabels[inquiry.status] || inquiry.status}
                        </span>
                    </td>
                    <td>
                        <span style="color: ${priorityColors[inquiry.priority] || '#6c757d'}; font-weight: 500;">
                            ${priorityLabels[inquiry.priority] || inquiry.priority}
                        </span>
                    </td>
                    <td>${formatDateTime(inquiry.created_at)}</td>
                    <td>
                        <a href="#" class="action-link" onclick="event.preventDefault(); showInquiryDetail('${inquiry.id}')">
                            ${inquiry.status === 'pending' || inquiry.status === 'in_progress' ? 'ÎãµÎ≥ÄÌïòÍ∏∞' : 'Î≥¥Í∏∞'}
                        </a>
                        <a href="#" class="action-link" style="color: var(--danger); margin-left: 8px;" onclick="event.preventDefault(); deleteInquiry('${inquiry.id}', '${DOMPurify.sanitize(inquiry.title).replace(/'/g, "\\'")}')">ÏÇ≠Ï†ú</a>
                    </td>
                </tr>
            `).join('');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function showInquiryDetail(inquiryId) {
            const inquiry = allInquiries.find(i => i.id === inquiryId);
            if (!inquiry) return;

            const typeLabels = {
                'general': 'ÏùºÎ∞ò Î¨∏Ïùò',
                'technical': 'Í∏∞Ïà† ÏßÄÏõê',
                'payment': 'Í≤∞Ï†ú Î¨∏Ïùò',
                'account': 'Í≥ÑÏ†ï Í¥ÄÎ†®',
                'partnership': 'Ï†úÌú¥/ÌòëÎ†•',
                'other': 'Í∏∞ÌÉÄ'
            };

            const statusLabels = {
                'pending': 'ÎåÄÍ∏∞ Ï§ë',
                'in_progress': 'Ï≤òÎ¶¨ Ï§ë',
                'answered': 'ÎãµÎ≥Ä ÏôÑÎ£å',
                'closed': 'Ï¢ÖÎ£å'
            };

            const priorityLabels = {
                'low': 'ÎÇÆÏùå',
                'normal': 'Î≥¥ÌÜµ',
                'high': 'ÎÜíÏùå',
                'urgent': 'Í∏¥Í∏â'
            };

            const content = document.getElementById('inquiryDetailContent');
            content.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Î¨∏Ïùò Ïú†Ìòï</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(typeLabels[inquiry.inquiry_type] || inquiry.inquiry_type)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïö∞ÏÑ†ÏàúÏúÑ</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(priorityLabels[inquiry.priority] || inquiry.priority)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏûëÏÑ±Ïûê</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(inquiry.name)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïù¥Î©îÏùº</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(inquiry.email)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïó∞ÎùΩÏ≤ò</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(inquiry.phone || '-')}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ï†ëÏàòÏùº</div>
                            <div style="font-weight: 500;">${formatDateTime(inquiry.created_at)}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ï†úÎ™©</div>
                        <div style="font-weight: 600; font-size: 16px;">${DOMPurify.sanitize(inquiry.title)}</div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Î¨∏Ïùò ÎÇ¥Ïö©</div>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; white-space: pre-wrap;">${DOMPurify.sanitize(inquiry.content)}</div>
                    </div>

                    ${inquiry.answer ? `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÎãµÎ≥Ä (${formatDateTime(inquiry.answered_at)})</div>
                            <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; white-space: pre-wrap;">${DOMPurify.sanitize(inquiry.answer)}</div>
                        </div>
                    ` : ''}

                    ${inquiry.status === 'pending' || inquiry.status === 'in_progress' ? `
                        <div style="margin-top: 24px;">
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">ÎãµÎ≥Ä ÏûëÏÑ±</div>
                            <textarea id="inquiryAnswerText" style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="ÎãµÎ≥Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 12px;">
                                <button onclick="submitInquiryAnswer('${inquiry.id}')" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ÎãµÎ≥Ä Ï†ÄÏû•</button>
                                <button onclick="updateInquiryStatus('${inquiry.id}', 'in_progress')" style="padding: 12px 20px; background: var(--warning); color: white; border: none; border-radius: 8px; cursor: pointer;">Ï≤òÎ¶¨Ï§ëÏúºÎ°ú Î≥ÄÍ≤Ω</button>
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between;">
                        <button onclick="deleteInquiry('${inquiry.id}', '${DOMPurify.sanitize(inquiry.title).replace(/'/g, "\\'")}')" style="padding: 12px 20px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">Î¨∏Ïùò ÏÇ≠Ï†ú</button>
                        <button onclick="closeInquiryModal()" style="padding: 12px 20px; background: var(--neutral); color: #333; border: none; border-radius: 8px; cursor: pointer;">Îã´Í∏∞</button>
                    </div>
                </div>
            `;

            document.getElementById('inquiryDetailModal').style.display = 'flex';
        }

        function closeInquiryModal() {
            document.getElementById('inquiryDetailModal').style.display = 'none';
        }

        async function submitInquiryAnswer(inquiryId) {
            const answerText = document.getElementById('inquiryAnswerText').value.trim();
            if (!answerText) {
                showToast('ÎãµÎ≥Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('inquiries')
                    .update({
                        answer: answerText,
                        status: 'answered',
                        answered_at: new Date().toISOString(),
                        answered_by: 'ADMIN001'
                    })
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('ÎãµÎ≥ÄÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeInquiryModal();
                await loadInquiriesData();
            } catch (error) {
                console.error('ÎãµÎ≥Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                showToast('ÎãµÎ≥Ä Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateInquiryStatus(inquiryId, status) {
            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('inquiries')
                    .update({ status: status })
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeInquiryModal();
                await loadInquiriesData();
            } catch (error) {
                console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
                showToast('ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Î¨∏Ïùò ÏÇ≠Ï†ú
         */
        async function deleteInquiry(inquiryId, inquiryTitle) {
            const confirmed = confirm(`Ï†ïÎßêÎ°ú Î¨∏Ïùò "${inquiryTitle}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`);

            if (!confirmed) return;

            try {
                showLoading();

                const { error } = await supabaseClient
                    .from('inquiries')
                    .delete()
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('Î¨∏ÏùòÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');

                // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                await loadInquiriesData();

            } catch (error) {
                console.error('‚ùå Î¨∏Ïùò ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('Î¨∏Ïùò ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== Ïç®ÎãàÏóêÍ≤å Î¨ªÍ∏∞ Í¥ÄÎ¶¨ Ìï®Ïàò ==========
        let allSunnyInquiries = [];
        let currentSunnyFilter = 'all';

        async function loadSunnyInquiriesData() {
            try {
                showLoading();
                await Promise.all([
                    loadSunnyInquiriesStats(),
                    loadSunnyInquiriesList()
                ]);
            } catch (error) {
                console.error('Ïç®Îãà Î¨∏Ïùò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                showToast('Ïç®Îãà Î¨∏Ïùò Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadSunnyInquiriesStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('sunny_inquiries')
                    .select('status');

                if (error) throw error;

                const total = data.length;
                const pending = data.filter(i => i.status === 'pending').length;
                const inProgress = data.filter(i => i.status === 'in_progress').length;
                const answered = data.filter(i => i.status === 'answered' || i.status === 'closed').length;

                document.getElementById('sunnyTotalCount').textContent = total;
                document.getElementById('sunnyPendingCount').textContent = pending;
                document.getElementById('sunnyInProgressCount').textContent = inProgress;
                document.getElementById('sunnyAnsweredCount').textContent = answered;

                // ÏÇ¨Ïù¥ÎìúÎ∞î Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                const sunnyBadge = document.getElementById('sunnyInquiryBadge');
                if (sunnyBadge) {
                    if (pending > 0) {
                        sunnyBadge.textContent = pending;
                        sunnyBadge.style.display = 'inline-flex';
                    } else {
                        sunnyBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Ïç®Îãà Î¨∏Ïùò ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        async function loadSunnyInquiriesList() {
            try {
                const { data, error } = await supabaseClient
                    .from('sunny_inquiries')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allSunnyInquiries = data || [];
                renderSunnyInquiriesTable(allSunnyInquiries);
            } catch (error) {
                console.error('Ïç®Îãà Î¨∏Ïùò Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                document.getElementById('sunnyInquiriesTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                            Î¨∏Ïùò Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
            }
        }

        function filterSunnyInquiries(filter) {
            currentSunnyFilter = filter;

            // Î≤ÑÌäº Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('btnSunnyAll').style.background = filter === 'all' ? 'var(--primary)' : 'var(--neutral)';
            document.getElementById('btnSunnyPending').style.background = filter === 'pending' ? 'var(--danger)' : 'var(--neutral)';
            document.getElementById('btnSunnyAnswered').style.background = filter === 'answered' ? 'var(--success)' : 'var(--neutral)';

            let filtered = allSunnyInquiries;

            if (filter === 'pending') {
                filtered = allSunnyInquiries.filter(i => i.status === 'pending' || i.status === 'in_progress');
            } else if (filter === 'answered') {
                filtered = allSunnyInquiries.filter(i => i.status === 'answered' || i.status === 'closed');
            }

            renderSunnyInquiriesTable(filtered);
        }

        function renderSunnyInquiriesTable(inquiries) {
            const tbody = document.getElementById('sunnyInquiriesTableBody');

            if (inquiries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                            Î¨∏ÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§.
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                'pending': '<span style="color: #dc3545; font-weight: 500;">‚è≥ ÎåÄÍ∏∞</span>',
                'in_progress': '<span style="color: #ffc107; font-weight: 500;">üîÑ Ï≤òÎ¶¨Ï§ë</span>',
                'answered': '<span style="color: #28a745; font-weight: 500;">‚úÖ ÏôÑÎ£å</span>',
                'closed': '<span style="color: #6c757d; font-weight: 500;">üîí Ï¢ÖÎ£å</span>'
            };

            tbody.innerHTML = inquiries.map(inquiry => `
                <tr>
                    <td>
                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${DOMPurify.sanitize(inquiry.title || inquiry.content?.substring(0, 50) || '(Ï†úÎ™© ÏóÜÏùå)')}
                        </div>
                    </td>
                    <td>${DOMPurify.sanitize(inquiry.user_name || inquiry.user_email || 'ÏùµÎ™Ö')}</td>
                    <td>${statusLabels[inquiry.status] || inquiry.status}</td>
                    <td>${formatDate(inquiry.created_at)}</td>
                    <td>
                        <a href="#" class="action-link" onclick="event.preventDefault(); showSunnyDetail('${inquiry.id}')">
                            ${inquiry.status === 'pending' || inquiry.status === 'in_progress' ? 'ÎãµÎ≥ÄÌïòÍ∏∞' : 'Î≥¥Í∏∞'}
                        </a>
                        <a href="#" class="action-link" style="color: var(--danger); margin-left: 8px;" onclick="event.preventDefault(); deleteSunnyInquiry('${inquiry.id}')">ÏÇ≠Ï†ú</a>
                    </td>
                </tr>
            `).join('');
        }

        function showSunnyDetail(inquiryId) {
            const inquiry = allSunnyInquiries.find(i => i.id === inquiryId);
            if (!inquiry) return;

            const statusLabels = {
                'pending': 'ÎåÄÍ∏∞ Ï§ë',
                'in_progress': 'Ï≤òÎ¶¨ Ï§ë',
                'answered': 'ÎãµÎ≥Ä ÏôÑÎ£å',
                'closed': 'Ï¢ÖÎ£å'
            };

            const priorityLabels = {
                'low': 'ÎÇÆÏùå',
                'normal': 'Î≥¥ÌÜµ',
                'high': 'ÎÜíÏùå',
                'urgent': 'Í∏¥Í∏â'
            };

            const content = document.getElementById('sunnyDetailContent');
            content.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏÉÅÌÉú</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(statusLabels[inquiry.status] || inquiry.status)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïö∞ÏÑ†ÏàúÏúÑ</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(priorityLabels[inquiry.priority] || inquiry.priority || 'Î≥¥ÌÜµ')}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏûëÏÑ±Ïûê</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(inquiry.user_name || 'ÏùµÎ™Ö')}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ïù¥Î©îÏùº</div>
                            <div style="font-weight: 500;">${DOMPurify.sanitize(inquiry.user_email || '-')}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ï†ëÏàòÏùº</div>
                            <div style="font-weight: 500;">${formatDateTime(inquiry.created_at)}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ï†úÎ™©</div>
                        <div style="font-weight: 600; font-size: 16px;">${DOMPurify.sanitize(inquiry.title || '(Ï†úÎ™© ÏóÜÏùå)')}</div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÏßàÎ¨∏ ÎÇ¥Ïö©</div>
                        <div style="background: #fff8e1; padding: 16px; border-radius: 8px; white-space: pre-wrap; border-left: 4px solid #ffc107;">${DOMPurify.sanitize(inquiry.content)}</div>
                    </div>

                    ${inquiry.attachments && inquiry.attachments.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">Ï≤®Î∂ÄÌååÏùº</div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${inquiry.attachments.map(att => `
                                    <a href="${DOMPurify.sanitize(att.url)}" target="_blank" style="padding: 8px 12px; background: #f8f9fa; border-radius: 6px; text-decoration: none; color: #333; font-size: 13px;">
                                        üìé ${DOMPurify.sanitize(att.name)}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${inquiry.admin_answer ? `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px;">ÎãµÎ≥Ä (${formatDateTime(inquiry.answered_at)})</div>
                            <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; white-space: pre-wrap; border-left: 4px solid #28a745;">${DOMPurify.sanitize(inquiry.admin_answer)}</div>
                        </div>
                    ` : ''}

                    ${inquiry.status === 'pending' || inquiry.status === 'in_progress' ? `
                        <div style="margin-top: 24px;">
                            <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">ÎãµÎ≥Ä ÏûëÏÑ±</div>
                            <textarea id="sunnyAnswerText" style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="ÎãµÎ≥Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 12px;">
                                <button onclick="submitSunnyAnswer('${inquiry.id}')" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">‚òÄÔ∏è ÎãµÎ≥Ä Ï†ÄÏû•</button>
                                <button onclick="updateSunnyStatus('${inquiry.id}', 'in_progress')" style="padding: 12px 20px; background: var(--warning); color: white; border: none; border-radius: 8px; cursor: pointer;">Ï≤òÎ¶¨Ï§ëÏúºÎ°ú Î≥ÄÍ≤Ω</button>
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between;">
                        <button onclick="deleteSunnyInquiry('${inquiry.id}')" style="padding: 12px 20px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">Î¨∏Ïùò ÏÇ≠Ï†ú</button>
                        <button onclick="closeSunnyDetail()" style="padding: 12px 20px; background: var(--neutral); color: #333; border: none; border-radius: 8px; cursor: pointer;">Îã´Í∏∞</button>
                    </div>
                </div>
            `;

            document.getElementById('sunnyDetailModal').style.display = 'flex';
        }

        function closeSunnyDetail() {
            document.getElementById('sunnyDetailModal').style.display = 'none';
        }

        async function submitSunnyAnswer(inquiryId) {
            const answerText = document.getElementById('sunnyAnswerText').value.trim();
            if (!answerText) {
                showToast('ÎãµÎ≥Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('sunny_inquiries')
                    .update({
                        admin_answer: answerText,
                        status: 'answered',
                        answered_at: new Date().toISOString(),
                        answered_by: 'ADMIN001'
                    })
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('ÎãµÎ≥ÄÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeSunnyDetail();
                await loadSunnyInquiriesData();
            } catch (error) {
                console.error('ÎãµÎ≥Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                showToast('ÎãµÎ≥Ä Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateSunnyStatus(inquiryId, status) {
            try {
                showLoading();
                const { error } = await supabaseClient
                    .from('sunny_inquiries')
                    .update({ status: status })
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeSunnyDetail();
                await loadSunnyInquiriesData();
            } catch (error) {
                console.error('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
                showToast('ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteSunnyInquiry(inquiryId) {
            const confirmed = confirm('Ï†ïÎßêÎ°ú Ïù¥ Î¨∏ÏùòÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.');

            if (!confirmed) return;

            try {
                showLoading();

                const { error } = await supabaseClient
                    .from('sunny_inquiries')
                    .delete()
                    .eq('id', inquiryId);

                if (error) throw error;

                showToast('Î¨∏ÏùòÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                closeSunnyDetail();
                await loadSunnyInquiriesData();

            } catch (error) {
                console.error('‚ùå Ïç®Îãà Î¨∏Ïùò ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showToast('Î¨∏Ïùò ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== ÏÑ§Ï†ï Í¥ÄÎ¶¨ Ìï®Ïàò ==========

        // ÏÑ§Ï†ï Î°úÎìú
        async function loadAdminSettings() {
            try {
                const { data, error } = await supabaseClient
                    .from('admin_settings')
                    .select('*')
                    .single();

                if (error) {
                    // ÏÑ§Ï†ïÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                    if (error.code === 'PGRST116') {
                        setDefaultSettings();
                        return;
                    }
                    throw error;
                }

                // Í∞í ÏÑ§Ï†ï
                document.getElementById('settingPlatformName').value = data.platform_name || 'SSAL Works';
                document.getElementById('settingAdminEmail').value = data.admin_email || '';
                document.getElementById('settingTimezone').value = data.timezone || 'Asia/Seoul';
                document.getElementById('settingNotifyInquiry').checked = data.notify_inquiry ?? true;
                document.getElementById('settingNotifyPayment').checked = data.notify_payment ?? true;
                document.getElementById('settingNotifySignup').checked = data.notify_signup ?? false;
                document.getElementById('settingNotifyInstallationRequest').checked = data.notify_installation_request ?? true;
                document.getElementById('settingInstallFee').value = data.install_fee || 3000000;
                document.getElementById('settingMonthlyFee').value = data.monthly_fee || 50000;
                document.getElementById('settingCreditPrice').value = data.credit_price || 1;

                if (data.last_backup) {
                    const backupDate = new Date(data.last_backup).toLocaleString('ko-KR');
                    document.getElementById('settingLastBackup').textContent = 'ÎßàÏßÄÎßâ Î∞±ÏóÖ: ' + backupDate;
                }

            } catch (error) {
                console.error('ÏÑ§Ï†ï Î°úÎìú Ïò§Î•ò:', error);
                setDefaultSettings();
            }
        }

        // Í∏∞Î≥∏ ÏÑ§Ï†ïÍ∞í
        function setDefaultSettings() {
            document.getElementById('settingPlatformName').value = 'SSAL Works';
            document.getElementById('settingAdminEmail').value = '';
            document.getElementById('settingTimezone').value = 'Asia/Seoul';
            document.getElementById('settingNotifyInquiry').checked = true;
            document.getElementById('settingNotifyPayment').checked = true;
            document.getElementById('settingNotifySignup').checked = false;
            document.getElementById('settingNotifyInstallationRequest').checked = true;
            document.getElementById('settingInstallFee').value = 3000000;
            document.getElementById('settingMonthlyFee').value = 50000;
            document.getElementById('settingCreditPrice').value = 1;
        }

        // ÏÑ§Ï†ï Ï†ÄÏû• (ÏÑúÎ≤Ñ API ÏÇ¨Ïö©)
        async function saveAdminSettings() {
            try {
                showLoading('ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë...');

                const settings = {
                    platform_name: document.getElementById('settingPlatformName').value,
                    admin_email: document.getElementById('settingAdminEmail').value,
                    timezone: document.getElementById('settingTimezone').value,
                    notify_inquiry: document.getElementById('settingNotifyInquiry').checked,
                    notify_payment: document.getElementById('settingNotifyPayment').checked,
                    notify_signup: document.getElementById('settingNotifySignup').checked,
                    notify_installation_request: document.getElementById('settingNotifyInstallationRequest').checked,
                    install_fee: parseInt(document.getElementById('settingInstallFee').value) || 3000000,
                    monthly_fee: parseInt(document.getElementById('settingMonthlyFee').value) || 50000,
                    credit_price: parseInt(document.getElementById('settingCreditPrice').value) || 1
                };

                console.log('üì§ ÏÑ§Ï†ï Ï†ÄÏû• ÏöîÏ≤≠:', settings);

                const response = await fetch('/api/Backend_APIs/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                console.log('üì• ÏÑ§Ï†ï Ï†ÄÏû• ÏùëÎãµ:', result);

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Ï†ÄÏû• Ïã§Ìå®');
                }

                showToast('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');

            } catch (error) {
                console.error('ÏÑ§Ï†ï Ï†ÄÏû• Ïò§Î•ò:', error);
                showToast('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ========== Í¥ÄÎ¶¨Ïûê ÏïåÎ¶º Ìï®Ïàò ==========

        // Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Ïù¥Î©îÏùº ÏïåÎ¶º Î∞úÏÜ°
        async function sendAdminNotify(type, data) {
            try {
                const response = await fetch('https://www.ssalworks.ai.kr/api/Backend_APIs/admin-notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, data })
                });

                const result = await response.json();
                if (result.sent) {
                    console.log('‚úÖ Í¥ÄÎ¶¨Ïûê ÏïåÎ¶º Ïù¥Î©îÏùº Î∞úÏÜ°Îê®:', result.emailId);
                } else {
                    console.log('‚ÑπÔ∏è Í¥ÄÎ¶¨Ïûê ÏïåÎ¶º ÎØ∏Î∞úÏÜ°:', result.reason);
                }
                return result;
            } catch (error) {
                console.error('Í¥ÄÎ¶¨Ïûê ÏïåÎ¶º Î∞úÏÜ° Ïò§Î•ò:', error);
                throw error;
            }
        }

        // ÏÇ¨Ïö©Ïûê Ïù¥Î©îÏùº Ï°∞Ìöå Ìó¨Ìçº
        async function getUserEmail(userId) {
            const { data } = await supabaseClient
                .from('users')
                .select('email')
                .eq('id', userId)
                .single();
            return data?.email || 'Unknown';
        }

        // ========== Î™®Î∞îÏùº ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Ìï®Ïàò ==========
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (sidebar) {
                sidebar.classList.remove('open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // ESC ÌÇ§Î°ú ÏÇ¨Ïù¥ÎìúÎ∞î Îã´Í∏∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });

        // Î™®Î∞îÏùº ÌÖåÏù¥Î∏î Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ wrapper Ï∂îÍ∞Ä
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.data-table').forEach(function(table) {
                    if (!table.parentElement.classList.contains('table-wrapper')) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-wrapper';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            }
        });

    </script>
</body>
</html>
