# S4 개발-3차 Stage 안내문

## Stage 개요

**Stage 명칭**: S4 개발-3차 (Payment & Admin)
**핵심 목표**: 결제 시스템 구축 및 운영 자동화

---

## 결제 시스템 개요

### 요금 체계 (2025-12-19 확정)

| 항목 | 금액 | 결제 방법 |
|------|------|----------|
| **설치비** | ₩3,000,000 | 무통장 입금 |
| **초기 크레딧** | ₩50,000 | 설치비 확인 시 자동 지급 |
| **무료 기간** | 3개월 | 설치비 확인 시 시작 |
| **월 이용료** | ₩50,000/월 | 토스페이먼츠 (4개월차~) |
| **크레딧 충전** | ₩10,000~₩50,000 | 토스페이먼츠 |

### 결제 타임라인

```
[최초] 설치비 ₩3,000,000 무통장 입금
        ↓
[확인] 관리자 입금 확인
        ↓
[혜택] 초기 크레딧 ₩50,000 지급
        + 서비스 활성화
        + 3개월 무료 기간 시작
        ↓
[1~3개월차] 월 이용료 ₩0 (무료)
        ↓
[4개월차~] 월 이용료 ₩50,000/월 자동결제
```

---

## S4 Stage Task 목록

### Payment (결제) 관련

| Task ID | Task Name | 설명 | 결제 방법 |
|---------|-----------|------|----------|
| S4BA1 | 설치비 무통장 입금 API | 입금 요청/조회/취소 | 무통장 입금 |
| S4BA2 | 설치비 입금 확인 API | 관리자 확인/거부 | - |
| S4BA3 | 토스페이먼츠 결제 API | 크레딧/구독 결제 | 토스페이먼츠 |

### Admin (관리자) 관련

| Task ID | Task Name | 설명 |
|---------|-----------|------|
| S4F1 | 관리자 대시보드 | 통계, 입금확인, 결제관리 |

### Email (이메일) 관련

| Task ID | Task Name | 설명 |
|---------|-----------|------|
| S4BA6 | 이메일 템플릿 | 결제/알림 이메일 13종 |

### DevOps (자동화) 관련

| Task ID | Task Name | 설명 |
|---------|-----------|------|
| S4O1 | Cron Jobs | 구독 만료, 입금 만료 처리 |

---

## 핵심 기능 상세

### 1. 설치비 무통장 입금 (S4BA1)

**프로세스:**
1. 사용자가 설치비 입금 요청
2. 6자리 입금코드 발급 (예: `ABC123`)
3. 계좌 정보 안내 (기업은행 000-000000-00-000)
4. 7일 이내 입금 (만료 시 자동 취소)
5. 관리자 입금 확인 (S4BA2)

**API 엔드포인트:**
```
POST /api/payment/installation/request  # 입금 요청
GET  /api/payment/installation/status   # 상태 조회
POST /api/payment/installation/cancel   # 취소
GET  /api/payment/installation/info     # 계좌 정보
```

### 2. 설치비 입금 확인 (S4BA2)

**입금 확인 시 자동 처리:**
- ✅ is_service_active = true
- ✅ credit_balance += 50,000
- ✅ subscription_started_at 설정
- ✅ next_billing_date = 현재 + 3개월
- ✅ 환영 이메일 발송

**API 엔드포인트:**
```
GET  /api/admin/installation/pending    # 대기 목록
POST /api/admin/installation/confirm    # 입금 확인
POST /api/admin/installation/reject     # 입금 거부
GET  /api/admin/installation/history    # 처리 이력
```

### 3. 토스페이먼츠 (S4BA3)

**크레딧 충전:**
- 금액 옵션: ₩10,000 / ₩20,000 / ₩30,000 / ₩50,000
- 일반 카드 결제 (1회성)

**월 이용료:**
- 금액: ₩50,000/월
- 빌링키 자동결제
- 4개월차부터 과금 시작

**API 엔드포인트:**
```
POST /api/payment/credit/request     # 크레딧 충전 요청
GET  /api/payment/credit/success     # 결제 성공 콜백
GET  /api/payment/credit/fail        # 결제 실패 콜백
POST /api/payment/billing/register   # 빌링키 등록
POST /api/payment/billing/charge     # 월 이용료 결제
POST /api/webhook/toss               # 토스 웹훅
```

### 4. 관리자 대시보드 (S4F1)

**주요 페이지:**
- `dashboard.html` - 메인 대시보드 (통계, 매출)
- `installation.html` - 설치비 입금 확인
- `payments.html` - 결제 내역 (크레딧/구독)
- `subscriptions.html` - 구독 관리 (빌링)
- `credits.html` - 크레딧 관리

**핵심 기능:**
- 입금 대기 알림 (긴급 표시)
- 매출 구분 (설치비/크레딧/구독)
- 결제 실패 재시도
- 크레딧 수동 지급

### 5. 이메일 템플릿 (S4BA6)

**결제 관련 (7종):**
- 설치비 입금 안내
- 서비스 활성화 완료
- 입금 거부 안내
- 크레딧 충전 완료
- 월 이용료 결제 완료
- 결제 실패 안내
- 크레딧 부족 알림

**구독 관련 (3종):**
- 결제일 사전 안내
- 구독 만료 예정
- 구독 만료 완료

**기타 (3종):**
- 비밀번호 재설정
- 웰컴 이메일
- 공지사항

---

## 크레딧 부족 처리 (S3F1 연동)

### 크레딧 소진 시 대안

**옵션 1: 크레딧 충전**
- 토스페이먼츠로 즉시 충전
- ₩10,000 / ₩20,000 / ₩30,000(추천) / ₩50,000

**옵션 2: 써니에게 묻기**
- 크레딧 소모 없음
- 기본적인 질문 응답 가능

### 크레딧 부족 모달 UI

```
┌────────────────────────────────────┐
│     💳 크레딧이 부족합니다         │
├────────────────────────────────────┤
│ 현재 잔액: ₩1,200                  │
│ 필요 크레딧: 약 ₩50                │
├────────────────────────────────────┤
│ 크레딧 충전                         │
│ ┌────────┐ ┌────────┐              │
│ │₩10,000 │ │₩20,000 │              │
│ └────────┘ └────────┘              │
│ ┌────────┐ ┌────────┐              │
│ │₩30,000 │ │₩50,000 │              │
│ │ 추천   │ │        │              │
│ └────────┘ └────────┘              │
├────────────────────────────────────┤
│          또는                       │
│ ☀️ 써니에게 묻기 [이용하기]        │
│    크레딧 없이 기본 질문            │
└────────────────────────────────────┘
```

---

## 환경 변수 설정

### 필수 환경 변수

```env
# 무통장 입금 계좌
BANK_NAME=기업은행
BANK_ACCOUNT=000-000000-00-000
BANK_HOLDER=SSALWorks

# 토스페이먼츠
TOSS_CLIENT_KEY=test_ck_...
TOSS_SECRET_KEY=test_sk_...
TOSS_WEBHOOK_SECRET=...

# 이메일 (Resend)
RESEND_API_KEY=re_...

# 결제 콜백 URL
PAYMENT_SUCCESS_URL=https://ssalworks.com/payment/success
PAYMENT_FAIL_URL=https://ssalworks.com/payment/fail
```

### 시스템 설정 (DB)

```sql
-- system_config 테이블
INSTALLATION_FEE = 3000000     -- ₩3,000,000
INITIAL_CREDIT = 50000         -- ₩50,000
FREE_PERIOD_MONTHS = 3         -- 3개월
MONTHLY_FEE = 50000           -- ₩50,000
CREDIT_OPTIONS = [10000, 20000, 30000, 50000]
AI_MARGIN_RATE = 1.2          -- 20% 마진
USD_TO_KRW = 1300             -- 환율
```

---

## Stage Gate 검증 항목

### 필수 통과 조건

1. **설치비 입금 플로우**
   - [ ] 입금 요청 → 입금코드 발급 → 관리자 확인 → 서비스 활성화
   - [ ] 초기 크레딧 ₩50,000 정확히 지급

2. **토스 결제 플로우**
   - [ ] 크레딧 충전 → 토스 결제창 → 충전 완료
   - [ ] 빌링키 등록 → 월 이용료 자동결제

3. **관리자 대시보드**
   - [ ] 입금 확인 가능
   - [ ] 결제 내역 조회 가능

4. **이메일 발송**
   - [ ] 모든 결제 관련 이메일 정상 발송

5. **크레딧 부족 처리**
   - [ ] 모달 표시 → 충전/써니 선택

---

## 참고 문서

| 문서 | 경로 |
|------|------|
| 요금 체계 | `Human_ClaudeCode_Bridge/Reports/SSALWorks_요금체계_정리.json` |
| Task Instructions | `S0_Project-SSAL-Grid_생성/ssal-grid/task-instructions/` |
| Seed SQL | `S0_Project-SSAL-Grid_생성/ssal-grid/seed-sql/S4_payment_seed.sql` |
| Verification | `S0_Project-SSAL-Grid_생성/ssal-grid/verification-instructions/` |

---

## 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2025-12-19 | S4 결제 시스템 전면 수정 (무통장+토스 하이브리드) |
| - | 설치비 무통장 입금만 허용 (₩3,000,000) |
| - | 크레딧/구독은 토스페이먼츠 |
| - | 크레딧 부족 모달 추가 |
