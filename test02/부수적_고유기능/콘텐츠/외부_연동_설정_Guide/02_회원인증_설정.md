# 회원인증 설정 가이드

> Google OAuth + Supabase Auth 통합 설정

---

# Part A - 기초

> PO(Project Owner; 사람)가 직접 해야 할 설정

---

## Step 1: Google Cloud Console 프로젝트 만들기

1. https://console.cloud.google.com 접속
2. Google 계정으로 로그인
3. 상단 프로젝트 선택 → **"새 프로젝트"** 클릭
4. 프로젝트 이름: `SSALWorks` 입력
5. **"만들기"** 클릭

---

## Step 2: OAuth 동의 화면 설정

1. 왼쪽 메뉴 → **"API 및 서비스"** → **"OAuth 동의 화면"**
2. **"외부"** 선택 → **"만들기"**
3. 아래 정보 입력:

| 항목 | 입력 |
|------|------|
| 앱 이름 | SSALWorks |
| 사용자 지원 이메일 | 본인 이메일 |
| 개발자 연락처 | 본인 이메일 |

4. **"저장 후 계속"** (범위 설정은 건너뛰기)
5. 테스트 사용자에 본인 이메일 추가

---

## Step 3: OAuth 클라이언트 ID 만들기

1. **"사용자 인증 정보"** → **"+ 사용자 인증 정보 만들기"** → **"OAuth 클라이언트 ID"**
2. **"웹 애플리케이션"** 선택 (중요!)
3. 이름: `SSALWorks Web Client`
4. 승인된 리디렉션 URI 추가:
   ```
   https://[프로젝트ID].supabase.co/auth/v1/callback
   ```
5. **"만들기"** 클릭
6. 아래 2가지 복사해서 메모:

| 항목 | 형식 |
|------|------|
| 클라이언트 ID | `xxx.apps.googleusercontent.com` |
| 클라이언트 보안 비밀번호 | `GOCSPX-xxx` |

---

## Step 4: Supabase에 Google 연결

1. https://supabase.com 로그인 → 프로젝트 선택
2. **"Authentication"** → **"Providers"** → **"Google"**
3. 아래 정보 입력:

| 항목 | 입력 |
|------|------|
| Google enabled | 켜기 |
| Client ID | Step 3에서 복사한 클라이언트 ID |
| Client Secret | Step 3에서 복사한 보안 비밀번호 |

4. **"Save"** 클릭

---

## 체크리스트

- [ ] Google Cloud 프로젝트 생성 완료
- [ ] OAuth 동의 화면 설정 완료
- [ ] OAuth 클라이언트 ID 생성 (**웹 애플리케이션** 타입)
- [ ] 리디렉션 URI 추가 완료
- [ ] 클라이언트 ID 복사 완료
- [ ] 클라이언트 보안 비밀번호 복사 완료
- [ ] Supabase Google Provider 활성화 완료

---

# Part B - 심화

> Claude Code 참조용 기술 문서

**전제조건**: Part A 완료 (Google OAuth 설정, Supabase Provider 활성화)

---

## 1. 환경변수 설정

```bash
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGci...

# 선택 (Supabase Provider에서 관리)
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx
```

---

## 2. Supabase Redirect URLs 설정

```
Dashboard → Authentication → URL Configuration

Site URL: https://yourdomain.com

Redirect URLs:
- http://localhost:3000/**
- http://localhost:8888/**
- https://yourdomain.com/**
- https://*.vercel.app/**
```

---

## 3. 프론트엔드 구현

### 3.1 Supabase Client 초기화

```html
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://[프로젝트ID].supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGci...';

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
```

### 3.2 Google 로그인

```javascript
async function handleGoogleLogin() {
    const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
            redirectTo: window.location.origin + '/index.html',
            queryParams: {
                access_type: 'offline',
                prompt: 'consent'
            }
        }
    });

    if (error) {
        console.error('로그인 오류:', error.message);
    }
}
```

### 3.3 세션 확인

```javascript
async function checkSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();

    if (session) {
        console.log('로그인됨:', session.user.email);
        return session.user;
    }
    return null;
}
```

### 3.4 로그아웃

```javascript
async function handleLogout() {
    const { error } = await supabaseClient.auth.signOut();
    if (!error) {
        window.location.href = '/pages/auth/login.html';
    }
}
```

### 3.5 인증 상태 변경 감지

```javascript
supabaseClient.auth.onAuthStateChange((event, session) => {
    switch (event) {
        case 'SIGNED_IN':
            console.log('로그인:', session.user);
            break;
        case 'SIGNED_OUT':
            console.log('로그아웃');
            window.location.href = '/login';
            break;
        case 'TOKEN_REFRESHED':
            console.log('토큰 갱신됨');
            break;
    }
});
```

---

## 4. users 테이블 동기화

Google 로그인 시 `auth.users`에만 데이터가 생성됨. `public.users`와 동기화 필요.

### 4.1 Trigger 함수

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.users (user_id, email, nickname)
    VALUES (NEW.id, NEW.email, NEW.raw_user_meta_data->>'name')
    ON CONFLICT (user_id) DO UPDATE SET
        email = EXCLUDED.email,
        nickname = EXCLUDED.nickname;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 4.2 Trigger 적용

```sql
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

---

## 5. 트러블슈팅

### 문제 1: redirect_uri_mismatch

**해결**: Google Cloud Console에서 리디렉션 URI 정확히 추가
```
https://[프로젝트ID].supabase.co/auth/v1/callback
```

### 문제 2: 리디렉션 URI 입력란이 안 보임

**해결**: OAuth 클라이언트 타입을 **"웹 애플리케이션"**으로 다시 생성

### 문제 3: Unsupported provider

**해결**: Supabase Authentication → Providers → Google → Enable 켜기

### 문제 4: 로컬 테스트 시 페이지 오류

**해결**: `file://` 프로토콜 금지. 로컬 서버 사용:
```bash
npx serve . -l 8888
```

### 문제 5: 로그인 성공했는데 users 테이블에 없음

**해결**: 위 "4. users 테이블 동기화" Trigger 적용

---

## 6. 이메일/비밀번호 회원가입 및 인증

> 2026-01-20 업데이트: 이메일 인증 프로세스 강화

### 6.1 회원가입 플로우

```
1. 사용자 회원가입
   ↓
2. subscription_status: 'inactive' 저장
   ↓
3. 인증 이메일 발송 (verify-email.html 링크)
   ↓
4. 사용자가 이메일 링크 클릭
   ↓
5. verify-email.html에서 인증 처리
   ↓
6. subscription_status: 'free'로 변경
   ↓
7. 로그인 가능
```

### 6.2 회원가입 코드 (emailRedirectTo 필수)

```javascript
const { data, error } = await supabaseClient.auth.signUp({
    email: email,
    password: password,
    options: {
        data: {
            nickname: nickname,
            real_name: realName
        },
        // 이메일 인증 완료 후 리다이렉트 URL (필수!)
        emailRedirectTo: window.location.origin + '/pages/auth/verify-email.html'
    }
});
```

### 6.3 users 테이블 초기 상태

```javascript
// 회원가입 시 subscription_status를 'inactive'로 설정
const { error } = await supabaseClient
    .from('users')
    .upsert({
        id: authData.user.id,
        email: email,
        subscription_status: 'inactive',  // 인증 전까지 비활성
        // ...기타 필드
    });
```

### 6.4 로그인 시 인증 상태 확인

```javascript
// 로그인 성공 후 subscription_status 확인
const { data: userData } = await supabaseClient
    .from('users')
    .select('subscription_status')
    .eq('id', data.user.id)
    .single();

// 'inactive' 상태면 로그인 차단
if (userData?.subscription_status === 'inactive') {
    await supabaseClient.auth.signOut();
    showAlert('이메일 인증이 완료되지 않았습니다.');
    return;
}
```

### 6.5 관련 파일

| 파일 | 역할 |
|------|------|
| `pages/auth/signup.html` | 회원가입 폼 |
| `pages/auth/verify-email.html` | 이메일 인증 완료 페이지 |
| `pages/auth/login.html` | 로그인 (미인증 차단) |

---

## 참고 문서

- [Supabase Auth 가이드](https://supabase.com/docs/guides/auth)
- [Google OAuth 설정](https://supabase.com/docs/guides/auth/social-login/auth-google)
