# 이메일 시스템 설정 가이드

> Resend + Supabase SMTP + DKIM 인증

---

# Part A - 기초

> PO(Project Owner; 사람)가 직접 해야 할 설정

---

## Step 1: Resend 계정 만들기

1. https://resend.com 접속
2. **"Sign up"** 클릭
3. Google 또는 이메일로 가입

---

## Step 2: API Key 발급

1. Dashboard → **API Keys** → **Create API Key**
2. 아래 정보 입력:

| 항목 | 입력 |
|------|------|
| Name | ssalworks-production |
| Permission | Full access |

3. **생성 즉시 복사** (한 번만 표시됨)
4. API Key 형식: `re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

---

## Step 3: 도메인 등록

1. Dashboard → **Domains** → **Add Domain**
2. 본인 도메인 입력: `ssalworks.ai.kr`
3. 상태: Pending (DKIM 인증 대기)

---

## Step 4: DKIM DNS 설정 (Whois)

1. Resend Dashboard에서 도메인 클릭 → DNS Records 확인
2. 아래 정보 복사:

| Type | Name | Value |
|------|------|-------|
| TXT | resend._domainkey | `p=MIGfMA0GCSqGSIb3DQEBA...` (Resend 제공) |

3. Whois 로그인 → 도메인 관리 → 부가서비스 → **네임서버 고급설정**
4. **SPF(TXT) 레코드 관리** → 관리페이지 열기
5. 위 정보 입력 후 저장
6. DNS 전파 대기 (보통 1-2시간)
7. Resend Dashboard에서 **"Verify"** 클릭

---

## Step 5: Supabase SMTP 설정

1. Supabase Dashboard → **Settings** → **Auth** → **SMTP Settings**
2. **Enable Custom SMTP**: ON
3. 아래 정보 입력:

| 항목 | 입력 |
|------|------|
| SMTP Host | smtp.resend.com |
| SMTP Port | 587 |
| SMTP Username | resend |
| SMTP Password | [Resend API Key] |
| Sender Email | noreply@ssalworks.ai.kr |
| Sender Name | SSALWorks |

---

## Step 6: 이메일 템플릿 URL 수정

> 2026-01-20 업데이트: verify-email.html 페이지 추가

1. Supabase → **Authentication** → **Email Templates** → **Confirm signup**
2. 템플릿에서 URL 하드코딩:

**변경 전**:
```html
<a href="{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=signup">
```

**변경 후** (verify-email.html 사용):
```html
<a href="https://www.ssalworks.ai.kr/pages/auth/verify-email.html?token_hash={{ .TokenHash }}&type=signup">
```

3. Reset Password, Magic Link 템플릿도 동일하게 수정

### verify-email.html 페이지 기능

| 기능 | 설명 |
|------|------|
| 토큰 처리 | URL 파라미터에서 token_hash 자동 추출 |
| 인증 완료 | Supabase verifyOtp() 호출 |
| 상태 업데이트 | subscription_status: 'inactive' → 'free' |
| UI 피드백 | 성공/실패/이미인증됨 상태 표시 |

---

## 체크리스트

- [ ] Resend 계정 생성 완료
- [ ] API Key 발급 및 복사 완료
- [ ] 도메인 등록 완료
- [ ] Whois DNS에 TXT 레코드 추가 완료
- [ ] DKIM 인증 완료 (Verified)
- [ ] Supabase SMTP 설정 완료
- [ ] 이메일 템플릿 URL 수정 완료

---

# Part B - 심화

> Claude Code 참조용 기술 문서

**전제조건**: Part A 완료 (Resend 설정, DKIM 인증, Supabase SMTP 연동)

---

## 1. 환경변수 설정

```bash
# Supabase
SUPABASE_URL=https://[프로젝트ID].supabase.co
SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...

# Resend
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Site URL
NEXT_PUBLIC_SITE_URL=https://www.ssalworks.ai.kr
```

---

## 2. 전체 흐름

> 2026-01-20 업데이트: verify-email.html 및 subscription_status 추가

```
사용자 (회원가입)
    ↓
Supabase Auth (auth.users 생성)
    ↓
users 테이블 (subscription_status: 'inactive')
    ↓ SMTP 요청
Resend (SMTP)
    ↓ DKIM 검증
DNS (Whois)
    ↓
사용자 이메일 수신
    ↓ 링크 클릭
verify-email.html (토큰 검증)
    ↓
subscription_status: 'free'로 변경
    ↓
로그인 페이지로 이동
    ↓
로그인 완료
```

**핵심 변경 (2026-01-20):**
- 회원가입 시 `subscription_status: 'inactive'` 설정
- 이메일 인증 완료 후 `subscription_status: 'free'`로 변경
- 로그인 시 `inactive` 상태면 로그인 차단

---

## 3. auth.users ↔ users 동기화

### 3.1 문제

이메일 인증 완료 후 로그인 실패:
- `auth.users`에는 존재
- `users` 테이블에는 없음

### 3.2 회원가입 API에서 동기화

```javascript
// 회원가입 API
export async function POST(request) {
  const { email, password, nickname } = await request.json();

  // 1. Supabase Auth에 사용자 생성
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: { name: nickname },
      emailRedirectTo: 'https://www.ssalworks.ai.kr/auth/callback',
    },
  });

  if (authError) {
    return Response.json({ error: authError.message }, { status: 400 });
  }

  // 2. users 테이블에 프로필 생성
  const { error: profileError } = await supabaseAdmin
    .from('users')
    .insert({
      user_id: authData.user.id,
      email,
      nickname,
      role: 'user',
      is_active: true,
    });

  // 3. 실패 시 롤백
  if (profileError) {
    await supabaseAdmin.auth.admin.deleteUser(authData.user.id);
    return Response.json({ error: '회원가입 실패' }, { status: 500 });
  }

  return Response.json({ success: true });
}
```

---

## 4. 트러블슈팅

### 문제 1: 이메일 링크가 잘못된 도메인

**증상**: `https://ssalworks.ai.kr/...` (www 없음)

**해결**: 템플릿에서 URL 하드코딩
```html
<a href="https://www.ssalworks.ai.kr/auth/callback?token_hash={{ .TokenHash }}&type=signup">
```

### 문제 2: 이메일이 스팸으로 분류

**해결**: DKIM 인증 완료 확인 (Resend Dashboard → Verified)

### 문제 3: 인증 후 로그인 실패

**해결**: `users` 테이블 동기화 확인 (위 3.2 참조)

### 문제 4: RESEND_API_KEY not set

**해결**:
1. `.env.local` 파일 확인
2. 키 복사 시 공백 확인
3. 개발 서버 재시작

---

## 5. 템플릿 변수 비교

| 변수 | 동작 | 권장 |
|------|------|------|
| `{{ .SiteURL }}` | Dashboard 설정값 | ❌ |
| `{{ .ConfirmationURL }}` | 자동 생성 | △ |
| `{{ .RedirectTo }}` | emailRedirectTo 값 | △ |
| **하드코딩** | 직접 입력 | ✅ 가장 확실 |

---

## 참고 문서

- [Supabase SMTP Configuration](https://supabase.com/docs/guides/auth/auth-smtp)
- [Supabase Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Resend Documentation](https://resend.com/docs)
