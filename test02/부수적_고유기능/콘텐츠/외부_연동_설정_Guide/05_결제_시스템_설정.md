# 결제 시스템 설정 가이드

> 토스페이먼츠 연동

---

# Part A - 기초

> PO(Project Owner; 사람)가 직접 해야 할 설정

---

## Step 1: 토스페이먼츠 가입

1. https://developers.tosspayments.com 접속
2. 회원가입
3. 개발자센터 로그인

---

## Step 2: 가맹점 신청

1. 가맹점 심사 신청
2. 필요 서류:

| 서류 | 비고 |
|------|------|
| 사업자등록증 | 필수 |
| 대표자 신분증 | 필수 |
| 통장 사본 | 필수 |
| 서비스 URL | 필수 |

3. 심사 완료 대기 (1-2주 소요)

> **참고**: 테스트 키는 가입 즉시 발급되므로, 심사 완료 전에도 개발/테스트 가능

---

## Step 3: API 키 확인

1. 개발자센터 → **내 개발정보** → **API 키**
2. 아래 키 복사:

**테스트 키** (심사 전 개발용):

| 항목 | 형식 |
|------|------|
| 클라이언트 키 | `test_ck_xxxxxxxxxxxxxxxx` |
| 시크릿 키 | `test_sk_xxxxxxxxxxxxxxxx` |

**라이브 키** (심사 완료 후):

| 항목 | 형식 |
|------|------|
| 클라이언트 키 | `live_ck_xxxxxxxxxxxxxxxx` |
| 시크릿 키 | `live_sk_xxxxxxxxxxxxxxxx` |

---

## Step 4: 환경변수 설정

1. Vercel → **Settings** → **Environment Variables**
2. 아래 환경변수 추가:

### 테스트 환경 (Preview, Development)

| Key | Value | 용도 |
|-----|-------|------|
| `TOSS_CLIENT_KEY` | `test_ck_xxx...` | 서버용 |
| `TOSS_SECRET_KEY` | `test_sk_xxx...` | 서버용 |
| `VITE_TOSS_CLIENT_KEY` | `test_ck_xxx...` | 프론트엔드용 |

### 프로덕션 환경 (Production)

| Key | Value | 용도 |
|-----|-------|------|
| `TOSS_CLIENT_KEY` | `live_ck_xxx...` | 서버용 |
| `TOSS_SECRET_KEY` | `live_sk_xxx...` | 서버용 |
| `VITE_TOSS_CLIENT_KEY` | `live_ck_xxx...` | 프론트엔드용 |

> **중요**: `VITE_` 접두사가 있어야 프론트엔드 코드에서 접근 가능

---

## Step 5: 웹훅 URL 등록

1. 개발자센터 → **웹훅 설정**
2. 웹훅 URL 입력:
   ```
   https://www.ssalworks.ai.kr/api/webhook/toss
   ```

3. **구독할 이벤트 선택** (아래 2개 필수 체크):

| 이벤트 | 용도 |
|--------|------|
| `PAYMENT_STATUS_CHANGED` | 결제 상태 변경 알림 |
| `BILLING_STATUS_CHANGED` | 빌링키 상태 변경 알림 |

4. 웹훅 시크릿 키 복사 → Vercel 환경변수에 추가:

| Key | Value |
|-----|-------|
| `TOSS_WEBHOOK_SECRET` | 웹훅 설정에서 발급된 시크릿 |

---

## Step 6: 테스트 결제 확인

테스트 환경에서 아래 카드 정보로 테스트:

### 테스트 카드 정보

| 항목 | 값 |
|------|-----|
| 카드번호 | `4330000000000000` |
| 유효기간 | `12/30` (미래 날짜 아무거나) |
| CVC | `123` |
| 비밀번호 앞 2자리 | `12` |

### 테스트 시나리오

| 카드번호 | 결과 |
|----------|------|
| `4330000000000000` | 성공 |
| `4330000000000001` | 실패 (잔액부족) |
| `4330000000000002` | 실패 (카드분실) |

---

## 체크리스트

- [ ] 토스페이먼츠 개발자센터 가입 완료
- [ ] 테스트 API 키 확인 완료
- [ ] Vercel 환경변수 설정 완료 (3개: `TOSS_CLIENT_KEY`, `TOSS_SECRET_KEY`, `VITE_TOSS_CLIENT_KEY`)
- [ ] 웹훅 URL 등록 완료
- [ ] 웹훅 이벤트 2개 선택 완료 (`PAYMENT_STATUS_CHANGED`, `BILLING_STATUS_CHANGED`)
- [ ] 웹훅 시크릿 환경변수 추가 완료 (`TOSS_WEBHOOK_SECRET`)
- [ ] 테스트 결제 성공 확인
- [ ] 가맹점 심사 신청 완료
- [ ] (심사 완료 후) 라이브 키로 환경변수 교체 완료

---

# Part B - 심화

> Claude Code 참조용 기술 문서

**전제조건**: Part A 완료 (토스페이먼츠 가입, API 키 확보)

---

## 1. 전체 흐름 (크레딧 충전)

```
사용자
    ↓ 크레딧 충전 요청
SSALWorks 앱 (credit-purchase.html)
    ↓ 결제 위젯 렌더링
토스페이먼츠 결제 위젯
    ↓ 카드 정보 입력 + 결제 요청
토스페이먼츠
    ↓ 결제 완료 → successUrl 리다이렉트
SSALWorks (credit-success.html)
    ↓ 결제 승인 API 호출
SSALWorks API (/api/payment/confirm)
    ↓ 크레딧 추가
Supabase (credit_history, users.credit_balance)
```

---

## 2. 결제 위젯 연동

### 2.1 SDK 로드

```html
<script src="https://js.tosspayments.com/v2/standard"></script>
```

### 2.2 결제 위젯 초기화 및 렌더링

```javascript
// 클라이언트 키 로드
const clientKey = import.meta.env.VITE_TOSS_CLIENT_KEY || 'test_ck_xxx';

// 결제 위젯 초기화
const paymentWidget = TossPayments(clientKey);

// 결제 수단 위젯 렌더링
await paymentWidget.renderPaymentMethods(
    '#payment-widget',           // 컨테이너 selector
    { value: 10000 },            // 결제 금액
    { variantKey: 'DEFAULT' }    // 위젯 스타일
);

// 약관 동의 위젯 렌더링
await paymentWidget.renderAgreement('#agreement');
```

### 2.3 결제 요청

```javascript
async function handlePayment() {
    const orderId = `credit_${userId}_${Date.now()}`;

    await paymentWidget.requestPayment({
        orderId: orderId,
        orderName: 'SSAL 크레딧 충전 - Basic',
        customerName: '홍길동',
        customerEmail: 'user@example.com',
        successUrl: `${window.location.origin}/pages/subscription/credit-success.html`,
        failUrl: `${window.location.origin}/pages/subscription/credit-purchase.html?error=payment_failed`
    });
}
```

---

## 3. 결제 승인 (서버)

```javascript
// /api/payment/confirm
export default async function handler(req, res) {
    const { paymentKey, orderId, amount } = req.body;

    // 토스 API로 결제 승인
    const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
        method: 'POST',
        headers: {
            'Authorization': `Basic ${Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64')}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ paymentKey, orderId, amount }),
    });

    const paymentResult = await response.json();

    if (paymentResult.status === 'DONE') {
        // 크레딧 추가 로직
        await addCreditsToUser(userId, amount);
    }

    return res.json(paymentResult);
}
```

---

## 4. 웹훅 엔드포인트

### 4.1 서명 검증 (보안 필수)

```javascript
// /api/webhook/toss
import crypto from 'crypto';

function verifyWebhookSignature(payload, signature) {
    const secret = process.env.TOSS_WEBHOOK_SECRET;
    const expectedSignature = crypto
        .createHmac('sha256', secret)
        .update(JSON.stringify(payload))
        .digest('base64');

    return signature === expectedSignature;
}

export default async function handler(req, res) {
    // 1. 서명 검증
    const signature = req.headers['toss-signature'];
    if (!signature || !verifyWebhookSignature(req.body, signature)) {
        return res.status(401).json({ error: 'Invalid signature' });
    }

    // 2. 이벤트 처리
    const { eventType, data } = req.body;

    switch (eventType) {
        case 'PAYMENT_STATUS_CHANGED':
            await handlePaymentStatusChanged(data);
            break;

        case 'BILLING_STATUS_CHANGED':
            await handleBillingStatusChanged(data);
            break;
    }

    return res.status(200).json({ success: true });
}
```

### 4.2 결제 상태 변경 처리

```javascript
async function handlePaymentStatusChanged(data) {
    const { orderId, status, customerKey } = data;

    if (status === 'DONE') {
        // 결제 완료 처리
        await supabase.from('credit_history').insert({
            user_id: customerKey,
            order_id: orderId,
            status: 'completed',
            created_at: new Date()
        });
    } else if (status === 'CANCELED') {
        // 결제 취소 처리
        await supabase.from('credit_history')
            .update({ status: 'canceled' })
            .eq('order_id', orderId);
    }
}
```

---

## 5. 빌링키 (정기결제용)

> 월 구독 결제에 사용

### 5.1 빌링키 발급 요청

```javascript
const tossPayments = TossPayments('test_ck_xxxxxxxxxxxxxxxx');

async function requestBillingKey() {
    await tossPayments.requestBillingAuth('카드', {
        customerKey: 'user_uuid_here',
        successUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/success',
        failUrl: 'https://www.ssalworks.ai.kr/api/payment/billing/fail',
    });
}
```

### 5.2 빌링키 저장 (서버)

```javascript
// /api/payment/billing/success
export async function GET(request) {
    const { authKey, customerKey } = request.query;

    // 토스 API로 빌링키 발급 확정
    const response = await fetch('https://api.tosspayments.com/v1/billing/authorizations/issue', {
        method: 'POST',
        headers: {
            'Authorization': `Basic ${Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64')}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ authKey, customerKey }),
    });

    const { billingKey, card } = await response.json();

    // Supabase에 빌링키 저장
    await supabase.from('payment_methods').insert({
        user_id: customerKey,
        billing_key: billingKey,
        card_company: card.company,
        card_number_masked: card.number,
    });
}
```

### 5.3 정기결제 실행

```javascript
async function executeSubscriptionPayment(userId, billingKey, amount) {
    const response = await fetch('https://api.tosspayments.com/v1/billing/' + billingKey, {
        method: 'POST',
        headers: {
            'Authorization': `Basic ${Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64')}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            customerKey: userId,
            amount: amount,
            orderId: `subscription_${Date.now()}`,
            orderName: 'SSALWorks 월 구독',
        }),
    });

    return response.json();
}
```

---

## 6. PG 약관 동의 UI (법적 필수)

```html
<div class="payment-terms">
    <label>
        <input type="checkbox" required>
        [필수] 전자금융거래 이용약관
    </label>

    <label>
        <input type="checkbox" required>
        [필수] 개인정보 제3자 제공 동의 (토스페이먼츠)
    </label>

    <label>
        <input type="checkbox" required>
        [필수] 결제대행 서비스 이용약관
    </label>
</div>
```

> **참고**: 토스 결제 위젯 사용 시 `renderAgreement()`로 약관 동의 UI가 자동 렌더링됨

---

## 7. 키 용도 구분

| 키 종류 | 용도 | 노출 가능 | 환경변수 |
|---------|------|----------|----------|
| 클라이언트 키 | 프론트엔드 SDK | ✅ | `VITE_TOSS_CLIENT_KEY` |
| 시크릿 키 | 서버 API 호출 | ❌ | `TOSS_SECRET_KEY` |
| 웹훅 시크릿 | 웹훅 서명 검증 | ❌ | `TOSS_WEBHOOK_SECRET` |

---

## 8. 에러 처리

### 일반적인 에러 코드

| 코드 | 의미 | 대응 |
|------|------|------|
| `INVALID_CARD_NUMBER` | 잘못된 카드번호 | 사용자에게 재입력 요청 |
| `EXCEED_MAX_AMOUNT` | 한도 초과 | 다른 카드 사용 안내 |
| `INVALID_STOPPED_CARD` | 정지된 카드 | 카드사 문의 안내 |
| `NOT_ALLOWED_POINT_USE` | 포인트 사용 불가 | 다른 결제 수단 안내 |

### 에러 처리 예시

```javascript
try {
    await paymentWidget.requestPayment({ ... });
} catch (error) {
    if (error.code === 'USER_CANCEL') {
        // 사용자가 결제 취소
        showMessage('결제가 취소되었습니다.');
    } else {
        // 기타 에러
        showMessage(`결제 오류: ${error.message}`);
    }
}
```

---

## 참고 문서

- [토스페이먼츠 개발자 문서](https://docs.tosspayments.com/)
- [결제 위젯 가이드](https://docs.tosspayments.com/guides/payment-widget)
- [빌링키 발급 가이드](https://docs.tosspayments.com/guides/billing)
- [결제 웹훅 가이드](https://docs.tosspayments.com/guides/webhook)
- [테스트 카드 정보](https://docs.tosspayments.com/reference/test-card)
