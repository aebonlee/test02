# 데이터베이스 설정 가이드

> Supabase Database + RLS 정책 설정

---

# Part A - 기초

> PO(Project Owner; 사람)가 직접 해야 할 설정

---

## Step 1: Supabase 계정 만들기

1. https://supabase.com 접속
2. **"Start your project"** 클릭
3. **"Continue with GitHub"** 클릭하여 로그인

---

## Step 2: 프로젝트 만들기

1. **"New Project"** 클릭
2. 아래 정보 입력:

| 항목 | 입력 |
|------|------|
| Name | ssalworks |
| Database Password | 강력한 비밀번호 (메모 필수) |
| Region | Northeast Asia (Seoul) |

3. **"Create new project"** 클릭

---

## Step 3: API 키 복사

1. 왼쪽 메뉴 → **톱니바퀴 (Project Settings)** → **API**
2. 아래 3가지를 메모장에 복사:

| 항목 | 용도 |
|------|------|
| Project URL | 프로젝트 주소 |
| anon public | 브라우저에서 사용 |
| service_role | 서버에서만 사용 (노출 금지) |

---

## 체크리스트

- [ ] Supabase 로그인 완료
- [ ] 프로젝트 생성 완료
- [ ] Database Password 메모 완료
- [ ] Project URL 복사 완료
- [ ] anon public key 복사 완료
- [ ] service_role key 복사 완료

---

# Part B - 심화

> Claude Code 참조용 기술 문서

**전제조건**: Part A 완료 (프로젝트 생성, API 키 확보)

---

## 1. 환경변수 설정

### 1.1 필요한 환경변수

```bash
SUPABASE_URL=https://[프로젝트ID].supabase.co
SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...
```

### 1.2 Vercel 환경변수 등록

```
Vercel Dashboard → Project → Settings → Environment Variables

| Key                       | Environment |
|---------------------------|-------------|
| SUPABASE_URL              | All         |
| SUPABASE_ANON_KEY         | All         |
| SUPABASE_SERVICE_ROLE_KEY | All         |
```

### 1.3 API 키 사용 구분

```javascript
// 브라우저용 (anon key)
const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// 서버용 (service_role key, RLS 우회)
const supabaseAdmin = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_SERVICE_ROLE_KEY
);
```

---

## 2. 테이블 생성

### 2.1 SQL Editor 접근

```
Supabase Dashboard → SQL Editor → New query
```

### 2.2 users 테이블

```sql
CREATE TABLE users (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  nickname TEXT,
  name TEXT,
  role TEXT DEFAULT 'user',
  is_active BOOLEAN DEFAULT true,
  subscription_status TEXT DEFAULT 'none',
  terms_agreed BOOLEAN DEFAULT false,
  privacy_agreed BOOLEAN DEFAULT false,
  marketing_agreed BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE users ENABLE ROW LEVEL SECURITY;
```

### 2.3 notices 테이블

```sql
CREATE TABLE notices (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT,
  important BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE notices ENABLE ROW LEVEL SECURITY;
```

### 2.4 user_payment_methods 테이블

```sql
CREATE TABLE user_payment_methods (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
  billing_key TEXT NOT NULL,
  card_company TEXT,
  card_number_masked TEXT,
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE user_payment_methods ENABLE ROW LEVEL SECURITY;
```

---

## 3. RLS 정책

### 3.1 Role 구분

| Role | 설명 |
|------|------|
| `public` | 모든 사용자 |
| `anon` | 익명 사용자 |
| `authenticated` | 로그인한 사용자 |

### 3.2 users 테이블 RLS

```sql
-- 본인 데이터만 조회
CREATE POLICY "Users can view own data"
ON users FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

-- 본인 데이터만 수정
CREATE POLICY "Users can update own data"
ON users FOR UPDATE
TO authenticated
USING (auth.uid() = user_id);

-- 회원가입 시 프로필 생성
CREATE POLICY "Users can insert own profile"
ON users FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user_id);
```

### 3.3 notices 테이블 RLS

```sql
-- 모든 사용자 읽기 허용
CREATE POLICY "Anyone can read notices"
ON notices FOR SELECT
TO public
USING (true);

-- 인증된 사용자만 쓰기
CREATE POLICY "Authenticated users can insert"
ON notices FOR INSERT
TO authenticated
WITH CHECK (true);
```

---

## 4. 트러블슈팅

### 문제 1: 빈 결과 반환

**증상**: 데이터가 있는데 빈 배열

**해결**:
```sql
SELECT * FROM pg_policies WHERE tablename = '테이블명';
```

### 문제 2: 권한 오류 (403/401)

**해결**: 서버에서는 `service_role key` 사용

### 문제 3: API 키 오류

**해결**: 키 복사 시 공백 확인, anon vs service_role 구분

### 문제 4: Foreign Key 오류

**해결**: 참조 테이블에 데이터 먼저 생성

---

## 5. 유용한 쿼리

```sql
-- 테이블 목록
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public';

-- RLS 상태 확인
SELECT tablename, rowsecurity FROM pg_tables
WHERE schemaname = 'public';

-- 정책 목록
SELECT schemaname, tablename, policyname, cmd, roles
FROM pg_policies
WHERE schemaname = 'public';
```

---

## 참고 문서

- [Supabase 공식 문서](https://supabase.com/docs)
- [RLS 가이드](https://supabase.com/docs/guides/auth/row-level-security)
