# User Flow #3: 플랫폼 이용료 납부 및 관리

> **최종 수정:** 2025-12-25
> **버전:** 1.1 (3개월 무료 반영)

---

## 1. 플로우 개요

**목적:** 설치비 납부 후 매월 발생하는 플랫폼 이용료를 관리한다.

**전제 조건:**
- 설치비 납부 완료 (installation_fee_paid = true)
- 프로젝트 등록 완료

**시작:** 설치비 납부 1개월 후 자동 시작
**종료:** 플랫폼 이용료 납부 완료 또는 구독 해지
**주기:** 매월

---

## 2. 플랫폼 이용료 체계

### 가격
- **월 이용료:** ₩50,000/월
- **1~3개월:** 무료 (설치비 납부 시 3개월 무료 제공)
- **결제일:** 설치비 납부일 기준 매월 동일 날짜
- **결제 방법:** 자동이체 (계좌이체 또는 카드 자동결제)

### 예시
```
설치비 납부일: 2025-12-01
1~3개월 무료: 2025-12-01 ~ 2026-02-28
첫 이용료 결제일: 2026-03-01 (₩50,000)
이후 매월 1일 자동결제
```

---

## 3. 정상 플로우 (Normal Flow)

### Step 1: 결제 수단 등록 (설치비 납부 직후)

**시점:** 프로젝트 등록 완료 후

**페이지:** `/subscription/payment-method`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💳 결제 수단 등록

플랫폼 이용료 자동결제를 위해
결제 수단을 등록해주세요.

1~3개월은 무료입니다!
다음 결제일: 2026-04-01

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

결제 수단 선택:

○ 계좌 자동이체
  - 은행 선택
  - 계좌번호 입력
  - 예금주 확인

○ 신용/체크카드 자동결제
  - 카드번호 입력
  - 유효기간 입력
  - CVC 입력
  - 카드 소유자명 입력

[등록하기] [나중에]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**API:** `POST /api/subscription/payment-method`

**Request:**
```json
{
  "user_id": "A3B5C7D9",
  "payment_type": "card",
  "card_number": "****-****-****-1234",
  "expiry": "12/28",
  "owner_name": "김써니"
}
```

**Response:**
```json
{
  "success": true,
  "payment_method_id": "PM-A3B5C7D9-001",
  "next_billing_date": "2026-01-01",
  "message": "결제 수단이 등록되었습니다"
}
```

---

### Step 2: 결제일 도래 알림 (매월 3일 전)

**시점:** 결제일 3일 전 (예: 12월 29일)

**알림 방식:** 플랫폼 알림 + 이메일

**플랫폼 알림:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💳 플랫폼 이용료 결제 예정

결제일: 2026-01-01
결제 금액: ₩50,000
결제 수단: 신한카드 ****-1234

잔액을 확인해주세요.

[결제 수단 변경] [확인]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Step 3: 자동결제 실행 (매월 결제일)

**시점:** 매월 결제일 00:00 (서버 시간 기준)

**서버 프로세스:**

1. **결제 대상 조회**
```sql
SELECT * FROM users
WHERE installation_fee_paid = true
  AND subscription_status = 'active'
  AND DATE(platform_fee_start_date) + INTERVAL '1 month' <= NOW();
```

2. **자동결제 시도**
- 등록된 결제 수단으로 ₩50,000 결제
- PG사 API 호출

3. **결제 성공 시**

**DB 업데이트:**
```sql
INSERT INTO billing_history (
  id, user_id, billing_type, amount, status, billing_date
) VALUES (
  'uuid', 'A3B5C7D9', 'platform_fee', 50000, 'paid', NOW()
);

UPDATE users SET
  last_billing_date = NOW(),
  platform_fee_start_date = platform_fee_start_date + INTERVAL '1 month'
WHERE user_id = 'A3B5C7D9';
```

**사용자 알림:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 플랫폼 이용료 결제 완료

결제일: 2026-01-01
결제 금액: ₩50,000
결제 수단: 신한카드 ****-1234

다음 결제일: 2026-02-01

[영수증 보기]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Step 4: 결제 내역 조회

**페이지:** `/subscription/billing-history`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💳 플랫폼 이용료 결제 내역

현재 구독 상태: 활성
다음 결제일: 2026-03-01
월 이용료: ₩50,000

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

결제 내역:

2026-02-01  ✅ 결제 완료  ₩50,000  [영수증]
2026-01-01  ✅ 결제 완료  ₩50,000  [영수증]
2025-12-01  🎁 무료 (1~3개월)  ₩0

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[결제 수단 변경] [구독 일시정지] [구독 해지]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 4. 예외 플로우 (Exception Flows)

### 4-1. 결제 실패

**원인:**
- 잔액 부족
- 카드 한도 초과
- 카드 정지/만료
- 계좌 정지

**시스템 동작:**

1. **1차 시도 실패 (결제일 당일)**
   - 재시도: 당일 오후 6시

2. **2차 시도 실패**
   - 재시도: 다음날 오전 9시
   - 사용자 알림 발송

**사용자 알림:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 플랫폼 이용료 결제 실패

결제 시도일: 2026-01-01
실패 사유: 잔액 부족

다시 결제를 시도합니다:
- 오늘 오후 6시
- 내일 오전 9시

48시간 내 결제되지 않으면
서비스가 일시정지됩니다.

[수동 결제하기] [결제 수단 변경]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

3. **3차 시도 실패 (결제일 +2일)**
   - **서비스 일시정지**
   - Order Sheet 작성 불가
   - 진행 중인 프로젝트 읽기 전용

**DB 업데이트:**
```sql
UPDATE users SET
  subscription_status = 'suspended',
  suspended_at = NOW(),
  suspended_reason = 'payment_failed'
WHERE user_id = 'A3B5C7D9';

INSERT INTO billing_history (
  user_id, billing_type, amount, status, billing_date
) VALUES (
  'A3B5C7D9', 'platform_fee', 50000, 'failed', NOW()
);
```

**사용자 알림:**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚫 서비스 일시정지

결제 실패로 인해 서비스가 일시정지되었습니다.

제한 사항:
- ❌ Order Sheet 작성 불가
- ❌ Claude Code 연동 불가
- ✅ 프로젝트 조회는 가능

미납금: ₩50,000

결제하시면 즉시 서비스가 재개됩니다.

[지금 결제하기]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 4-2. 수동 결제

**페이지:** `/subscription/manual-payment`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💳 수동 결제

미납 금액: ₩50,000
결제 대상: 2026년 1월분 플랫폼 이용료

결제 수단:
○ 등록된 카드로 결제 (신한카드 ****-1234)
○ 다른 결제 수단 사용

[결제하기]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**결제 완료 시:**
- 서비스 즉시 재개
- subscription_status → 'active'

---

### 4-3. 구독 일시정지 (사용자 요청)

**조건:**
- 미납금 없음
- 진행 중인 프로젝트 완료

**페이지:** `/subscription/pause`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏸️ 구독 일시정지

구독을 일시정지하면:
- ❌ 새 프로젝트 등록 불가
- ❌ Order Sheet 작성 불가
- ✅ 기존 프로젝트 조회 가능
- ✅ Books, FAQ는 계속 이용 가능

플랫폼 이용료:
- 일시정지 기간 동안 청구되지 않음

재개는 언제든지 가능합니다.

일시정지 사유: [선택]
- 프로젝트 완료
- 일시적 휴식
- 재정적 사유
- 기타

[일시정지하기] [취소]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**DB 업데이트:**
```sql
UPDATE users SET
  subscription_status = 'paused',
  paused_at = NOW(),
  pause_reason = 'user_request'
WHERE user_id = 'A3B5C7D9';
```

---

### 4-4. 구독 해지

**조건:**
- 미납금 없음

**페이지:** `/subscription/cancel`

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚫 구독 해지

정말 구독을 해지하시겠습니까?

해지 시:
- ❌ 모든 프로젝트 접근 불가
- ❌ Order Sheet 작성 불가
- ❌ 진행 중인 작업 손실 가능
- ✅ Books, FAQ는 계속 이용 가능

환불:
- 설치비는 환불되지 않습니다
- 이번 달 이용료는 일할 계산 환불

⚠️ 재가입 시 설치비를 다시 납부해야 합니다.

해지 사유: [필수]
- 서비스 불만족
- 비용 부담
- 프로젝트 완료
- 기타

[해지하기] [취소]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**DB 업데이트:**
```sql
UPDATE users SET
  subscription_status = 'cancelled',
  cancelled_at = NOW(),
  cancel_reason = 'user_request'
WHERE user_id = 'A3B5C7D9';
```

---

## 5. 구독 상태 관리

### 구독 상태 종류

| 상태 | 코드 | 설명 |
|------|------|------|
| 활성 | active | 정상 이용 중 |
| 일시정지 (결제 실패) | suspended | 결제 실패로 정지 |
| 일시정지 (사용자) | paused | 사용자 요청으로 정지 |
| 해지 | cancelled | 구독 해지 |
| 무료 기간 | free_trial | 1~3개월 무료 기간 |

---

## 6. 데이터 플로우

### billing_history 테이블

```json
{
  "id": "uuid",
  "user_id": "A3B5C7D9",
  "billing_type": "platform_fee",
  "amount": 50000,
  "status": "paid",
  "billing_date": "2026-01-01T00:00:00Z",
  "payment_method": "card_****1234",
  "receipt_url": "https://..."
}
```

> **⚠️ 구현 시점:** S1. 프로토타입 제작 단계에서 실제 DB 테이블 생성
> **참조:** `P3_프로토타입_제작/Database/` 폴더

---

## 7. 성공 기준

### 7-1. 기능적 성공
- ✅ 결제 수단 등록 가능
- ✅ 매월 자동결제 정상 작동
- ✅ 결제 실패 시 재시도 및 알림
- ✅ 수동 결제 가능
- ✅ 구독 일시정지/해지 가능

### 7-2. UX 성공
- ✅ 결제일 사전 알림
- ✅ 결제 실패 시 명확한 안내
- ✅ 결제 내역 투명하게 조회 가능

### 7-3. 비즈니스 성공
- ✅ 자동결제 성공률 95% 이상
- ✅ 결제 실패 시 48시간 내 복구율 80% 이상
- ✅ 구독 해지율 10% 미만

---

**문서 작성:** Claude Code
**승인:** 2025-12-02
