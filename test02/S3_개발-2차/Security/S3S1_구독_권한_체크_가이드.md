# S3S1: êµ¬ë… ê¶Œí•œ ì²´í¬ ì‹œìŠ¤í…œ

**Task ID**: S3S1
**ì‘ì„±ì¼**: 2025-12-18
**Stage**: S3 (ê°œë°œ 2ì°¨)
**Area**: Security

---

## ğŸ“‹ ê°œìš”

AI ê¸°ëŠ¥ ì ‘ê·¼ì„ ìœ„í•œ êµ¬ë… ë“±ê¸‰ë³„ ê¶Œí•œ ì²´í¬ ë¯¸ë“¤ì›¨ì–´ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ğŸ“ êµ¬í˜„ íŒŒì¼

| íŒŒì¼ | ê²½ë¡œ | ìš©ë„ | ë¼ì¸ ìˆ˜ |
|------|------|------|---------|
| check-permission.js | `lib/subscription/` | ê¶Œí•œ ì²´í¬ ë¡œì§ | 213 |
| withSubscription.js | `lib/subscription/` | API ë˜í¼ í•¨ìˆ˜ | 172 |
| subscription-check.js | `api/` | ê¶Œí•œ í™•ì¸ API | 110 |

**ì´ ë¼ì¸ ìˆ˜**: 495

---

## ğŸ¯ ê¸°ëŠ¥ë³„ í•„ìš” êµ¬ë… í”Œëœ

```javascript
const FEATURE_REQUIREMENTS = {
  'ai-qa': ['basic', 'premium'],          // AI Q&A ê¸°ë³¸ ê¸°ëŠ¥
  'ai-advanced': ['premium'],             // AI ê³ ê¸‰ ê¸°ëŠ¥ (Premiumë§Œ)
  'premium-content': ['basic', 'premium'], // í”„ë¦¬ë¯¸ì—„ ì½˜í…ì¸ 
  'unlimited-api': ['premium']            // ë¬´ì œí•œ API í˜¸ì¶œ (Premiumë§Œ)
};
```

---

## ğŸ”§ ì‚¬ìš© ë°©ë²•

### 1. í•„ìˆ˜ êµ¬ë… ê¶Œí•œ ì²´í¬ (API ë³´í˜¸)

**ì˜ˆì‹œ: AI Q&A API ë³´í˜¸**

```javascript
// api/ai/qa.js
const { withSubscription } = require('../../S3_ê°œë°œ-2ì°¨/Security/lib/subscription/withSubscription');

module.exports = withSubscription('ai-qa')(async (req, res) => {
  const { user, subscription } = req;

  // ì´ ì½”ë“œëŠ” ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ì‹¤í–‰ë¨
  // user: ì‚¬ìš©ì ì •ë³´
  // subscription: êµ¬ë… ì •ë³´ (plan, status ë“±)

  res.json({
    success: true,
    message: 'AI Q&A response',
    plan: subscription.plan
  });
});
```

**ì˜ˆì‹œ: AI ê³ ê¸‰ ê¸°ëŠ¥ ë³´í˜¸ (Premiumë§Œ)**

```javascript
// api/ai/advanced.js
const { withSubscription } = require('../../S3_ê°œë°œ-2ì°¨/Security/lib/subscription/withSubscription');

module.exports = withSubscription('ai-advanced')(async (req, res) => {
  const { user, subscription } = req;

  // Premium ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
  res.json({
    success: true,
    message: 'Advanced AI feature',
    plan: subscription.plan  // 'premium'ë§Œ ê°€ëŠ¥
  });
});
```

---

### 2. ì„ íƒì  ê¶Œí•œ ì²´í¬ (ë¬´ë£Œ ì‚¬ìš©ìë„ ì œí•œì  ì ‘ê·¼)

**ì˜ˆì‹œ: ë¬´ë£Œ ì‚¬ìš©ìëŠ” 5íšŒ/ì¼, ìœ ë£Œ ì‚¬ìš©ìëŠ” ë¬´ì œí•œ**

```javascript
// api/ai/qa-limited.js
const { withOptionalSubscription } = require('../../S3_ê°œë°œ-2ì°¨/Security/lib/subscription/withSubscription');

module.exports = withOptionalSubscription('ai-qa')(async (req, res) => {
  const { user, subscription } = req;

  if (subscription) {
    // ìœ ë£Œ ì‚¬ìš©ì: ë¬´ì œí•œ ì‚¬ìš©
    return res.json({
      success: true,
      unlimited: true,
      data: fullData
    });
  } else {
    // ë¬´ë£Œ ì‚¬ìš©ì: ì œí•œì  ì‚¬ìš© (5íšŒ/ì¼)
    const dailyLimit = await checkDailyLimit(user.id);

    if (dailyLimit.exceeded) {
      return res.status(429).json({
        success: false,
        error: {
          code: 'RATE_LIMIT_EXCEEDED',
          message: 'Daily limit exceeded. Upgrade to Premium for unlimited access.'
        }
      });
    }

    return res.json({
      success: true,
      unlimited: false,
      remaining: dailyLimit.remaining,
      data: limitedData
    });
  }
});
```

---

### 3. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê¶Œí•œ ì²´í¬

**íŠ¹ì • ê¸°ëŠ¥ ê¶Œí•œ í™•ì¸**

```javascript
// Frontend JavaScript
async function checkAIQAAccess() {
  const token = localStorage.getItem('access_token');

  const response = await fetch('/api/subscription/check?feature=ai-qa', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  const data = await response.json();

  if (data.hasAccess) {
    // AI Q&A ê¸°ëŠ¥ í™œì„±í™”
    enableAIQA();
  } else {
    // ì—…ê·¸ë ˆì´ë“œ ìš”ì²­
    showUpgradeModal(data.error.requiredPlans);
  }
}
```

**ì „ì²´ ê¶Œí•œ ì¡°íšŒ**

```javascript
// Frontend JavaScript
async function loadUserPermissions() {
  const token = localStorage.getItem('access_token');

  const response = await fetch('/api/subscription/check', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  const data = await response.json();

  // data.permissions = {
  //   plan: 'basic',
  //   subscription_id: 'xxx',
  //   'ai-qa': true,
  //   'ai-advanced': false,
  //   'premium-content': true,
  //   'unlimited-api': false
  // }

  updateUIBasedOnPermissions(data.permissions);
}
```

---

## ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸

### GET /api/subscription/check

**ê¸°ëŠ¥**: ì‚¬ìš©ìì˜ êµ¬ë… ê¶Œí•œ í™•ì¸

**ì¸ì¦**: Bearer Token í•„ìˆ˜

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**:
- `feature` (ì˜µì…˜): ì²´í¬í•  ê¸°ëŠ¥ (ì˜ˆ: `ai-qa`, `ai-advanced`)
  - ìˆìœ¼ë©´: íŠ¹ì • ê¸°ëŠ¥ ê¶Œí•œë§Œ ì²´í¬
  - ì—†ìœ¼ë©´: ì „ì²´ ê¶Œí•œ ë°˜í™˜

**ì‘ë‹µ ì˜ˆì‹œ**:

**1) íŠ¹ì • ê¸°ëŠ¥ ì²´í¬ (ê¶Œí•œ ìˆìŒ)**
```json
GET /api/subscription/check?feature=ai-qa

{
  "success": true,
  "hasAccess": true,
  "feature": "ai-qa",
  "subscription": {
    "id": "sub_123",
    "plan": "basic",
    "status": "active",
    "start_date": "2025-01-01",
    "end_date": "2025-02-01"
  }
}
```

**2) íŠ¹ì • ê¸°ëŠ¥ ì²´í¬ (ê¶Œí•œ ì—†ìŒ)**
```json
GET /api/subscription/check?feature=ai-advanced

{
  "success": false,
  "hasAccess": false,
  "feature": "ai-advanced",
  "error": {
    "code": "INSUFFICIENT_PLAN",
    "message": "Your plan (basic) does not have access to this feature",
    "currentPlan": "basic",
    "requiredPlans": ["premium"]
  }
}
```

**3) ì „ì²´ ê¶Œí•œ ì¡°íšŒ**
```json
GET /api/subscription/check

{
  "success": true,
  "user_id": "user_456",
  "permissions": {
    "plan": "basic",
    "subscription_id": "sub_123",
    "status": "active",
    "ai-qa": true,
    "ai-advanced": false,
    "premium-content": true,
    "unlimited-api": false
  }
}
```

**4) êµ¬ë… ì—†ìŒ**
```json
{
  "success": false,
  "hasAccess": false,
  "error": {
    "code": "NO_SUBSCRIPTION",
    "message": "No active subscription found",
    "requiredPlans": ["basic", "premium"]
  }
}
```

---

## ğŸ” ì—ëŸ¬ ì½”ë“œ

| ì½”ë“œ | HTTP | ì„¤ëª… |
|------|------|------|
| `AUTH_001` | 401 | No token provided |
| `AUTH_002` | 401 | Invalid or expired token |
| `AUTH_003` | 401 | Token expired |
| `INVALID_FEATURE` | 400 | Unknown feature name |
| `NO_SUBSCRIPTION` | 403 | No active subscription |
| `INSUFFICIENT_PLAN` | 403 | Plan does not have access |
| `DB_ERROR` | 500 | Database error |
| `INTERNAL_ERROR` | 500 | Unexpected error |
| `METHOD_NOT_ALLOWED` | 405 | Wrong HTTP method |

---

## ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ UI ì˜ˆì‹œ

**ê¶Œí•œ ì—†ìŒ ì‹œ ì—…ê·¸ë ˆì´ë“œ ëª¨ë‹¬ í‘œì‹œ**

```javascript
function showUpgradeModal(requiredPlans) {
  const modal = `
    <div class="upgrade-modal">
      <h3>ì—…ê·¸ë ˆì´ë“œ í•„ìš”</h3>
      <p>ì´ ê¸°ëŠ¥ì€ ë‹¤ìŒ í”Œëœì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤:</p>
      <ul>
        ${requiredPlans.map(plan => `<li>${plan.toUpperCase()}</li>`).join('')}
      </ul>
      <button onclick="goToUpgradePage()">í”Œëœ ì—…ê·¸ë ˆì´ë“œ</button>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modal);
}
```

**ê¸°ëŠ¥ë³„ UI í™œì„±í™”/ë¹„í™œì„±í™”**

```javascript
async function initializeFeatures() {
  const permissions = await getUserPermissions();

  // AI Q&A ë²„íŠ¼
  if (permissions['ai-qa']) {
    document.getElementById('ai-qa-btn').disabled = false;
  } else {
    document.getElementById('ai-qa-btn').disabled = true;
    document.getElementById('ai-qa-btn').title = 'Basic í”Œëœ ì´ìƒ í•„ìš”';
  }

  // AI ê³ ê¸‰ ê¸°ëŠ¥
  if (permissions['ai-advanced']) {
    document.getElementById('ai-advanced-btn').disabled = false;
  } else {
    document.getElementById('ai-advanced-btn').disabled = true;
    document.getElementById('ai-advanced-btn').title = 'Premium í”Œëœ í•„ìš”';
  }
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. Basic í”Œëœ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸

```bash
# êµ¬ë… ìƒì„± (Basic í”Œëœ: plan_id = 1)
curl -X POST http://localhost:3000/api/subscription/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"plan_id": 1}'

# AI Q&A ê¶Œí•œ ì²´í¬ (í†µê³¼)
curl http://localhost:3000/api/subscription/check?feature=ai-qa \
  -H "Authorization: Bearer YOUR_TOKEN"
# Expected: hasAccess: true

# AI ê³ ê¸‰ ê¸°ëŠ¥ ê¶Œí•œ ì²´í¬ (ì‹¤íŒ¨)
curl http://localhost:3000/api/subscription/check?feature=ai-advanced \
  -H "Authorization: Bearer YOUR_TOKEN"
# Expected: hasAccess: false, requiredPlans: ["premium"]
```

### 2. Premium í”Œëœ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸

```bash
# êµ¬ë… ìƒì„± (Premium í”Œëœ: plan_id = 2)
curl -X POST http://localhost:3000/api/subscription/create \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"plan_id": 2}'

# ëª¨ë“  ê¸°ëŠ¥ ê¶Œí•œ ì²´í¬ (ì „ë¶€ í†µê³¼)
curl http://localhost:3000/api/subscription/check \
  -H "Authorization: Bearer YOUR_TOKEN"
# Expected: ëª¨ë“  ê¶Œí•œ true
```

### 3. êµ¬ë… ì—†ëŠ” ì‚¬ìš©ì í…ŒìŠ¤íŠ¸

```bash
# ê¶Œí•œ ì²´í¬ (ì‹¤íŒ¨)
curl http://localhost:3000/api/subscription/check?feature=ai-qa \
  -H "Authorization: Bearer YOUR_TOKEN"
# Expected: NO_SUBSCRIPTION error
```

---

## ğŸ”— ì—°ê´€ Task

- **S2S1**: ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ (Bearer Token ê²€ì¦)
- **S2BA3**: êµ¬ë… ê´€ë¦¬ API (êµ¬ë… ìƒì„±/ì¡°íšŒ/í•´ì§€)
- **S3BA1**: AI Q&A API (ê¶Œí•œ ì²´í¬ ì ìš© ëŒ€ìƒ)
- **S3BA2**: AI ê³ ê¸‰ ê¸°ëŠ¥ API (Premium ì „ìš©)

---

## ğŸ“ Next Steps

1. **AI APIì— ê¶Œí•œ ì²´í¬ ì ìš©**
   - S3BA1, S3BA2 ë“± AI ê¸°ëŠ¥ APIì— `withSubscription` ë˜í¼ ì ìš©

2. **í”„ë¡ íŠ¸ì—”ë“œ ê¶Œí•œ ì²´í¬ í†µí•©**
   - í˜ì´ì§€ ë¡œë“œ ì‹œ `/api/subscription/check` í˜¸ì¶œ
   - UI í™œì„±í™”/ë¹„í™œì„±í™” ìë™í™”

3. **Rate Limiting ì¶”ê°€**
   - ë¬´ë£Œ ì‚¬ìš©ì 5íšŒ/ì¼ ì œí•œ
   - Redis ë˜ëŠ” DBì— ì‚¬ìš© íšŸìˆ˜ ê¸°ë¡

4. **ì—…ê·¸ë ˆì´ë“œ í”Œë¡œìš° ì—°ê²°**
   - ê¶Œí•œ ì—†ìŒ ì‹œ ì—…ê·¸ë ˆì´ë“œ í˜ì´ì§€ë¡œ ì´ë™
   - ê²°ì œ ì™„ë£Œ í›„ ì¦‰ì‹œ ê¶Œí•œ í™œì„±í™”

---

**ì‘ì„±ì**: Claude Code
**ë¬¸ì„œ ë²„ì „**: 1.0
