<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ë‚´ì—­ - SSAL Works</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        :root {
            --primary: #2C4A8A;
            --primary-dark: #1F3563;
            --secondary: #F59E0B;
            --accent: #10B981;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 0 32px;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .rice-logo {
            display: flex;
            align-items: center;
            gap: 3px;
            transform: rotate(-15deg);
        }

        .rice-grain {
            width: 10px;
            height: 18px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            border-radius: 40%;
        }

        .nav-logo-text { font-size: 28px; font-weight: 800; color: white; }

        .close-btn {
            padding: 6px 14px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 32px 24px; }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--gray-500);
        }

        .breadcrumb a { color: var(--primary); text-decoration: none; }

        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 32px; }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        /* êµ¬ë… ìƒíƒœ ì¹´ë“œ */
        .subscription-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-badge.paused {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-details { font-size: 14px; color: var(--gray-700); }
        .status-details strong { color: var(--primary); }

        .status-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            background: var(--gray-50);
        }

        /* ê²°ì œ ìˆ˜ë‹¨ ì •ë³´ */
        .payment-method-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-top: 16px;
        }

        .payment-icon { font-size: 24px; }
        .payment-details { flex: 1; }
        .payment-details strong { display: block; margin-bottom: 2px; }
        .payment-details span { font-size: 13px; color: var(--gray-500); }

        /* í•„í„° ë°” */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
            min-width: 120px;
        }

        /* ê²°ì œ ë‚´ì—­ í…Œì´ë¸” */
        .billing-table {
            width: 100%;
            border-collapse: collapse;
        }

        .billing-table th {
            text-align: left;
            padding: 12px;
            background: var(--gray-50);
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .billing-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
        }

        .billing-table tr:hover td {
            background: var(--gray-50);
        }

        .amount { font-weight: 600; }
        .amount.positive { color: var(--success); }
        .amount.negative { color: var(--danger); }

        .billing-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .billing-status.paid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .billing-status.failed {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .billing-status.refunded {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .billing-status.pending {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-500);
        }

        .btn-receipt {
            padding: 4px 8px;
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 12px;
            color: var(--gray-700);
            cursor: pointer;
        }

        .btn-receipt:hover {
            background: var(--gray-50);
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--gray-500);
        }

        .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-danger {
            background: white;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @media (max-width: 768px) {
            .subscription-status {
                flex-direction: column;
                align-items: flex-start;
            }

            .billing-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="../../index.html" class="nav-logo">
            <div class="rice-logo">
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
                <span class="rice-grain"></span>
            </div>
            <span class="nav-logo-text">SSAL Works</span>
        </a>
        <button class="close-btn" onclick="history.back()">âœ• ë‹«ê¸°</button>
    </nav>

    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="breadcrumb">
            <a href="../../index.html">í™ˆ</a>
            <span>â€º</span>
            <span>ê²°ì œ ë‚´ì—­</span>
        </div>

        <h1 class="page-title">ğŸ’³ ê²°ì œ ë‚´ì—­</h1>

        <!-- êµ¬ë… ìƒíƒœ -->
        <div class="card">
            <div class="subscription-status">
                <div class="status-info">
                    <span class="status-badge active" id="statusBadge">í™œì„±</span>
                    <div class="status-details">
                        ë‹¤ìŒ ê²°ì œì¼: <strong id="nextBillingDate">-</strong> |
                        ì›” ì´ìš©ë£Œ: <strong>â‚©50,000</strong>
                    </div>
                </div>
                <div class="status-actions">
                    <button class="btn-sm btn-outline" onclick="location.href='payment-method.html'">ê²°ì œ ìˆ˜ë‹¨ ë³€ê²½</button>
                </div>
            </div>

            <!-- ë“±ë¡ëœ ê²°ì œ ìˆ˜ë‹¨ -->
            <div class="payment-method-info" id="paymentMethodInfo" style="display: none;">
                <span class="payment-icon" id="paymentIcon">ğŸ’³</span>
                <div class="payment-details">
                    <strong id="paymentMethodName">-</strong>
                    <span id="paymentMethodType">-</span>
                </div>
            </div>
        </div>

        <!-- ê²°ì œ ë‚´ì—­ -->
        <div class="card">
            <div class="filter-bar">
                <select class="filter-select" id="typeFilter" onchange="filterHistory()">
                    <option value="">ì „ì²´ ìœ í˜•</option>
                    <option value="platform_fee">í”Œë«í¼ ì´ìš©ë£Œ</option>
                    <option value="credit_purchase">í¬ë ˆë”§ ì¶©ì „</option>
                    <option value="installation_fee">ë¹Œë” ê³„ì • ê°œì„¤ë¹„</option>
                </select>
                <select class="filter-select" id="statusFilter" onchange="filterHistory()">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="paid">ê²°ì œ ì™„ë£Œ</option>
                    <option value="failed">ê²°ì œ ì‹¤íŒ¨</option>
                    <option value="refunded">í™˜ë¶ˆ</option>
                </select>
            </div>

            <table class="billing-table">
                <thead>
                    <tr>
                        <th>ê²°ì œì¼</th>
                        <th>êµ¬ë¶„</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ê²°ì œ ìˆ˜ë‹¨</th>
                        <th>ìƒíƒœ</th>
                        <th>ì˜ìˆ˜ì¦</th>
                    </tr>
                </thead>
                <tbody id="billingTableBody">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="card">
            <div class="action-buttons" id="actionButtons">
                <a href="payment-method.html" class="btn btn-primary">ğŸ’³ ê²°ì œ ìˆ˜ë‹¨ ê´€ë¦¬</a>
                <button class="btn btn-secondary" id="pauseBtn" onclick="pauseSubscription()">â¸ï¸ êµ¬ë… ì¼ì‹œì •ì§€</button>
                <button class="btn btn-success" id="resumeBtn" onclick="resumeSubscription()" style="display:none; background:var(--success); color:white;">â–¶ï¸ êµ¬ë… ì¬ê°œ</button>
                <button class="btn btn-danger" id="cancelBtn" onclick="cancelSubscription()">âŒ êµ¬ë… í•´ì§€</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script>
        const SUPABASE_URL = 'https://zwjmfewyshhwpgwdtrus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3am1mZXd5c2hod3Bnd2R0cnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzE1NTEsImV4cCI6MjA3OTE0NzU1MX0.AJy34h5VR8QS6WFEcUcBeJJu8I3bBQ6UCk1I84Wb7y4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let userData = null;
        let billingHistory = [];
        let paymentMethod = null;

        document.addEventListener('DOMContentLoaded', checkAuth);

        async function checkAuth() {
            showLoading();
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error || !session) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    setTimeout(() => {
                        window.location.href = '../auth/login.html';
                    }, 1500);
                    return;
                }
                currentUser = session.user;
                await loadUserData();
                await Promise.all([
                    loadPaymentMethod(),
                    loadBillingHistory()
                ]);
                updateSubscriptionStatus();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            } finally {
                hideLoading();
            }
        }

        async function loadUserData() {
            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (!error) userData = data;
        }

        async function loadPaymentMethod() {
            if (!userData) return;

            const { data, error } = await supabaseClient
                .from('payment_methods')
                .select('*')
                .eq('user_id', userData.user_id)
                .eq('is_default', true)
                .single();

            if (!error && data) {
                paymentMethod = data;
                displayPaymentMethod();
            }
        }

        function displayPaymentMethod() {
            if (!paymentMethod) return;

            document.getElementById('paymentMethodInfo').style.display = 'flex';

            if (paymentMethod.payment_type === 'card') {
                document.getElementById('paymentIcon').textContent = 'ğŸ’³';
                document.getElementById('paymentMethodName').textContent =
                    `${paymentMethod.card_company} ****-${paymentMethod.card_last4}`;
                document.getElementById('paymentMethodType').textContent = 'ì‹ ìš©/ì²´í¬ì¹´ë“œ';
            } else {
                document.getElementById('paymentIcon').textContent = 'ğŸ¦';
                document.getElementById('paymentMethodName').textContent =
                    `${paymentMethod.bank_name} ****-${paymentMethod.account_last4}`;
                document.getElementById('paymentMethodType').textContent = 'ê³„ì¢Œì´ì²´';
            }
        }

        async function loadBillingHistory() {
            if (!userData) return;

            const { data, error } = await supabaseClient
                .from('billing_history')
                .select('*')
                .eq('user_id', userData.user_id)
                .order('billing_date', { ascending: false });

            if (!error) {
                billingHistory = data || [];
                renderBillingHistory(billingHistory);
            }
        }

        function renderBillingHistory(history) {
            const tbody = document.getElementById('billingTableBody');

            if (!history || history.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const typeLabels = {
                'platform_fee': 'í”Œë«í¼ ì´ìš©ë£Œ',
                'credit_purchase': 'í¬ë ˆë”§ ì¶©ì „',
                'installation_fee': 'ë¹Œë” ê³„ì • ê°œì„¤ë¹„'
            };

            const statusLabels = {
                'paid': 'ê²°ì œ ì™„ë£Œ',
                'failed': 'ê²°ì œ ì‹¤íŒ¨',
                'refunded': 'í™˜ë¶ˆ',
                'pending': 'ëŒ€ê¸° ì¤‘'
            };

            tbody.innerHTML = history.map(item => `
                <tr>
                    <td>${formatDate(item.billing_date)}</td>
                    <td>${typeLabels[item.billing_type] || item.billing_type}</td>
                    <td class="amount ${item.status === 'refunded' ? 'negative' : ''}">
                        ${item.status === 'refunded' ? '-' : ''}â‚©${item.amount.toLocaleString()}
                    </td>
                    <td>${item.payment_method || '-'}</td>
                    <td>
                        <span class="billing-status ${item.status}">
                            ${statusLabels[item.status]}
                        </span>
                        ${item.failure_reason ? `<br><small style="color:var(--danger)">${item.failure_reason}</small>` : ''}
                    </td>
                    <td>
                        ${item.receipt_url ?
                            `<button class="btn-receipt" onclick="window.open('${item.receipt_url}')">ì˜ìˆ˜ì¦</button>`
                            : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function filterHistory() {
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = billingHistory;

            if (typeFilter) {
                filtered = filtered.filter(h => h.billing_type === typeFilter);
            }

            if (statusFilter) {
                filtered = filtered.filter(h => h.status === statusFilter);
            }

            renderBillingHistory(filtered);
        }

        function updateSubscriptionStatus() {
            // ë‹¤ìŒ ê²°ì œì¼ ê³„ì‚°
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            document.getElementById('nextBillingDate').textContent = formatDate(nextMonth);

            // êµ¬ë… ìƒíƒœ (users í…Œì´ë¸”ì˜ subscription_status ê¸°ë°˜)
            if (userData && userData.subscription_status) {
                const badge = document.getElementById('statusBadge');
                const status = userData.subscription_status;

                badge.className = `status-badge ${status}`;
                badge.textContent = {
                    'active': 'í™œì„±',
                    'paused': 'ì¼ì‹œì •ì§€',
                    'cancelled': 'í•´ì§€ë¨'
                }[status] || 'í™œì„±';

                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const cancelBtn = document.getElementById('cancelBtn');

                if (status === 'active') {
                    pauseBtn.style.display = 'inline-flex';
                    resumeBtn.style.display = 'none';
                    cancelBtn.style.display = 'inline-flex';
                } else if (status === 'paused') {
                    pauseBtn.style.display = 'none';
                    resumeBtn.style.display = 'inline-flex';
                    cancelBtn.style.display = 'inline-flex';
                } else if (status === 'cancelled') {
                    pauseBtn.style.display = 'none';
                    resumeBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }
            }
        }

        async function pauseSubscription() {
            // ì´ë¯¸ ì¼ì‹œì •ì§€ ìƒíƒœì¸ì§€ í™•ì¸
            if (userData && userData.subscription_status === 'paused') {
                showToast('ì´ë¯¸ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤.', 'error');
                return;
            }

            // í•´ì§€ëœ ìƒíƒœì—ì„œëŠ” ì¼ì‹œì •ì§€ ë¶ˆê°€
            if (userData && userData.subscription_status === 'cancelled') {
                showToast('í•´ì§€ëœ êµ¬ë…ì€ ì¼ì‹œì •ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const confirmed = confirm(
                'êµ¬ë…ì„ ì¼ì‹œì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
                'ğŸ“Œ ì¼ì‹œì •ì§€ ì •ì±…:\n' +
                'â€¢ ìµœëŒ€ 3ê°œì›”ê¹Œì§€ ì¼ì‹œì •ì§€ ê°€ëŠ¥\n' +
                'â€¢ ì¼ì‹œì •ì§€ ê¸°ê°„ ë™ì•ˆ ì„œë¹„ìŠ¤ ì´ìš© ë° ê²°ì œê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤\n' +
                'â€¢ 3ê°œì›” í›„ ìë™ìœ¼ë¡œ ì¬ê°œë˜ê±°ë‚˜ í•´ì§€ë©ë‹ˆë‹¤\n' +
                'â€¢ ì–¸ì œë“  ìˆ˜ë™ìœ¼ë¡œ ì¬ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤'
            );

            if (!confirmed) return;

            showLoading();
            try {
                const pauseEndDate = new Date();
                pauseEndDate.setMonth(pauseEndDate.getMonth() + 3); // ìµœëŒ€ 3ê°œì›”

                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        subscription_status: 'paused',
                        subscription_paused_at: new Date().toISOString(),
                        subscription_pause_end_date: pauseEndDate.toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userData.user_id);

                if (error) throw error;

                // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                userData.subscription_status = 'paused';
                updateSubscriptionStatus();

                showToast('êµ¬ë…ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ìµœëŒ€ 3ê°œì›”ê°„ ìœ ì§€ë©ë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì¼ì‹œì •ì§€ ì‹¤íŒ¨:', error);
                showToast('ì¼ì‹œì •ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function resumeSubscription() {
            if (userData && userData.subscription_status !== 'paused') {
                showToast('ì¼ì‹œì •ì§€ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.', 'error');
                return;
            }

            const confirmed = confirm('êµ¬ë…ì„ ì¬ê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ìŒ ê²°ì œì¼ë¶€í„° ì •ìƒì ìœ¼ë¡œ ê²°ì œë©ë‹ˆë‹¤.');

            if (!confirmed) return;

            showLoading();
            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        subscription_status: 'active',
                        subscription_paused_at: null,
                        subscription_pause_end_date: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userData.user_id);

                if (error) throw error;

                userData.subscription_status = 'active';
                updateSubscriptionStatus();

                showToast('êµ¬ë…ì´ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì¬ê°œ ì‹¤íŒ¨:', error);
                showToast('êµ¬ë… ì¬ê°œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function cancelSubscription() {
            // ì´ë¯¸ í•´ì§€ëœ ìƒíƒœì¸ì§€ í™•ì¸
            if (userData && userData.subscription_status === 'cancelled') {
                showToast('ì´ë¯¸ í•´ì§€ëœ êµ¬ë…ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            const confirmed = confirm(
                'ì •ë§ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
                'âš ï¸ í•´ì§€ ì •ì±…:\n' +
                'â€¢ ë‹¹ì›” ì´ìš©ë£ŒëŠ” í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì´ë¯¸ ì„œë¹„ìŠ¤ ì œê³µë¨)\n' +
                'â€¢ í•´ì§€ ì¦‰ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤\n' +
                'â€¢ ë°ì´í„°ëŠ” 90ì¼ê°„ ë³´ê´€ í›„ ì‚­ì œë©ë‹ˆë‹¤\n' +
                'â€¢ 90ì¼ ë‚´ ì¬ê°€ì… ì‹œ ë°ì´í„° ë³µêµ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤\n\n' +
                'ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
            );

            if (!confirmed) return;

            // 2ì°¨ í™•ì¸
            const doubleConfirmed = confirm(
                'âš ï¸ ìµœì¢… í™•ì¸ âš ï¸\n\n' +
                'êµ¬ë… í•´ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.\n' +
                'ì´ ì‘ì—…ì€ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.\n\n' +
                'ì •ë§ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
            );

            if (!doubleConfirmed) return;

            showLoading();
            try {
                const cancelledAt = new Date();
                const dataDeleteDate = new Date();
                dataDeleteDate.setDate(dataDeleteDate.getDate() + 90); // 90ì¼ í›„ ì‚­ì œ

                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        subscription_status: 'cancelled',
                        subscription_cancelled_at: cancelledAt.toISOString(),
                        data_deletion_scheduled_at: dataDeleteDate.toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userData.user_id);

                if (error) throw error;

                userData.subscription_status = 'cancelled';
                updateSubscriptionStatus();

                showToast('êµ¬ë…ì´ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ëŠ” 90ì¼ê°„ ë³´ê´€ë©ë‹ˆë‹¤.', 'success');

                // 3ì´ˆ í›„ í™ˆìœ¼ë¡œ ì´ë™
                setTimeout(() => {
                    window.location.href = '../../index.html';
                }, 3000);
            } catch (error) {
                console.error('í•´ì§€ ì‹¤íŒ¨:', error);
                showToast('í•´ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
